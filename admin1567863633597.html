<html>

<head>
    <meta charset="utf-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <link rel="stylesheet" type="text/css" href="/res/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/res/css/daterangepicker.css" />
    <link rel="stylesheet" type="text/css" href="/res/script/lib/jQueryUI/jquery-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="/res/script/lib/jQueryUI/jquery-ui.theme.min.css" />
    <link rel="stylesheet" type="text/css" href="/res/script/lib/jQueryUI/jquery-ui-timepicker-addon.css" />
    <link rel="stylesheet" type="text/css" href="/res/css/fontawesome-all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/res/sass/main.css?v=2.246">

    <script src="/res/script/lib/jquery-3.2.1.min.js"></script>
    <script src="/res/script/lib/jQueryUI/jquery-ui.min.js"></script>
    <script src="/res/script/lib/jQueryUI/jquery-ui-timepicker-addon.js"></script>
    <script src="/res/script/lib/popper.min.js"></script>
    <script src="/res/script/lib/bootstrap.min.js"></script>
    <script src="/res/script/lib/jquery.autocomplete.js"></script>
    <script src="/res/script/lib/AES-3.1.2.js"></script>
    <script src="/res/script/lib/jsencrypt-2.3.1.min.js"></script>
    <script src="/res/script/plugins.js?v=2.246"></script>
    <script src="/res/script/lib/chart.min.js?v=2.246"></script>
    <script src="/res/script/utils.js?v=2.246"></script>

    <style>
        @font-face {
            font-family: 'Material Icons';
            font-style: normal;
            font-weight: 400;
            src: url(/res/mdl/MaterialIcons-Regular.eot);
             
            src: local('Material Icons'),
                local('MaterialIcons-Regular'),
                url(/res/mdl/MaterialIcons-Regular.woff2) format('woff2'),
                url(/res/mdl/MaterialIcons-Regular.woff) format('woff'),
                url(/res/mdl/MaterialIcons-Regular.ttf) format('truetype');
        }

        td>* {
            vertical-align: middle;
        }

        tr td:last-child {
            width: 1%;
            white-space: nowrap;
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            font-feature-settings: 'liga';
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }

        .clickable {
            cursor: pointer
        }

         
        .autocomplete-suggestions {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            border: 1px solid #999;
            background: #FFF;
            cursor: default;
            overflow: auto;
            -webkit-box-shadow: 1px 4px 3px rgba(50, 50, 50, 0.64);
            -moz-box-shadow: 1px 4px 3px rgba(50, 50, 50, 0.64);
            box-shadow: 1px 4px 3px rgba(50, 50, 50, 0.64);
        }

        .autocomplete-suggestion {
            padding: 2px 5px;
            white-space: nowrap;
            overflow: hidden;
        }

        .autocomplete-no-suggestion {
            padding: 2px 5px;
        }

        .autocomplete-selected {
            background: #F0F0F0;
        }

        .autocomplete-suggestions strong {
            font-weight: bold;
            color: #000;
        }

        .autocomplete-group {
            padding: 2px 5px;
            font-weight: bold;
            font-size: 16px;
            color: #000;
            display: block;
            border-bottom: 1px solid #000;
        }
    </style>

    <script>
        var version = "2.246";
        var role = '4';
        
    </script>
    
<style>
    th {
        text-align: left;
    }

    .tbody-content_editable input[type="text"]:-moz-read-only {
        border: none;
        background: none;
    }

    .tbody-content_editable input[type="text"]:read-only {
        border: none;
        background: none;
    }


    .icon {
        width: 20px;
        margin-right: 5px;
    }

    .menu_item>.material-icons {
        vertical-align: bottom;
        margin-right: 4px;
    }

    .tbody-content_editable input[type=text] {
        width: 100%;
    }

    .dropdown {
        float: right;
        width: unset;
        display: unset;
        height: calc(2.25rem - 1px) !important;
        margin-right: 7px;
    }

    optgroup[label] {
        color: #000;
        font-weight: bold;
    }

    .maintenance {
        background: #ffff00;
    }

    .maintenance .btn-maintenance {
        color: #ff0000;
    }
</style>

<style>
    .txt-account-server {
        width: 100%
    }

    .txt-account-email {
        width: 100%
    }

    .form_change_account_password {
        position: absolute;
        background: #fff;
        border: 1px solid #3e3e3e;
        margin: 16px 0 0 -100px;
        width: 200px;
    }

    .header_change_account_password {
        background: #3e3e3e;
        color: #fff;
        padding: 5px;
    }

    .title_change_account_password {
        float: left;
    }

    .close_change_account_password {
        cursor: pointer;
        float: right;
    }

    .form_change_account_password input {
        width: 100%;
    }

    .txt_change_account_password {
        color: #000;
    }

    .btn_change_account_password {
        margin-top: 5px;
    }

    .warning_change_account_password {
        width: 100%;
        text-align: center;
    }

    .clearfix::after {
        content: " ";
        display: block;
        height: 0;
        clear: both;
    }

    .noselect {
        -webkit-touch-callout: none;
         
        -webkit-user-select: none;
         
        -khtml-user-select: none;
         
        -moz-user-select: none;
         
        -ms-user-select: none;
         
        user-select: none;
         
    }

    .form_change_account_password input[type="text"],
    .form_change_account_password input[type="password"] {
        background: none;
        padding: .375rem .75rem;
        margin-bottom: 5px;
        border: 1px solid #ced4da;
    }

    .form_change_account_password .title {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .tbody-content_editable input[type="text"].read-only {
        border: 1px solid #ced4da !important;
        color: unset !important;
        color: grey !important;
    }

    .txt-account-server {
        width: 100%
    }

    .txt-account-email {
        width: 100%
    }

    #tbody-account tr td:first-child {
        width: 1%;
        white-space: nowrap;
    }
</style>


<style>
    .dboard-status {
        margin-top: -6px;
        cursor: pointer;
    }
</style>


<style>
    .txt-dest-url {
        width: 250px;
    }
</style>


</head>

<body>
    
<nav class="navbar sticky-top navbar-expand-md navbar-light">
    <a class="navbar-brand" href="javascript:void(0)">
        <img src="/res/custom/logo-admin-small.png" class="d-inline-block align-top" alt="" href="index.php">
    </a>

    <button type="button" id="sidebarCollapse" class="btn btn-light navbar-btn">
        <i class="fa fa-bars"></i>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto"></ul>
        <form class="form-inline my-2 my-lg-0">
            <div style="color:#fff;margin-right:5px;font-weight:bold">gadev</div>
            <div id="user_role" style="color:#fff;margin-right:20px">gadev</div>
            <a id="btn-setting" href="javascript:void(0)" style="margin-right:20px" data-name="change-password">
                <i class="material-icons">settings</i>
            </a>
            <a id="btn-logout" href="javascript:void(0)">
                <i class="material-icons">exit_to_app</i>
            </a>
        </form>
    </div>
</nav>

<div class="wrapper">
    
    <nav id="sidebar" style="overflow-y:auto">
        <ul class="list-unstyled components">
            <li>
                <a href="#siteSubmenu" data-toggle="collapse" aria-expanded="true" class="dropdown-toggle">Sites</a>
                <ul class="collapse list-unstyled show" id="siteSubmenu">
                    <li>
                        <a class="menu_item" id="btn-menu_account-group" href="javascript:void(0)"
                            data-name="account-group">
                            <i class="material-icons">folder</i>&nbsp;Groups</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_backend" data-name="backend" href="javascript:void(0)">
                            <i class="material-icons">storage</i>&nbsp;Backends</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_loadbalancer" data-name="loadbalancer"
                            href="javascript:void(0)">
                            <i class="material-icons">device_hub</i>&nbsp;Backend Pools</a>
                    </li>
                    <li>
                        <a class="menu_item active" id="btn-menu_account" data-name="account" href="javascript:void(0)">
                            <i class="material-icons">web</i>&nbsp;Sites</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_domain" data-name="domain" href="javascript:void(0)">
                            <i class="material-icons">public</i>&nbsp;Hostnames</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_redirect" data-name="redirect" href="javascript:void(0)">
                            <i class="material-icons">swap_calls</i>&nbsp;Web Redirect</a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="#proxySubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Proxy</a>
                <ul class="collapse list-unstyled" id="proxySubmenu">
                    <li>
                        <a class="menu_item" id="btn-menu_proxy" href="javascript:void(0)" data-name="proxy">
                            <i class="material-icons">dns</i>&nbsp;Proxy Nodes</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_proxy-entrypoint" href="javascript:void(0)"
                            data-name="proxy-entrypoint">
                            <i class="material-icons">create</i>&nbsp;Proxy CNAME</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_proxy-memory" href="javascript:void(0)"
                            data-name="proxy-memory">
                            <i class="material-icons">memory</i>&nbsp;Node Memory</a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="#policySubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Policy</a>
                <ul class="collapse list-unstyled" id="policySubmenu">
                    <li>
                        <a class="menu_item" id="btn-menu_ratelimit" href="javascript:void(0)" data-name="ratelimit">
                            <i class="material-icons">poll</i>&nbsp;Rate Limit</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_cache" href="javascript:void(0)" data-name="cache">
                            <i class="material-icons">cached</i>&nbsp;Caching</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_custom-header" href="javascript:void(0)"
                            data-name="custom-header">
                            <i class="material-icons">list</i>&nbsp;HTTP Header</a>
                    </li>
                </ul>
            </li>
            <li id="menu_report">
                <a href="#reportSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Report</a>
                <ul class="collapse list-unstyled" id="reportSubmenu">
                    <li>
                        <a class="menu_item" id="btn-menu_report-requests" href="javascript:void(0)"
                            data-name="report-requests">
                            <i class="material-icons">call_received</i>&nbsp;Total Requests</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_report-memory" href="javascript:void(0)"
                            data-name="report-memory">
                            <i class="material-icons">memory</i>&nbsp;System Memory</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_report-app-memory" href="javascript:void(0)"
                            data-name="report-app-memory">
                            <i class="material-icons">memory</i>&nbsp;Process Memory</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_report-bandwidth" href="javascript:void(0)"
                            data-name="report-bandwidth">
                            <i class="material-icons">swap_horiz</i>&nbsp;Network Bandwidth</a>
                    </li>
                </ul>
            </li>
            <li id="menu-admin">
                <a href="#adminSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Admin</a>
                <ul class="collapse list-unstyled" id="adminSubmenu">
                    <li>
                        <a class="menu_item" id="btn-menu_admin-account" href="javascript:void(0)"
                            data-name="admin-account">
                            <i class="material-icons">person</i>&nbsp;Users</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_cp-entrypoint" href="javascript:void(0)"
                            data-name="cp-entrypoint">
                            <i class="material-icons">http</i>&nbsp;Hostnames</a>
                    </li>
                    <li>
                        <a class="menu_item" id="btn-menu_admin-setting" href="javascript:void(0)"
                            data-name="admin-setting">
                            <i class="material-icons">settings_applications</i>&nbsp;Settings</a>
                    </li>
                </ul>
            </li>
        </ul>
        <div class="footer">
            <a id="" href="javascript:void(0)">
                <i class="fas fa-sign-out-alt"></i> Log out</a>
        </div>
    </nav>

    
    <div id="content">
        
<div id="container-account" class="container-fluid" data-name="account">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Sites</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_account" class="btn btn-primary btn-mod-action">Add Site</button>
            <button id="btn-search_account" class="btn btn-primary" style="float:right;margin-left:7px">Search</button>
            <input id="txt_search_account" type="text" class="form-control" placeholder="name"
                style="float:right;width:250px;">
            <input id="txt_search_account_tags" type="text" class="form-control" placeholder="tags"
                style="float:right;width:250px;margin-right:7px">
            <select id="sel-account_backend" class="form-control dropdown">
                <option value="0">any Backend</option>
            </select>
            <select id="sel-account_cname" class="form-control dropdown">
                <option value="0">any CNAME</option>
            </select>
            <select id="sel-account_group" class="form-control dropdown">
                <option value="0">any group</option>
                <option value="">-</option>
            </select>
        </div>
        <div class="col-lg-12">
            <div>
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col"></th>
                            <th scope="col">Name</th>
                            <th scope="col">Tags</th>
                            <th scope="col">Host</th>
                            <th scope="col">Backend</th>
                            <th scope="col">Group</th>
                            <th scope="col">CNAME</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-account" class="tbody-content_editable">
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="9" id="tfoot-account" style="text-align:center"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

        
<style>
    #tbody-domain tr td:first-child {
        width: 1%;
        white-space: nowrap;
    }

    .hostname_site_name:hover {
        cursor: pointer;
        -moz-box-shadow: inset 0 0 10px #d1d1d1;
        -webkit-box-shadow: inset 0 0 10px #d1d1d1;
        box-shadow: inset 0 0 10px #d1d1d1;
    }
</style>
<div id="container-domain" class="container-fluid" style="display:none" data-name="domain">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Hostnames</h2>
        </div>
        <div class="col-lg-12 text-right pb-3">
            <select id="sel-domain_group" class="form-control"
                style="width:unset;display:unset;height: calc(2.25rem - 1px) !important;">
                <option value="0">any group</option>
                <option value="">-</option>
            </select>
            <select id="sel-domain_dns_verification" class="form-control"
                style="width:unset;display:unset;height: calc(2.25rem - 1px) !important;">
                <option value="-2">any DNS status</option>
                <option value="1">verify DNS OK</option>
                <option value="2">verify DNS failed</option>
                <option value="0">verify DNS pending</option>
                <option value="3">verify DNS disabled</option>
            </select>
            <button id="btn-search_domain" class="btn btn-primary"
                style="float:right;margin-left:7px;display:unset;">Search</button>
            <input id="txt_search_domain" type="text" class="form-control" placeholder="hostname"
                style="float:right;width:250px;margin-left:7px">
        </div>
        <div class="col-lg-12">
            <div class="table-responsive">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col" class="col_status"></th>
                            <th scope="col">Hostname</th>
                            <th scope="col">Verify DNS</th>
                            <th scope="col">Site</th>
                            <th scope="col">Host</th>
                            <th scope="col">Backend</th>
                            <th scope="col">Group</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-domain">
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="7" id="tfoot-domain" style="text-align:center"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

        
<style>
    .txt-dest-url {
        width: 250px;
    }
</style>

<div id="container-redirect" class="container-fluid" style="display:none" data-name="redirect">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Web Redirect</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_redirect" class="btn btn-primary btn-mod-action">Add Redirect</button>
            <button id="btn-search_redirect" class="btn btn-primary" style="float:right;margin-left:7px">Search</button>
            <input id="txt_search_redirect" type="text" class="form-control" placeholder="Domain"
                style="float:right;width:250px;">
        </div>
        <div class="col-lg-12">
            <div class="table-responsive">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Domain</th>
                            <th scope="col">Mode</th>
                            <th scope="col">Destination URL</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-redirect" class="tbody-content_editable">
                    </tbody>
                </table>
                
            </div>
        </div>
    </div>
</div>

        
<div id="container-proxy" class="container-fluid" style="display:none" data-name="proxy">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Proxy Nodes</h2>
        </div>
        <div class="col-lg-12">
            <div class="table-proxy">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Status</th>
                            <th scope="col">Name</th>
                            <th scope="col">IP</th>
                            <th scope="col">Up Since</th>
                            <th scope="col">Total CNAME</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-proxy" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        
<div id="container-proxy-entrypoint" class="container-fluid" style="display:none" data-name="proxy-entrypoint">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Proxy CNAME</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_proxy_entrypoint" class="btn btn-primary btn-mod-action">Add CNAME</button>
            
        </div>
        <div class="col-lg-12">
            <div class="table-responsive">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Hostname</th>
                            <th scope="col">Proxy Node</th>
                            <th scope="col">Proxy IP</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-proxy_entrypoint" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        
<div id="container-ratelimit" class="container-fluid" style="display:none" data-name="ratelimit">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Rate Limit</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_ratelimit" class="btn btn-primary btn-mod-action">Add Rule</button>
        </div>
        <div class="col-lg-12">
            <div class="table-responsive">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Requests Per Minute</th>
                            <th scope="col">Requests Burst</th>
                            <th scope="col">Expiry Minute</th>
                            <th scope="col">Subnet</th>
                            <th scope="col">Scope</th>
                            <th scope="col">Group/Site</th>
                            <th scope="col">Priority</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-ratelimit" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


        
<div id="container-cache" class="container-fluid" style="display:none" data-name="cache">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Caching</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_cache" class="btn btn-primary btn-mod-action">Add Cache</button>
            <button id="btn-search_cache" class="btn btn-primary" style="float:right;margin-left:7px">Search</button>
            <input id="txt_search_cache" type="text" class="form-control" placeholder="file extension name"
                style="float:right;width:250px;" />
        </div>
        <div class="col-lg-12">
            <div class="table-cache">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">File Extension</th>
                            <th scope="col">Expiry Minute</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-cache" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


        
<div id="container-proxy-memory" class="container-fluid" style="display:none" data-name="proxy-memory">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Node Memory</h2>
        </div>
        <div class="col-lg-12">
            <div class="table-proxy-memory">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Proxy Node</th>
                            <th scope="col">Memory Usage Limit</th>
                            <th scope="col">Max Memory Usage</th>
                            <th scope="col">Used / Total Memory</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-proxy-memory" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        
<div id="container-cp-entrypoint" class="container-fluid" style="display:none" data-name="cp-entrypoint">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Hostnames</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_cp_entrypoint" class="btn btn-primary btn-mod-action">Add Hostname</button>
            
        </div>
        <div class="col-lg-12">
            <div class="table-responsive">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Hostname</th>
                            <th scope="col">Control Panel</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-cp_entrypoint" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        
<div id="container-account-group" class="container-fluid" style="display:none" data-name="account-group">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Groups</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_account-group" class="btn btn-primary btn-mod-action">Add Group</button>
        </div>
        <div class="col-lg-12">
            <div class="table-account-group">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Group</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-account-group" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


        
<style>
    #tbody-backend tr td:first-child {
        width: 1%;
        white-space: nowrap;
    }
</style>
<div id="container-backend" class="container-fluid" style="display:none" data-name="backend">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Backends</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_backend" class="btn btn-primary btn-mod-action">Add Backend</button>
            
        </div>
        <div class="col-lg-12">
            <div class="table-backend">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col"></th>
                            <th scope="col">Name</th>
                            <th scope="col">Address</th>
                            <th scope="col">HTTPS</th>
                            <th scope="col">Requests Last Minute</th>
                            <th scope="col">Success Rate</th>
                            <th scope="col">Last Active</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-backend" class="tbody-content_editable">
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="8" id="tfoot-backend" style="text-align:center"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

        
<style>
    .chk-admin_account-enabled {
        margin-right: 5px;
    }
</style>

<div id="container-admin-account" class="container-fluid" style="display:none" data-name="admin-account">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Users</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_admin-account" class="btn btn-primary">Add User</button>
        </div>
        <div class="col-lg-12">
            <div class="table-responsive">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Username</th>
                            <th scope="col">Password</th>
                            <th scope="col">Role</th>
                            <th scope="col">Enabled</th>
                            <th scope="col" class="head_action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-admin_account" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        
<style>
    .chk-loadbalancer-sticky-session-enable {
        margin-right: 7px;
    }

    .txt-loadbalancer-sticky-session {
        width: 200px !important;
    }

    #tbody-loadbalancer tr td:first-child {
        width: 1%;
        white-space: nowrap;
    }
</style>
<div id="container-loadbalancer" class="container-fluid" style="display:none" data-name="loadbalancer">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Backend Pools</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_loadbalancer" class="btn btn-primary btn-mod-action">Add Backend Pool</button>
            
        </div>
        <div class="col-lg-12">
            <div class="table-loadbalancer">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col"></th>
                            <th scope="col">Name</th>
                            <th scope="col">Sticky Session</th>
                            <th scope="col">Cookie Name</th>
                            <th scope="col">Health Check Path</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-loadbalancer" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        
<style>
    #btn-server_pool_backend-back {
        cursor: pointer;
        display: inline-block
    }

    #btn-server_pool_backend-back:hover {
        text-decoration: underline;
        color: #007bff;
    }

    .health_check-status {
        cursor: pointer;
        text-decoration: underline;
        color: #007bff;
    }

    #health-check-result {
        margin: 20px 80px;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        right: 0;
        left: 0;
        position: absolute;
        background: #343f4f;
        display: none;
    }

    #health-check-result>h2 {
        margin-bottom: 1px;
        background: #000;
    }

    #health-check-status {
        text-align: center;
        background: #343f4f;
        color: #fff;
        padding: 6px;
        font-size: 18px;
    }

    #health-check-close {
        color: #fff;
        position: absolute;
        top: 0;
        right: 0;
        font-size: 24px;
        margin-right: 15px;
        margin-top: 7px;
        cursor: pointer;
    }

    #health-check-result>div>div {
        width: 100%;
        min-height: 40px;
        border: 1px solid #A8A8A8;
        padding: 7px;
        background: #fff;
    }

    #health-check-result>div>p {
        background: #343f4f;
        padding-left: 7px;
        font-size: 18px;
        color: #fff;
        margin-bottom: 0;
        border-bottom: none;
    }
</style>
<div id="container-server_pool_backend" class="container-fluid" style="display:none" data-name="server_pool_backend">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>
                <div id="btn-server_pool_backend-back">
                    <i class="material-icons"
                        style="position:absolute;margin:4px 0 0 -10px;font-size:35px;">chevron_left</i>
                    <span id="title-server_pool_backend-name" style="margin-left:25px"></span>
                </div>
            </h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_server_pool_backend" class="btn btn-primary btn-mod-action">Add Backend</button>
            
        </div>
        <div class="col-lg-12">
            <div class="table-server_pool_backend">
                <div id="health-check-result">
                    <div id="health-check-status"></div>
                    <div id="health-check-close">&#10005;</div>
                    <div style="padding:5px">
                        <p>Header</p>
                        <div id="health-check-header"></div>
                        <p>Body</p>
                        <div id="health-check-body"></div>
                        <p>Error</p>
                        <div id="health-check-error"></div>
                    </div>
                </div>
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col"></th>
                            <th scope="col">Backend</th>
                            <th scope="col">Weight</th>
                            <th scope="col">Weight %</th>
                            <th scope="col">Request Per Min</th>
                            <th scope="col">Success Rate</th>
                            <th scope="col">Health Check</th>
                            <th scope="col">Last Checked</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-server_pool_backend" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        
<div id="container-change-password" class="container-fluid" style="display:none" data-name="change-password">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Change Password</h2>
        </div>
        <div class="col-lg-12">
            <form>
                <div class="form-group row">
                    <label for="txt-old-password" class="col-sm-2 col-form-label">Old Password</label>
                    <div class="col-sm-10">
                        <input type="password" class="form-control" id="txt-old-password" placeholder="Old Password">
                    </div>
                </div>
                <div class="form-group row">
                    <label for="txt-new-password" class="col-sm-2 col-form-label">New Password</label>
                    <div class="col-sm-10">
                        <input type="password" class="form-control" id="txt-new-password" placeholder="New Password">
                    </div>
                </div>
                <div class="form-group row">
                    <label for="txt-confirm-password" class="col-sm-2 col-form-label">Confirm Password</label>
                    <div class="col-sm-10">
                        <input type="password" class="form-control" id="txt-confirm-password"
                            placeholder="Confirm Password">
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-sm-10 offset-sm-2">
                        <button id="btn-save-pass" type="button" class="btn btn-primary">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

        
<div id="container-custom-header" class="container-fluid" style="display:none" data-name="custom-header">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>HTTP Header</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn_add-custom_header" class="btn btn-primary btn-mod-action">Add Header</button>
        </div>
        <div class="col-lg-12">
            <div class="table-responsive">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Header Name</th>
                            <th scope="col">Direction</th>
                            <th scope="col">Content</th>
                            <th scope="col">Custom Content</th>
                            <th scope="col">Scope</th>
                            <th scope="col">Group/Site</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-custom_header" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


        
<div id="container-report-requests" class="container-fluid" style="display:none" data-name="report-requests">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Total Requests Per Minute</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-search_requests" class="btn btn-primary" style="float:right;margin-left:7px">Search</button>
            <input id="txt_search_requests_to" type="text" class="form-control" placeholder="to" style="float:right;width:160px;margin-left:7px">
            <input id="txt_search_requests_from" type="text" class="form-control" placeholder="from" style="float:right;width:160px;">
        </div>
        <div class="col-lg-12">
            <canvas id="rpm-chart" width="800" height="450"></canvas>
        </div>
    </div>
</div>

        
<div id="container-report-memory" class="container-fluid" style="display:none" data-name="report-memory">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Memory Useage</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-search_memory" class="btn btn-primary" style="float:right;margin-left:7px">Search</button>
            <input id="txt_search_search_memory_to" type="text" class="form-control" placeholder="to" style="float:right;width:160px;margin-left:7px">
            <input id="txt_search_search_memory_from" type="text" class="form-control" placeholder="from" style="float:right;width:160px;">
        </div>
        <div class="col-lg-12">
            <canvas id="mem-chart" width="800" height="450"></canvas>
        </div>
    </div>
</div>

        
<div id="container-report-app-memory" class="container-fluid" style="display:none" data-name="report-app-memory">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>App Memory Useage</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-search_app-memory" class="btn btn-primary"
                style="float:right;margin-left:7px">Search</button>
            <input id="txt_search_search_app-memory_to" type="text" class="form-control" placeholder="to"
                style="float:right;width:160px;margin-left:7px">
            <input id="txt_search_search_app-memory_from" type="text" class="form-control" placeholder="from"
                style="float:right;width:160px;">
        </div>
        <div class="col-lg-12">
            <canvas id="app-mem-chart" width="800" height="450"></canvas>
        </div>
    </div>
</div>

        
<div id="container-report-bandwidth" class="container-fluid" style="display:none" data-name="report-bandwidth">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>Network Bandwidth</h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-search_bandwidth" class="btn btn-primary"
                style="float:right;margin-left:7px">Search</button>
            <input id="txt_search_bandwidth_to" type="text" class="form-control" placeholder="to"
                style="float:right;width:160px;margin-left:7px">
            <input id="txt_search_bandwidth_from" type="text" class="form-control" placeholder="from"
                style="float:right;width:160px;">
            <select id="option-search_bandwidth_interface" class="form-control dropdown"></select>
            <select id="option-search_bandwidth_proxy" class="form-control dropdown"></select>
        </div>
        <div class="col-lg-12">
            <canvas id="bandwidth-chart" width="800" height="450"></canvas>
        </div>
    </div>
</div>

        
<style>
    .txt_www_enabled {
        margin-left: 5px;
    }

    .chk-enable-www-domain {
        margin-right: 5px;
    }

    #btn-domain_back {
        cursor: pointer;
        display: inline-block
    }

    #btn-domain_back:hover {
        text-decoration: underline;
        color: #007bff;
    }

    .clickable-url {
        cursor: pointer;
        color: #285caf;
    }

    .clickable-url:hover {
        text-decoration: underline;
        color: #007bff;
    }

    .domain-dns-status {
        vertical-align: middle;
        cursor: pointer;
    }

    #tbody-domain_edit tr td:first-child {
        width: 1%;
        white-space: nowrap;
    }

    .www-status {
        margin-left: 5px;
    }
</style>
<div id="container-domain_edit" class="container-fluid" style="display:none" data-name="domain_edit">
    <div class="row">
        <div class="col-lg-12 pt-3 pb-2">
            <h2>
                <div id="btn-domain_back">
                    <i class="material-icons"
                        style="position:absolute;margin:4px 0 0 -10px;font-size:35px;">chevron_left</i>
                    <span id="title-domain_edit" style="margin-left:25px"></span>
                </div>
            </h2>
        </div>
        <div class="col-lg-12 text-left pb-3">
            <button id="btn-add_domain_edit" class="btn btn-primary btn-mod-action">Add Hostname</button>
        </div>
        <div class="col-lg-12">
            <div class="table-responsive">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col" class="col_status"></th>
                            <th scope="col">Hostname</th>
                            <th scope="col">Verify DNS</th>
                            <th scope="col">Force https</th>
                            <th scope="col">www</th>
                            <th scope="col" id="col_backend">Backend</th>
                            <th scope="col" class="head-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-domain_edit" class="tbody-content_editable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        
<style>
    .section label {
        text-transform: capitalize;
    }

    .sub-title {
        margin-top: -28px;
    }

    .form-check-input-custom {
        position: absolute;
        margin-top: 15px;
    }
</style>
<div id="container-admin-setting" class="container-fluid" style="display:none" data-name="admin-setting">
</div>

    </div>
</div>

<script>
    var global_data = {
        uid: '6',
    };
    var msg = new Utils.Http.Message();

    $(document).ready(function () {
        roleControl();
        
        $('#btn-logout').click(function () {
            msg.Send({
                type: "POST",
                url: "/api/admin/logout",
                dataType: "json",
                timeout: 10000,
                success: function (data) {
                    location.href = "/";
                },
                error: function (xhr, status, error) {
                    console.log(error);
                    location.href = "/";
                }
            })
        })
    })

    function roleControl() {
        switch (role) {
            case "3":
                $('#user_role').html("(admin)");
                break;
            case "4":
                
                
                
                $('#user_role').html("(viewer)");
                $('#menu-admin').hide();
                break;
            case "5":
                
                $('#user_role').html("(editor)");
                $('#menu-admin').hide();
                break;
        }
    }

    function menuClick(elem) {
        
        $('.menu_item').removeClass("active");
        elem.addClass('active');
        
        var name = elem.attr('data-name');
        showPage(name)
    }

    function showPage(name) {
        $('.container-fluid').hide();
        $('#container-' + name).show();
    }

    function createRow(attr, action, ...elems) {
        var row = "";
        if (attr == null) {
            row = '<tr style="position:relative">';
        } else {
            if (typeof (attr) === "number") {
                row = '<tr data-id="' + attr + '" style="position:relative">';
            } else if (typeof (attr) === "object") {
                var generated_attr = [];
                for (var key in attr) {
                    generated_attr.push('data-' + key + '="' + attr[key] + '"');
                }
                row = '<tr ' + generated_attr.join(' ') + ' style="position:relative">';
            }
        }
        
        elems.push(action);
        
        $.each(elems, function (i, r) {
            row += r;
        })
        row += '</tr>';
        return row
    }

    
    var user_list = [];
    function listUser() {
        return msg.New({
            type: 'POST',
            url: '/api/user/list',
            data: { keyword: "", group: "0" },
            dataType: 'json',
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    user_list = data.Result;
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }

    var user_group_list = [];
    function listGroup() {
        return msg.New({
            type: 'POST',
            url: '/api/accountGroup/list',
            dataType: 'json',
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    user_group_list = data.Result;
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }

    var autocomplete_data;
    var autocomplete_user_data;
    var autocomplete_group_data;
    function onListUserGroup(onComplete) {
        $.when(listUser(), listGroup()).done(function () {
            autocomplete_user_data = $.map(user_list.Sites, function (data) { return { value: data.Username, data: { id: data.ID } }; });
            autocomplete_group_data = $.map(user_group_list, function (data) { return { value: data.Name, data: { id: data.ID } }; });

            var user = $.map(user_list, function (data) { return { value: data.Username, data: { id: data.ID, category: 'user' } }; });
            var group = $.map(user_group_list, function (data) { return { value: data.Name, data: { id: data.ID, category: 'group' } }; });
            autocomplete_data = user.concat(group);
            onComplete();
        })
    }

    function setAutoComplete(target, data) {
        var ac = $(target);
        ac.autocomplete({
            lookup: data,
            minChars: 1,
            onSelect: function (suggestion) {
                $(this).attr('data-id', suggestion.data.id);
            },
            onInvalidateSelection: function () {
                $(this).removeAttr('data-id');
            },
            appendTo: ac.parent(),
            showNoSuggestionNotice: true,
            noSuggestionNotice: 'no result',
        });
    }
</script>

<script>
    var $txt_search_account = $('#txt_search_account');

    $(document).ready(function () {
        $('#btn-menu_account').click(function () {
            menuClick($(this));
            Account.onPrelistAccountGroup();
            Account.onPrelistCNAME();
            
            Account.onPrelistCP();

            
            Account.onPrelistBackend();
            Account.onPrelistServerPool();

            Account.onListAccount();
        })

        $txt_search_account.keyup(function (e) {
            if (e.keyCode == 13) {
                e.preventDefault();
                Account.onSearchAccount();
            }
        })

        $('#btn-search_account').click(function () {
            Account.onSearchAccount();
        })

        Account.onPrelistAccountGroup();
        Account.onPrelistCNAME();
        
        Account.onPrelistCP();

        
        Account.onPrelistBackend();
        Account.onPrelistServerPool();

        Account.onListAccount();
        Account.onAddAccount();
    })

    var Account = {
        loginForm: null,
        createLoginForm: function (cpList) {
            var cname = '<div class="title">URL</div>';
            $.each(cpList, function (i, val) {
                cname += '<input type="text" class="read-only" value=' + val + ' readonly="readonly"/>';
            })
            var login = '<div class="title">Login</div>' + '<input type="text" class="txt_change_account_username" value="" readonly="readonly" />';
            var password = '<div class="title">Password</div>' + '<input type="password" class="txt_change_account_password"/>';
            var confirm_password = '<div class="title">Confirm Password</div>' + '<input type="password" class="txt_change_account_confirm_password"/>';
            var email = '<div class="title">Password Reminder</div>' + '<input type="text" class="txt_change_account_email" placeholder="Email"/>';
            var formText = '<div class="form_change_account_password" style="z-index:100">' +
                '<div class="header_change_account_password clearfix"><span class="title_change_account_password no select" style="font-weight:bold">Site Panel</span><span class="close_change_account_password noselect">&#x2715;</span></div>' +
                '<div style="padding:10px">' + cname + login + password + confirm_password + email +
                '<div class="warning_change_account_password"></div>' +
                '<input class="btn_change_account_password btn btn-primary" type="button" value="Save"/>' +
                '</div>' + '</div>';
            Account.loginForm = $(formText);
        },
        onSaveLogin: function (elem) {
            elem.find('.btn-account-domain_password').unbind('click').click(function () {
                var pos = $(this).position();
                var form = $(this).parent().find('.form_change_account_password');
                if (form.length > 0) {
                    form.remove('.form_change_account_password');
                } else {
                    $(this).parent().append(Account.loginForm);
                }
                Account.loginForm.find('.close_change_account_password').click(function () {
                    Account.loginForm.remove();
                })
                Account.loginForm.find('.txt_change_account_username').val(elem.find('.txt-account-username').val());
                Account.loginForm.find('.txt_change_account_password').val('********');
                Account.loginForm.find('.txt_change_account_confirm_password').val('');
                Account.loginForm.find('.txt_change_account_email').val(elem.attr('data-email'));
                Account.loginForm.find('.warning_change_account_password').html("");

                
                Account.loginForm.find('.btn_change_account_password').click(function () {
                    Account.loginForm.find('.warning_change_account_password').html("");
                    var id = parseInt(elem.attr('data-id'));
                    var password = $.trim(Account.loginForm.find('.txt_change_account_password').val());
                    if (password == "********") {
                        password = null;
                    }
                    confirm_password = $.trim(Account.loginForm.find('.txt_change_account_confirm_password').val());
                    if (password != confirm_password) {
                        alert('confirm password is not same');
                        return;
                    }
                    var email = $.trim(Account.loginForm.find('.txt_change_account_email').val());
                    
                    msg.Send({
                        type: "POST",
                        url: "/api/user/setLogin",
                        dataType: "json",
                        timeout: 10000,
                        data: { id: id, password: password, email: email },
                        success: function (data) {
                            if (data.ErrCode == 0) {
                                elem.attr('data-email', email);
                                
                                Account.loginForm.find('.warning_change_account_password').css("color", "green").html("success");
                            } else {
                                Account.loginForm.find('.warning_change_account_password').css("color", "red").html(data.ErrText);
                            }
                        },
                        error: function (xhr, status, error) {
                            alert(error);
                            if (xhr.status == 401) {
                                location.href = "/";
                            }
                        }
                    })
                })
            });
        },
        backendListElem: '<select class="sel_account_backends"></select>',
        
        
        
        backendList: null,
        serverPoolList: null,
        onPrelistBackend: function () {
            msg.Send({
                type: "POST",
                url: "/api/backend/listAddr",
                dataType: "json",
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var opt_group = $('<optgroup label="Backend">');
                        $.each(data.Result, function (i, val) {
                            opt_group.append($('<option value="bkend_' + val.ID + '">' + val.Name + '</option>'));
                            
                        })
                        Account.backendList = opt_group;
                        newBackendList = Account.backendList.clone()
                        newBackendList.prepend($('<option value="0">any Backend</option>'));
                        
                        $('#sel-account_backend').empty().append(newBackendList);
                    }
                    else alert(data.ErrText);
                }, error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        onPrelistServerPool: function () {
            msg.Send({
                type: "POST",
                url: "/api/serverpool/listName",
                dataType: "json",
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var opt_group = $('<optgroup label="Backend Pool">');
                        $.each(data.Result, function (i, val) {
                            opt_group.append($('<option value="spool_' + val.ID + '">' + val.Name + '</option>'));
                        })
                        Account.serverPoolList = opt_group;
                        $('#sel-account_backend').append(opt_group);
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        accountGroup: null,
        onPrelistAccountGroup: function () {
            msg.Send({
                type: "POST",
                url: "/api/accountGroup/list",
                dataType: "json",
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var dbGroup = '';
                        $.each(data.Result, function (i, val) {
                            dbGroup += '<option value="' + val.ID + '">' + val.Name + '</option>';
                        })
                        Account.accountGroup = $('<select class="sel_account_group"></select>').html('<option value="">-</option>' + dbGroup);
                        Account.accountGroup.val("");
                        $('#sel-account_group').html('<option value="0">any group</option>' + '<option value="">-</option>' + dbGroup);
                        
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        CNAMEList: null,
        onPrelistCNAME: function () {
            msg.Send({
                type: "POST",
                url: "/api/rpEntrypoint/list",
                dataType: "json",
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var dbGroup = '';
                        $.each(data.Result, function (i, val) {
                            dbGroup += '<option value="' + val.ID + '" data-proxy="' + val.ProxyName + '">' + val.Hostname + '</option>';
                        })
                        Account.CNAMEList = $('<select class="sel_account_cname"></select>').html('<option value="" data-proxy="-">-</option>' + dbGroup);
                        Account.CNAMEList.val("");
                        $('#sel-account_cname').html('<option value="0">any CNAME</option>' + dbGroup);
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        onPrelistCP: function () {
            msg.Send({
                type: "POST",
                url: "/api/cpEntrypoint/listPublic",
                dataType: "json",
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var cpList = [];
                        $.each(data.Result, function (i, val) {
                            cpList.push(val.Hostname);
                        })
                        Account.createLoginForm(cpList);
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        onSearchAccount: function (text) {
            Account.onListAccount()
        },
        onDomainEdit: function (elem) {
            elem.find('.btn-account-domain_edit').click(function () {
                var siteId = elem.attr('data-id');
                var hostname = elem.find('.txt-account-username').val();
                domain_edit.OnList(siteId, hostname);
            })
        },
        onListAccount: function (pageNum = 1, pageSize = 20) {
            data = {
                keyword: $.trim($txt_search_account.val()),
                group: $('#sel-account_group').val(),
                pageSize: pageSize,
                pageNum: pageNum,
                CNAMEID: parseInt($('#sel-account_cname').val()),
                Tags: $('#txt_search_account_tags').val(),
            };
            var backend = $('#sel-account_backend').val().split('_');
            if (backend[0] == 'bkend') {
                data.BackendID = parseInt(backend[1]);
            } else if (backend[0] == 'spool') {
                data.BackendPoolID = parseInt(backend[1])
            }
            msg.Send({
                type: "POST",
                url: "/api/user/list",
                dataType: "json",
                data: data,
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var table = [];
                        var count = data.Result.Count[0];
                        $.each(data.Result.Sites, function (i, val) {
                            var LastUpdateLabel = '';
                            
                            color = Utils.Colors.Grey;
                            if (val.LastUpdate != null) {
                                
                                
                                
                                if (val.HealthCount == val.BackendCount) {
                                    var time_difference = Utils.Datetime.Difference(val.LastUpdate, val.ServerTime);
                                    if (time_difference <= 60 * 5) {
                                        color = Utils.Colors.LightGreen;
                                    } else if (time_difference <= 3600) {
                                        color = Utils.Colors.DeepGreen;
                                    } else if (time_difference <= 3600 * 24) {
                                        color = Utils.Colors.LightBlue;
                                    } else if (time_difference > 3600 * 24) {
                                        color = Utils.Colors.DeepBlue;
                                    }
                                    
                                    if (val.BackendCount == 0 && val.Status == 0) {
                                        color = Utils.Colors.Red;
                                    }
                                } else if (val.HealthCount > 0) {
                                    color = Utils.Colors.Orange;
                                } else if (val.HealthCount == 0) {
                                    color = Utils.Colors.Red;
                                }
                                title = Utils.Datetime.LastActiveB(val.LastUpdate, val.ServerTime);
                                unhealthyBackendCount = val.BackendCount - val.HealthCount;
                                if (unhealthyBackendCount > 0) {
                                    if (unhealthyBackendCount == 1) {
                                        title += ' and ' + unhealthyBackendCount + ' backend down';
                                    } else {
                                        title += ' and ' + unhealthyBackendCount + ' backends down';
                                    }
                                }
                                LastUpdateLabel = 'title="Last active ' + title + '"';
                            } else {
                                LastUpdateLabel = 'title="Never active"';
                            }
                            var status = '<td><i style="color:' + color + '" class="dboard-status material-icons" ' + LastUpdateLabel + '>fiber_manual_record</i></td>'
                            var username = '<td><input class="txt-account-username" type="text" value="' + val.Username + '" readonly="readonly" /></td>';
                            var host = '<td><input class="txt-account-hostname" type="text" value="' + val.Host + '" readonly="readonly" /></td>';
                            var cname = '<td><span class="txt_account_cname"></span>' + Account.CNAMEList.clone().hide().prop("disabled", "disabled").outerHTML() + '</td>';
                            var tags = '<td><input class="txt-account_tags" type="text" value="' + val.Tags + '" readonly="readonly" /></td>';
                            var group = '<td><span class="txt_account_group"></span>' + Account.accountGroup.clone().hide().prop("disabled", "disabled").outerHTML() + '</td>';
                            var backendData = $(Account.backendListElem)
                                .append(Account.backendList.clone())
                                .append(Account.serverPoolList.clone())
                                .hide().prop("disabled", "disabled");
                            var backend = '<td><span class="txt_account_backends"></span>' + backendData.outerHTML() + '</td>';
                            var action = '<td class="show-all"><i class="btn-account-cancel fas fa-times clickable head-action" style="display:none"></i>' +
                                '<i class="btn-account-save fas fa-save clickable head-action" style="display:none"></i>' +
                                '<i class="btn-account-edit fas fa-cog clickable head-action"></i>' +
                                '<i class="btn-account-domain_edit fas fa-globe clickable" title="hostnames"></i>' +
                                '<i class="btn-account-domain_password fas fa-key clickable" title="password"></i>' +
                                '<i class="btn-maintenance fas fa-exclamation-triangle clickable head-action" title="maintenance"></i>' +
                                '<i class="btn-account-del fas fa-trash-alt clickable head-action"></i>' +
                                '</td>';
                            var $block = $(createRow({ 'id': val.ID, 'email': val.Email }, action, status, username, tags, host, backend, group, cname));
                            
                            val.CNAMEID = val.CNAMEID == null ? "" : val.CNAMEID;
                            $block.find('.sel_account_cname').val(val.CNAMEID);
                            $block.find('.txt_account_cname').html($block.find(".sel_account_cname").find('option:selected').text());
                            
                            
                            $block.find(".sel_account_group").val(val.GroupID);
                            $block.find(".txt_account_group").html($block.find(".sel_account_group").find('option:selected').text());
                            
                            if (val.ServerPoolID != null) {
                                $block.find('.sel_account_backends').val("spool_" + val.ServerPoolID);
                            } else if (val.BackendID != null) {
                                $block.find('.sel_account_backends').val("bkend_" + val.BackendID);
                                
                            }
                            $block.find('.txt_account_backends').html($block.find('.sel_account_backends').find('option:selected').text());
                            if (val.Maintenance) {
                                $block.addClass("maintenance");
                            }
                            
                            Account.onDeleteAccount($block);
                            Account.onEditAccount($block);
                            Account.onSaveAccount($block);
                            Account.onCancelAccount($block);
                            Account.onDomainEdit($block);
                            Account.onSaveLogin($block);
                            
                            Account.onMaintenance($block);
                            table.push($block);
                        })
                        $('#tbody-account').html(table);
                        
                        $('#tfoot-account').hide();
                        if (count > 0) {
                            Utils.UI.Paging($('#tfoot-account'), pageNum, count, pageSize, Account.onListAccount);
                        }
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        onAddAccount: function () {
            $('#btn-add_account').click(function () {
                
                var status = '<td><i style="color:grey" class="dboard-status material-icons">fiber_manual_record</i></td>'
                var username = '<td><input class="txt-account-username" type="text" value="" placeholder="name" /></td>';
                var host = '<td><input class="txt-account-hostname" type="text" value="" placeholder="host" /></td>';
                var group = '<td><span class="txt_account_group" style="display:none"></span>' + Account.accountGroup.clone().outerHTML() + '</td>';
                var cname = '<td><span class="txt_account_cname" style="display:none"></span>' + Account.CNAMEList.clone().hide().prop('disabled', 'disabled').outerHTML() + '</td>';
                var tags = '<td><input class="txt-account_tags" type="text" value="" placeholder="tags" /></td>';
                var backendData = $(Account.backendListElem)
                    .append(Account.backendList.clone())
                    .append(Account.serverPoolList.clone());
                var backend = '<td><span class="txt_account_backends" style="display:none"></span>' + backendData.outerHTML() + '</td>';
                var action = '<td>' +
                    '<i class="btn-account-cancel fas fa-times clickable"></i>' +
                    '<i class="btn-account-save fas fa-save clickable"></i>' +
                    '<i class="btn-account-edit fas fa-cog clickable" style="display:none"></i>' +
                    '<i class="btn-account-domain_edit fas fa-globe clickable" title="hostnames" style="display:none"></i>' +
                    '<i class="btn-account-domain_password fas fa-key clickable" title="password" style="display:none"></i>' +
                    '<i class="btn-maintenance fas fa-exclamation-triangle clickable head-action" title="maintenance" style="display:none"></i>' +
                    '<i class="btn-account-del fas fa-trash-alt clickable"></i>' +
                    '</td>';
                var $block = $(createRow(null, action, status, username, tags, host, backend, group, cname));
                $block.attr('data-email', '');
                Account.onDeleteAccount($block);
                Account.onSaveAccount($block);
                Account.onEditAccount($block);
                Account.onCancelAccount($block);
                Account.onSaveLogin($block);
                Account.onDomainEdit($block);
                
                Account.onMaintenance($block);
                $('#tbody-account').prepend($block);
            })
        },
        onDeleteAccount: function (elem) {
            elem.find('.btn-account-del').click(function () {
                var id = elem.attr('data-id');
                if (typeof (id) == 'undefined') {
                    elem.remove();
                    return;
                }
                var username = elem.find('.txt-account-username').val();
                var confirmed = confirm("delete " + username + "?");
                if (confirmed == false) {
                    return;
                }
                var id = parseInt(id);
                msg.Send({
                    type: "POST",
                    url: "/api/user/delete",
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id },
                    success: function (data) {
                        elem.remove();
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
        onSaveAccount: function (elem) {
            elem.find('.btn-account-save').click(function () {
                var $btn_save = $(this);
                
                var url = "";
                var id = elem.attr('data-id');
                if (typeof (id) == 'undefined') {
                    url = "/api/user/add";
                } else {
                    url = "/api/user/edit";
                }
                id = parseInt(id);
                
                var username = elem.find('.txt-account-username').val();
                username = $.trim(username);
                if (!Utils.String.CheckName(username)) {
                    alert("invalid username (a-z 0-9 - . @)");
                    return;
                }
                
                var host = elem.find('.txt-account-hostname').val();
                host = $.trim(host);
                
                var tags = elem.find('.txt-account_tags').val();
                tags = $.trim(tags);
                
                var group = parseInt(elem.find('.sel_account_group').val());
                if (isNaN(group)) {
                    group = null;
                }
                
                var cname = parseInt(elem.find('.sel_account_cname').val());
                if (isNaN(cname)) {
                    cname = null;
                }
                
                var backend = elem.find('.sel_account_backends').val();
                backend_data = backend.split("_");
                var backendInt = null;
                var serverPoolInt = null;
                if (backend_data[0] == "bkend") {
                    backendInt = parseInt(backend_data[1]);
                    if (isNaN(backendInt)) {
                        alert("invalid backend:", backend_data[1]);
                    }
                } else if (backend_data[0] == "spool") {
                    serverPoolInt = parseInt(backend_data[1]);
                    if (isNaN(serverPoolInt)) {
                        alert("invalid backend:", backend_data[1]);
                    }
                }
                
                var xForwardedFor = elem.find('.txt-account-xff').val();
                xForwardedFor = $.trim(xForwardedFor)
                
                msg.Send({
                    type: "POST",
                    url: url,
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id, Username: username, groupID: group, hostnameID: cname, backendID: backendInt, serverPoolID: serverPoolInt, host: host, tags: tags },
                    success: function (data) {
                        if (url == "/api/user/add") {
                            elem.attr('data-id', data.Result.SiteID)
                        }
                        elem.find('.sel_account_cname').val(data.Result.HostnameID);

                        elem.find('input[type="text"]').attr('readonly', true).removeAttr('data-val');
                        elem.find("select").attr('disabled', true).removeAttr("data-val");
                        elem.find('.btn-account-save').hide();
                        elem.find('.btn-account-cancel').hide();
                        elem.find('.btn-account-edit').show();
                        elem.find('.btn-account-domain_edit').show();
                        elem.find('.btn-account-domain_password').show();
                        elem.find('.btn-maintenance').show();
                        elem.find('.txt_account_group').show().html(elem.find('.sel_account_group').find('option:selected').text());
                        elem.find('.sel_account_group').hide();
                        elem.find('.txt_account_backends').show().html(elem.find('.sel_account_backends').find('option:selected').text());
                        elem.find('.sel_account_backends').hide();
                        elem.find('.txt_account_cname').show().html(elem.find('.sel_account_cname').find('option:selected').text());
                        elem.find('.sel_account_cname').hide();
                        elem.find('.txt_account_proxy').show().html(elem.find('.sel_account_cname').find('option:selected').attr('data-proxy'));
                        elem.find('.txt-account-hostname').attr('placeholder', '');
                        elem.find('.txt-account_tags').attr('placeholder', '');

                        $btn_save.hide();
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
        onEditAccount: function (elem) {
            elem.find('.btn-account-edit').click(function () {
                var id = elem.attr('data-id');
                elem.find('input[type="text"]').attr('readonly', false).each(function () {
                    $(this).attr('data-val', $(this).val());
                });
                elem.find("select").removeAttr("disabled").each(function () {
                    $(this).attr('data-val', $(this).val());
                })

                elem.find('.txt_account_group').hide();
                elem.find('.sel_account_group').show();
                elem.find('.txt_account_backends').hide();
                elem.find('.sel_account_backends').show();
                elem.find('.txt_account_cname').hide();
                elem.find('.sel_account_cname').show();

                elem.find('.txt-account-hostname').attr('placeholder', 'host');

                $(this).hide();
                elem.find('.btn-account-domain_edit').hide();
                elem.find('.btn-account-domain_password').hide();
                elem.find('.btn-account-save').show();
                elem.find('.btn-account-cancel').show();
            })
        },
        onCancelAccount: function (elem) {
            elem.find('.btn-account-cancel').click(function () {
                
                if (elem.attr('data-id') == null) {
                    elem.remove();
                    return;
                }
                
                elem.find('input[type="text"]').each(function () {
                    $(this).val($(this).attr('data-val'));
                }).removeAttr('data-val').attr('readonly', true);
                elem.find('select').each(function () {
                    $(this).val($(this).attr('data-val'));
                }).removeAttr('data-val').attr('disabled', true);

                elem.find('.txt_account_group').show();
                elem.find('.sel_account_group').hide();
                elem.find('.txt_account_backends').show();
                elem.find('.sel_account_backends').hide();
                elem.find('.txt_account_cname').show();
                elem.find('.sel_account_cname').hide();

                elem.find('.btn-account-save').hide();
                elem.find('.btn-account-cancel').hide();
                elem.find('.btn-account-edit').show();
                elem.find('.btn-account-domain_edit').show();
                elem.find('.btn-account-domain_password').show();
            })
        },
        
        
        
        
        
        onMaintenance: function (elem) {
            elem.find('.btn-maintenance').click(function () {
                
                var id = elem.attr('data-id');
                if (typeof (id) == 'undefined') {
                    alert("unknown error: missing id");
                    return;
                }
                var id = parseInt(id);
                
                var maintenance = elem.hasClass('maintenance');
                
                var name = elem.find('.txt-account-username').val();
                var text = "make " + name + " temporarily unavailable?";
                if (maintenance) {
                    text = "turn off maintenance mode for " + name + "?";
                }
                if (confirm(text) == false) {
                    return;
                }
                msg.Send({
                    type: "POST",
                    url: "/api/user/maintenance",
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id, maintenance: !maintenance },
                    success: function (data) {
                        elem.toggleClass('maintenance', !maintenance)
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
    }

</script>


<script>
    var $txt_search_domain = $('#txt_search_domain');

    $(document).ready(function () {
        $('#btn-menu_domain').click(function () {
            menuClick($(this));
            onListDomain();
            onListGroup();
        })

        $txt_search_domain.keyup(function (e) {
            if (e.keyCode == 13) {
                e.preventDefault();
                onListDomain();
            }
        })

        $('#btn-search_domain').click(function () {
            onListDomain()
        })
    })

    function onListGroup() {
        msg.Send({
            type: "POST",
            url: "/api/accountGroup/list",
            dataType: "json",
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    var sel = [];
                    sel.push($('<option value="0">any group</option>'));
                    sel.push($('<option value="">-</option>'));
                    $.each(data.Result, function (i, val) {
                        var $block = $('<option value="' + val.ID + '">' + val.Name + '</option>');
                        sel.push($block);
                    })
                    $('#sel-domain_group').html(sel);
                    
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }

    function onListDomain(pageNum = 1, pageSize = 20) {
        data = { keyword: $.trim($txt_search_domain.val()), group: $('#sel-domain_group').val(), DNSVerification: parseInt($('#sel-domain_dns_verification').val()), pageSize: pageSize, pageNum: pageNum };
        msg.Send({
            type: "POST",
            url: "/api/domain/list",
            dataType: "json",
            data: data,
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    var table = [];
                    $.each(data.Result.Domains, function (i, val) {
                        var LastUpdateLabel = '';
                        
                        color = Utils.Colors.Grey;
                        if (val.LastUpdate != null) {
                            var time_difference = Utils.Datetime.Difference(val.LastUpdate, val.ServerTime)
                            if (time_difference <= 60 * 5) {
                                color = Utils.Colors.LightGreen;
                            } else if (time_difference <= 3600) {
                                color = Utils.Colors.DeepGreen;
                            } else if (time_difference <= 3600 * 24) {
                                color = Utils.Colors.LightBlue;
                            } else if (time_difference > 3600 * 24) {
                                color = Utils.Colors.DeepBlue;
                            }
                            LastUpdateLabel = 'title="Last active ' + Utils.Datetime.LastActiveB(val.LastUpdate, val.ServerTime) + '"';
                        } else {
                            LastUpdateLabel = 'title="Never active"';
                        }

                        if (val.Group == null) {
                            val.Group = "-";
                        }
                        var site = val.Site;
                        var host = val.Host;
                        var backend = "";
                        if (val.Backend != null) {
                            backend = val.Backend
                        } else if (val.ServerPool != null) {
                            backend = val.ServerPool
                        }
                        var dns_verification = '<td></td>';
                        
                        if (val.RootValid == 3) {
                            dns_verification = '<td><i class="fa fa-minus" title="No DNS verification for IP address"></td>';
                        } else if (val.RootValid == 2) {
                            dns_verification = '<td><i class="fa fa-times" style="color:red" title="DNS verification failed"></td>';
                        } else if (val.RootValid == 0) {
                            dns_verification = '<td><i class="fa fa-ellipsis-h" title="Pending DNS verification"></td>';
                        } else if (val.RootValid == 1) {
                            dns_verification = '<td><i class="fa fa-check" title="Last verified ' + Utils.Datetime.RemoveTZ(val.LastChecked) + '"></td>';
                        }
                        var block = '<tr data-id="' + val.ID + '">' +
                            '<td class="col_status"><i style="color:' + color + '" class="dboard-status material-icons" ' + LastUpdateLabel + '>fiber_manual_record</i></td>' +
                            '<td>' + val.Name + '</td>' + dns_verification + '<td class="hostname_site_name">' + site + '</td><td>' + host + '</td><td>' + backend + '</td><td>' + val.Group + '</td></tr>';
                        var $block = $(block);
                        $block.find('.hostname_site_name').click(function () {
                            var site_name = $(this).html();
                            menuClick($('#btn-menu_account'));
                            $('#txt_search_account').val(site_name);
                            $('#btn-search_account').click();
                        })
                        table.push($block);
                    })
                    $('#tbody-domain').html(table);
                    
                    if (data.Result.Count.length > 0) {
                        total = data.Result.Count[0];
                        Utils.UI.Paging($('#tfoot-domain'), pageNum, total, pageSize, onListDomain);
                    }
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_redirect').click(function () {
            menuClick($(this));
            onListRedirect()
        })

        $('#btn-search_redirect').click(function () {
            var keyword = $.trim($('#txt_search_redirect').val());
            onSearchRedirect(keyword);
        })

        $('#txt_search_redirect').on('keyup', function (e) {
            if (e.keyCode == 13) {
                var keyword = $.trim($(this).val());
                onSearchRedirect(keyword);
            }
        });

        onAddRedirect();
    })

    function onSearchRedirect(keyword) {
        if (keyword.length == 0) {
            onListRedirect();
        } else {
            onListRedirect({ keyword: keyword });
        }
    }

    function onListRedirect(data) {
        msg.Send({
            type: "POST",
            url: "/api/redirect/list",
            dataType: "json",
            data: data,
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    var table = [];
                    $.each(data.Result, function (i, val) {
                        
                        var origin = '<td><input class="txt-origin-domain" type="text" value="' + val.Domain + '" readonly="readonly" placeholder="origin domain name" /></td>';
                        var dest = '<td><input class="txt-dest-url" type="text" value="' + val.Redirect + '" readonly="readonly" placeholder="destination url" /></td>';
                        
                        var redirect_mode = '<td><select disabled="disabled" class="txt-redirect-mode"><option selected value="301">301 Permanent Redirect</option><option value="302">302 Temporary Redirect</option></select></td>';
                        if (val.Type == 301) {
                            redirect_mode = '<td><select disabled="disabled" class="txt-redirect-mode"><option selected value="301">301 Permanent Redirect</option><option value="302">302 Temporary Redirect</option></select></td>';
                        } else if (val.Type == 302) {
                            redirect_mode = '<td><select disabled="disabled" class="txt-redirect-mode"><option>301 Permanent Redirect</option><option selected>302 Temporary Redirect</option></select></td>';
                        }
                        
                        var action = '<td><i class="btn-redirect-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                            + '<i class="btn-redirect-save fas fa-save clickable" style="display:none" title="save"></i>'
                            + '<i class="btn-redirect-edit fas fa-cog clickable" title="edit"></i>'
                            + '<i class="btn-redirect-del fas fa-trash-alt clickable" title="delete"></i></td>';
                        
                        var $row = $(createRow(val.ID, action, origin, redirect_mode, dest));
                        table.push($row);

                        onEditRedirect($row);
                        onCancelRedirect($row);
                        onDeleteRedirect($row);
                        onSaveRedirect($row);
                    })
                    $('#tbody-redirect').html(table);
                    $('[data-toggle="tooltip"]').tooltip()
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }

    function onAddRedirect() {
        $('#btn-add_redirect').click(function () {
            
            var origin = '<td><input class="txt-origin-domain" type="text" value="" placeholder="origin domain name" /></td>';
            var dest = '<td><input class="txt-dest-url" type="text" value="" placeholder="destination url" /></td>';
            
            var redirect_mode = '<td><select class="txt-redirect-mode"><option selected value="301">301 Permanent Redirect</option><option value="302">302 Temporary Redirect</option></select></td>';
            
            var action = '<td><i class="btn-redirect-cancel fas fa-times clickable" title="cancel"></i>'
                + '<i class="btn-redirect-save fas fa-save clickable" title="save"></i>'
                + '<i class="btn-redirect-edit fas fa-cog clickable" style="display:none" title="edit"></i>'
                + '<i class="btn-redirect-del fas fa-trash-alt clickable" title="delete"></i></td>';
            
            var $row = $(createRow(null, action, origin, redirect_mode, dest));
            
            onDeleteRedirect($row);
            onSaveRedirect($row);
            onCancelRedirect($row);
            
            $('#tbody-redirect').prepend($row);
        })
    }

    function onDeleteRedirect(elem) {
        elem.find('.btn-redirect-del').click(function () {
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                elem.remove();
                return;
            }
            var domain = elem.find('.txt-origin-domain').val();
            var confirmed = confirm("delete " + domain + "?");
            if (confirmed == false) {
                return;
            }
            var id = parseInt(id);
            msg.Send({
                type: "POST",
                url: "/api/redirect/delete",
                dataType: "json",
                timeout: 10000,
                data: { id: id },
                success: function (data) {
                    console.log(data);
                    elem.remove();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onEditRedirect(elem) {
        elem.find('.btn-redirect-edit').click(function () {
            var id = elem.attr('data-id');
            elem.find('input[type="text"]').attr('readonly', false).each(function () {
                $(this).attr('data-val', $(this).val());
            });
            elem.find('select').attr('disabled', false).each(function () {
                $(this).attr('data-val', $(this).val());
            });
            $(this).hide();
            elem.find('.btn-redirect-cancel').show();
            elem.find('.btn-redirect-save').show();
        })
    }

    function onCancelRedirect(elem) {
        elem.find('.btn-redirect-cancel').unbind('click').click(function () {
            
            if (elem.attr('data-id') == null) {
                elem.remove();
                return;
            }
            
            elem.find('input[type="text"]').each(function () {
                $(this).val($(this).attr('data-val'));
            }).removeAttr('data-val').attr('readonly', true);
            elem.find('select').each(function () {
                $(this).val($(this).attr('data-val'));
            }).removeAttr('data-val').attr('disabled', true);
            $(this).hide();
            elem.find('.btn-redirect-save').hide();
            elem.find('.btn-redirect-edit').show();
        })
    }

    function onSaveRedirect(elem) {
        elem.find('.btn-redirect-save').click(function () {
            
            var domain = elem.find('.txt-origin-domain').val();
            domain = $.trim(domain);
            if (domain.length == 0) {
                alert("origin domain cannot be empty");
                return;
            }

            
            var redirect_mode = elem.find('.txt-redirect-mode').val();
            redirect_mode = parseInt(redirect_mode);
            if (redirect_mode !== 301 && redirect_mode !== 302) {
                alert("invalid redirect mode");
                return;
            }

            
            var dest = elem.find('.txt-dest-url').val();
            dest = $.trim(dest)
            if (dest.length == 0) {
                alert("destination url cannot be empty");
                return;
            }

            
            var action = "edit";
            var input = { domain: domain, enablewww: -1, dest: dest, type: redirect_mode };
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                action = "add";
            } else {
                action = "edit";
                var id = parseInt(id);
                input.id = id;
            }

            msg.Send({
                type: "POST",
                url: "/api/redirect/" + action,
                dataType: "json",
                timeout: 10000,
                data: input,
                success: function (data) {
                    elem.find('input[type="text"]').attr('readonly', true).removeAttr('data-val');
                    elem.find(".txt-redirect-mode").attr('disabled', true);
                    elem.find('.txt-origin-domain').attr('readonly', true);
                    elem.find('.txt-dest-url').attr('readonly', true);
                    if (action != 'edit') {
                        onEditRedirect(elem);
                        onCancelRedirect(elem);
                        onSaveRedirect(elem);
                    }
                    elem.find('.btn-redirect-save').hide();
                    elem.find('.btn-redirect-edit').show();
                    elem.find('.btn-redirect-cancel').hide();
                    elem.attr('data-id', data.Result);
                    if (data.ErrText.length > 0) {
                        alert(data.ErrText);
                    }
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_proxy').click(function () {
            menuClick($(this));
            onListProxy();
        })
    })

    function onListProxy() {
        msg.Send({
            type: "POST",
            url: "/api/proxy/list",
            dataType: "json",
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    var table = [];
                    $.each(data.Result, function (i, val) {
                        var color = val.Online == true ? Utils.Colors.LightGreen : Utils.Colors.Red;
                        var lastActive = '';
                        if (val.LastActive != null) {
                            lastActive = 'title="Last active ' + Utils.Datetime.LastActive(val.LastActive) + '"';
                        }
                        var online = '<td class="txt-proxy-online"><i style="color:' + color + '" class="dboard-status material-icons" ' + lastActive + '>fiber_manual_record</i></td>';
                        var name = '<td class="txt-proxy-ip">' + val.Name + '</td>';
                        var ip = '<td class="txt-proxy-ip">' + val.IP + '</td>';
                        var uptime = '<td>' + Utils.Datetime.LastActive(val.Uptime) + '</td>';
                        var hostcount = '<td>' + val.HostCount + '</td>';
                        var block = '<tr data-id="' + val.ID + '">' + online + name + ip + uptime + hostcount + '</tr>';
                        var $block = $(block);
                        onDeleteProxy($block);
                        
                        
                        
                        table.push($block);
                    })
                    $('#tbody-proxy').html(table);
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }

    function onDeleteProxy(elem) {
        elem.find('.btn-proxy-del').click(function () {
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                elem.remove();
                return;
            }
            var key = elem.find('.txt-proxy-ip').html();
            var confirmed = confirm("delete " + key + "?");
            if (confirmed == false) {
                return;
            }
            var id = parseInt(id);
            msg.Send({
                type: "POST",
                url: "/api/proxy/delete",
                dataType: "json",
                timeout: 10000,
                data: { id: id },
                success: function (data) {
                    elem.remove();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }
</script>


<script>
    var $txt_search_proxy_entrypoint = $('#txt_search_proxy-entrypoint');

    $(document).ready(function () {
        $('#btn-menu_proxy-entrypoint').click(function () {
            menuClick($(this));
            onListProxyEntryPoint();
        })

        $txt_search_proxy_entrypoint.keyup(function (e) {
            if (e.keyCode == 13) {
                e.preventDefault();
                onSearchEntryPoint($(this).val());
            }
        })

        $('#btn-search_proxy_entrypoint').click(function () {
            onSearchEntryPoint($txt_search_proxy_entrypoint.val());
        })

        onAddProxyEntryPoint();
    })

    function onSearchEntryPoint(text) {
        var keyword = $.trim(text);
        if (keyword.length == 0) {
            onListProxyEntryPoint();
        } else {
            onListProxyEntryPoint({ keyword: keyword });
        }
    }

    function onListProxyEntryPoint(data) {
        msg.Send({
            type: "POST",
            url: "/api/rpEntrypoint/list",
            dataType: "json",
            data: data,
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    var table = [];
                    $.each(data.Result, function (i, val) {
                        var hostname = '<td><input class="txt-proxy_entrypoint-hostname" type="text" value="' + val.Hostname + '" readonly="readonly" /></td>';
                        var proxyName = '<td>' + val.ProxyName + '</td>';
                        var proxyIP = '<td>' + val.ProxyIP + '</td>';
                        var action = '<td><i class="btn-proxy_entrypoint-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                            + '<i class="btn-proxy_entrypoint-save fas fa-save clickable" style="display:none" title="save"></i>'
                            + '<i class="btn-proxy_entrypoint-edit fas fa-cog clickable" title="edit"></i>'
                            + '<i class="btn-proxy_entrypoint-del fas fa-trash-alt clickable" title="delete"></i>'
                            + '</td>';
                        var $block = $(createRow(val.ID, action, hostname, proxyName, proxyIP));
                        onDeleteProxyEntryPoint($block);
                        onEditProxyEntryPoint($block);
                        onSaveProxyEntryPoint($block);
                        onCancelProxyEntryPoint($block);
                        table.push($block);
                    })
                    $('#tbody-proxy_entrypoint').html(table);
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }

    function onAddProxyEntryPoint() {
        $('#btn-add_proxy_entrypoint').click(function () {
            var hostname = '<td><input class="txt-proxy_entrypoint-hostname" type="text" value=""/></td>';
            var action = '<td><i class="btn-proxy_entrypoint-cancel fas fa-times clickable" title="cancel"></i>'
                + '<i class="btn-proxy_entrypoint-save fas fa-save clickable" title="save"></i>'
                + '<i class="btn-proxy_entrypoint-edit fas fa-cog clickable" style="display:none" title="edit"></i>'
                + '<i class="btn-proxy_entrypoint-del fas fa-trash-alt clickable" title="delete"></i>'
                + '</td>';
            var block = '<tr>' + hostname + '<td></td><td></td>' + action + '</tr>';
            var $block = $(createRow(null, action, hostname, '<td></td>', '<td></td>'));
            onDeleteProxyEntryPoint($block);
            onSaveProxyEntryPoint($block);
            onEditProxyEntryPoint($block);
            onCancelProxyEntryPoint($block);
            $('#tbody-proxy_entrypoint').prepend($block);
        })
    }

    function onDeleteProxyEntryPoint(elem) {
        elem.find('.btn-proxy_entrypoint-del').click(function () {
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                elem.remove();
                return;
            }
            var hostname = elem.find('.txt-proxy_entrypoint-hostname').val();
            var confirmed = confirm("delete " + hostname + "?");
            if (confirmed == false) {
                return;
            }
            var id = parseInt(id);
            msg.Send({
                type: "POST",
                url: "/api/rpEntrypoint/delete",
                dataType: "json",
                timeout: 10000,
                data: { id: id },
                success: function (data) {
                    elem.remove();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onSaveProxyEntryPoint(elem) {
        elem.find('.btn-proxy_entrypoint-save').click(function () {
            var $btn_save = $(this);
            var url = "";
            
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                url = "/api/rpEntrypoint/add";
            } else {
                url = "/api/rpEntrypoint/edit";
            }
            id = parseInt(id);
            
            var hostname = elem.find('.txt-proxy_entrypoint-hostname').val();
            hostname = $.trim(hostname);
            if (hostname.length == 0) {
                alert("hostname cannot be empty");
                return;
            }

            msg.Send({
                type: "POST",
                url: url,
                dataType: "json",
                timeout: 10000,
                data: { id: id, hostname: hostname },
                success: function (data) {
                    elem.find('input[type="text"]').attr('readonly', true).removeAttr('data-val');
                    elem.find('.btn-proxy_entrypoint-save').hide();
                    elem.find('.btn-proxy_entrypoint-cancel').hide();
                    elem.find('.btn-proxy_entrypoint-edit').show();
                    if (url == "/api/rpEntrypoint/add") {
                        elem.attr('data-id', data.Result)
                    }
                    $btn_save.hide();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onEditProxyEntryPoint(elem) {
        elem.find('.btn-proxy_entrypoint-edit').click(function () {
            var id = elem.attr('data-id');
            elem.find('input[type="text"]').attr('readonly', false).each(function () {
                $(this).attr('data-val', $(this).val());
            });
            $(this).hide();
            elem.find('.btn-proxy_entrypoint-save').show();
            elem.find('.btn-proxy_entrypoint-cancel').show();
        })
    }

    function onCancelProxyEntryPoint(elem) {
        elem.find('.btn-proxy_entrypoint-cancel').click(function () {
            
            if (elem.attr('data-id') == null) {
                elem.remove();
                return;
            }
            
            elem.find('input[type="text"]').each(function () {
                $(this).val($(this).attr('data-val'));
            }).removeAttr('data-val').attr('readonly', true);
            elem.find('.btn-proxy_entrypoint-save').hide();
            elem.find('.btn-proxy_entrypoint-cancel').hide();
            elem.find('.btn-proxy_entrypoint-edit').show();
        })
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_ratelimit').click(function () {
            menuClick($(this));
            onListUserGroup(onListRatelimit);
        })
        onAddRatelimit();
    })

    function onListRatelimit() {
        msg.Send({
            type: "POST",
            url: "/api/ratelimit/list",
            dataType: "json",
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    var table = [];
                    $.each(data.Result, function (i, val) {
                        var rate = '<td><input class="txt-ratelimit-rate" type="text" value="' + val.Rate + '" readonly="readonly" /></td>';
                        var burst = '<td><input class="txt-ratelimit-burst" type="text" value="' + val.Burst + '" readonly="readonly" /></td>';
                        var lifespan = '<td><input class="txt-ratelimit-lifespan" type="text" value="' + parseInt(val.Lifespan) / 60 + '" readonly="readonly" /></td>';
                        var subnet = '<td><input class="txt-ratelimit-subnet" type="text" value="' + val.Subnet + '" readonly="readonly" /></td>';
                        var usergroup_option = '<td><select class="option-ratelimit-usergroup" disabled="disabled"><option value="none">Global</option><option value="group">Group</option><option value="user">Site</option></select></td>';
                        if (val.SiteID != null) {
                            usergroup_option = '<td><select class="option-ratelimit-usergroup" disabled="disabled"><option value="none">Global</option><option value="group">Group</option><option value="user" selected>Site</option></select></td>';
                        } else if (val.GroupID != null) {
                            usergroup_option = '<td><select class="option-ratelimit-usergroup" disabled="disabled"><option value="none">Global</option><option value="group" selected>Group</option><option value="user">Site</option></select></td>';
                        }
                        var usergroup = '<td><input class="txt-ratelimit-usergroup" type="text" value="" readonly="readonly"/></td>';
                        if (val.SiteID != null) {
                            usergroup = '<td><input class="txt-ratelimit-usergroup" type="text" value="' + val.Username + '" data-id="' + val.SiteID + '" readonly="readonly" /></td>';
                        } else if (val.GroupID != null) {
                            usergroup = '<td><input class="txt-ratelimit-usergroup" type="text" value="' + val.GroupName + '" data-id="' + val.GroupID + '" readonly="readonly" /></td>';
                        }
                        var priority = '<td>' + val.Priority + '</td>';
                        var action = '<td><i class="btn-ratelimit-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                            + '<i class="btn-ratelimit-save fas fa-save clickable" style="display:none" title="save"></i>'
                            + '<i class="btn-ratelimit-edit fas fa-cog clickable" title="edit"></i>'
                            + '<i class="btn-ratelimit-del fas fa-trash-alt clickable" title="delete"></i></td>';
                        var $block = $(createRow(val.ID, action, rate, burst, lifespan, subnet, usergroup_option, usergroup, priority));
                        onDeleteRatelimit($block);
                        onEditRatelimit($block);
                        onSaveRatelimit($block);
                        onCancelRatelimit($block);
                        table.push($block);
                    })
                    $('#tbody-ratelimit').html(table);
                    $('.option-ratelimit-usergroup').change(function () {
                        var target = $(this).closest('tr').find('.txt-ratelimit-usergroup')
                        target.val('').removeAttr('data-id');
                        if ($(this).val() == "user") {
                            target.attr('readonly', false);
                            setAutoComplete(target, autocomplete_user_data);
                        } else if ($(this).val() == "group") {
                            target.attr('readonly', false);
                            setAutoComplete(target, autocomplete_group_data);
                        } else {
                            target.attr('readonly', true);
                        }
                    });
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }

    function onAddRatelimit() {
        $('#btn-add_ratelimit').click(function () {
            var rate = '<td><input class="txt-ratelimit-rate" type="text" value="" /></td>';
            var burst = '<td><input class="txt-ratelimit-burst" type="text" value="" /></td>';
            var lifespan = '<td><input class="txt-ratelimit-lifespan" type="text" value="" /></td>';
            var subnet = '<td><input class="txt-ratelimit-subnet" type="text" value="" placeholder="0.0.0.0/0" /></td>';
            var usergroup_option = '<td><select class="option-ratelimit-usergroup"><option value="none">Global</option><option value="group">Group</option><option value="user">Site</option></select></td>';
            var usergroup = '<td><input class="txt-ratelimit-usergroup" type="text" value="" /></td>';
            var priority = '<td></td>';
            var action = '<td><i class="btn-ratelimit-cancel fas fa-times clickable" title="cancel"></i>'
                + '<i class="btn-ratelimit-save fas fa-save clickable" title="svae"></i>'
                + '<i class="btn-ratelimit-edit fas fa-cog clickable" style="display:none" title="edit"></i>'
                + '<i class="btn-ratelimit-del fas fa-trash-alt clickable" title="delete"></i></td>';
            var $block = $(createRow(null, action, rate, burst, lifespan, subnet, usergroup_option, usergroup, priority))
            onDeleteRatelimit($block);
            onSaveRatelimit($block);
            onEditRatelimit($block);
            onCancelRatelimit($block);
            $('#tbody-ratelimit').prepend($block);
            $block.find('.option-ratelimit-usergroup').change(function () {
                var target = $(this).closest('tr').find('.txt-ratelimit-usergroup')
                target.val('').removeAttr('data-id');
                if ($(this).val() == "user") {
                    target.attr('readonly', false);
                    setAutoComplete(target, autocomplete_user_data);
                } else if ($(this).val() == "group") {
                    target.attr('readonly', false);
                    setAutoComplete(target, autocomplete_group_data);
                } else {
                    target.attr('readonly', true);
                }
            });
            $block.find('.txt-ratelimit-usergroup').each(function () {
                setAutoComplete(this, autocomplete_user_data);
            })
        })
    }

    function onDeleteRatelimit(elem) {
        elem.find('.btn-ratelimit-del').click(function () {
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                elem.remove();
                return;
            }
            var subnet = elem.find('.txt-ratelimit-subnet').val();
            var confirmed = confirm("delete rule for " + subnet + "?");
            if (confirmed == false) {
                return;
            }
            var id = parseInt(id);
            msg.Send({
                type: "POST",
                url: "/api/ratelimit/delete",
                dataType: "json",
                timeout: 10000,
                data: { id: id },
                success: function (data) {
                    elem.remove();
                    onListRatelimit();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onSaveRatelimit(elem) {
        elem.find('.btn-ratelimit-save').click(function () {
            var $btn_save = $(this);
            var url = "";
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                url = "/api/ratelimit/add";
            } else {
                url = "/api/ratelimit/edit";
            }
            id = parseInt(id);
            
            var subnet = elem.find('.txt-ratelimit-subnet').val();
            subnet = $.trim(subnet);
            if (!Utils.String.ValidSubnet(subnet)) {
                alert("invalid subnet string")
                return
            }
            
            var lifespan = parseInt(elem.find('.txt-ratelimit-lifespan').val()) * 60;
            var rate = parseInt(elem.find('.txt-ratelimit-rate').val());
            var burst = parseInt(elem.find('.txt-ratelimit-burst').val());
            var $usergroup = elem.find('.txt-ratelimit-usergroup');
            var usergroup = $.trim($usergroup.val());
            var usergroupId = parseInt($usergroup.attr('data-id'));
            var usergroupCategory = elem.find('.option-ratelimit-usergroup').val();
            var data = { id: id, rate: rate, burst: burst, subnet: subnet, lifespan: lifespan };
            if (usergroup != "" && !isNaN(usergroupId)) {
                if (usergroupCategory == "user") {
                    data.SiteID = usergroupId;
                } else if (usergroupCategory == "group") {
                    data.GroupID = usergroupId;
                }
            }
            
            msg.Send({
                type: "POST",
                url: url,
                dataType: "json",
                timeout: 10000,
                data: data,
                success: function (data) {
                    elem.find('input[type="text"]').attr('readonly', true).removeAttr('data-val');
                    elem.find('.btn-ratelimit-save').hide();
                    elem.find('.btn-ratelimit-cancel').hide();
                    elem.find('.btn-ratelimit-edit').show();
                    if (url == "/api/ratelimit/add") {
                        elem.attr('data-id', data.Result)
                    }
                    $btn_save.hide();
                    onListRatelimit();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onEditRatelimit(elem) {
        elem.find('.btn-ratelimit-edit').click(function () {
            var id = elem.attr('data-id');
            elem.find('input[type="text"]').attr('readonly', false).each(function () {
                $(this).attr('data-val', $(this).val());

                var data_id = $(this).attr('data-id');
                if (typeof (data_id) == "undefined") {
                    data_id = "";
                }
                $(this).attr('data-id-old', data_id);
            });
            elem.find('.option-ratelimit-usergroup').prop('disabled', false).each(function () {
                $(this).attr('data-val-old', $(this).val());
                var text = $(this).closest('tr').find('.txt-ratelimit-usergroup')
                if ($(this).val() == "none") {
                    text.attr('readonly', true);
                } else if ($(this).val() == "user") {
                    text.attr('readonly', false);
                    setAutoComplete(text, autocomplete_user_data);
                } else if ($(this).val() == "group") {
                    text.attr('readonly', false);
                    setAutoComplete(text, autocomplete_group_data);
                }
            })
            $(this).hide();
            elem.find('.btn-ratelimit-save').show();
            elem.find('.btn-ratelimit-cancel').show();
        })
    }

    function onCancelRatelimit(elem) {
        elem.find('.btn-ratelimit-cancel').click(function () {
            
            if (elem.attr('data-id') == null) {
                elem.remove();
                return;
            }
            
            elem.find('input[type="text"]').each(function () {
                $(this).val($(this).attr('data-val'));
                $(this).attr('data-id', $(this).attr('data-id-old'));
                $(this).attr('data-category', $(this).attr('data-category-old'));
            }).removeAttr('data-val').attr('readonly', true).removeAttr('data-id-old');
            elem.find('select').each(function () {
                $(this).val($(this).attr('data-val-old'));
            }).removeAttr('data-val-old').prop('disabled', true)
            elem.find('.btn-ratelimit-save').hide();
            elem.find('.btn-ratelimit-cancel').hide();
            elem.find('.btn-ratelimit-edit').show();
        })
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_cache').click(function () {
            menuClick($(this));
            onListCache()
        })

        onAddCache();

        $('#btn-search_cache').click(function () {
            var keyword = $.trim($('#txt_search_cache').val());
            onSearchCache(keyword);
        })

        $('#txt_search_cache').on('keyup', function (e) {
            if (e.keyCode == 13) {
                var keyword = $.trim($(this).val());
                onSearchCache(keyword);
            }
        });
    })

    function onSearchCache(keyword) {
        if (keyword.length == 0) {
            onListCache();
        } else {
            onListCache({ keyword: keyword });
        }
    }

    function onListCache(data) {
        msg.Send({
            type: "POST",
            url: "/api/cache/list",
            data: data,
            dataType: "json",
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    var table = [];
                    $.each(data.Result, function (i, val) {
                        var key = '<td><input class="txt-cache-key" type="text" value="' + val.Key + '" readonly="readonly" placeholder="domain name" /></td>';
                        var exp = '<td><input class="txt-cache-exp" type="text" value="' + parseInt(val.Expiration) / 60 + '" readonly="readonly" placeholder="0=disable" /></td>';
                        var action = '<td><i class="btn-cache-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                            + '<i class="btn-cache-save fas fa-save clickable" style="display:none" title="save"></i>'
                            + '<i class="btn-cache-edit fas fa-cog clickable" title="edit"></i>'
                            + '<i class="btn-cache-del fas fa-trash-alt clickable" title="delete"></i></td>';
                        var $block = $(createRow(val.ID, action, key, exp));
                        onDeleteCache($block);
                        onEditCache($block);
                        onSaveCache($block);
                        onCancelCache($block);
                        table.push($block);
                    })
                    $('#tbody-cache').html(table);
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }

    function onAddCache() {
        $('#btn-add_cache').click(function () {
            var rand_password = Utils.Random.Hex(8);
            var key = '<td><input class="txt-cache-key" type="text" value="" placeholder="file extension name" /></td>';
            var exp = '<td><input class="txt-cache-exp" type="text" value="1" placeholder="expire in minutes" /></td>';
            var action = '<td><i class="btn-cache-cancel fas fa-times clickable" title="cancel"></i>'
                + '<i class="btn-cache-save fas fa-save clickable" title="save"></i>'
                + '<i class="btn-cache-edit fas fa-cog clickable" style="display:none" title="edit"></i>'
                + '<i class="btn-cache-del fas fa-trash-alt clickable" title="delete"></i></td>';
            var $block = $(createRow(null, action, key, exp));
            onDeleteCache($block);
            onSaveCache($block);
            onEditCache($block);
            onCancelCache($block);
            $('#tbody-cache').prepend($block);
        })
    }

    function onDeleteCache(elem) {
        elem.find('.btn-cache-del').click(function () {
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                elem.remove();
                return;
            }
            var key = elem.find('.txt-cache-key').val();
            var confirmed = confirm("delete " + key + "?");
            if (confirmed == false) {
                return;
            }
            var id = parseInt(id);
            msg.Send({
                type: "POST",
                url: "/api/cache/delete",
                dataType: "json",
                timeout: 10000,
                data: { id: id },
                success: function (data) {
                    elem.remove();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onSaveCache(elem) {
        elem.find('.btn-cache-save').click(function () {
            var $btn_save = $(this);
            var url = "";
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                url = "/api/cache/add";
            } else {
                url = "/api/cache/edit";
            }
            id = parseInt(id);
            
            var key = elem.find('.txt-cache-key').val();
            key = $.trim(key);
            if (key.length == 0) {
                alert("extension cannot be empty");
                return;
            }
            key = key.toLowerCase();
            
            var exp = elem.find('.txt-cache-exp').val();
            exp = $.trim(exp);
            if (exp.length == 0) {
                alert("expiration cannot be empty");
                return;
            }
            exp = parseInt(exp)
            elem.find('.txt-cache-exp').val(exp);
            
            msg.Send({
                type: "POST",
                url: url,
                dataType: "json",
                timeout: 10000,
                data: { id: id, key: key, expiration: exp * 60 },
                success: function (data) {
                    elem.find('input[type="text"]').attr('readonly', true).removeAttr('data-val');
                    elem.find('.btn-cache-save').hide();
                    elem.find('.btn-cache-cancel').hide();
                    elem.find('.btn-cache-edit').show();
                    if (url == "/api/cache/add") {
                        elem.attr('data-id', data.Result)
                    }
                    $btn_save.hide();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onEditCache(elem) {
        elem.find('.btn-cache-edit').click(function () {
            var id = elem.attr('data-id');
            elem.find('input[type="text"]').attr('readonly', false).each(function () {
                $(this).attr('data-val', $(this).val());
            });
            $(this).hide();
            elem.find('.btn-cache-save').show();
            elem.find('.btn-cache-cancel').show();
        })
    }

    function onCancelCache(elem) {
        elem.find('.btn-cache-cancel').click(function () {
            
            if (elem.attr('data-id') == null) {
                elem.remove();
                return;
            }
            
            elem.find('input[type="text"]').each(function () {
                $(this).val($(this).attr('data-val'));
            }).removeAttr('data-val').attr('readonly', true);
            elem.find('.btn-cache-save').hide();
            elem.find('.btn-cache-cancel').hide();
            elem.find('.btn-cache-edit').show();
        })
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_proxy-memory').click(function () {
            menuClick($(this));
            ProxyMemSetting.onList();
        })
    })

    var ProxyMemSetting = {
        onList: function () {
            msg.Send({
                type: "POST",
                url: "/api/proxyAdvanced/list",
                dataType: "json",
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var table = [];
                        $.each(data.Result, function (i, val) {
                            var proxy_name = '<td>' + val.ProxyName + '</td>'
                            
                            var max_percent_options = '';
                            for (i = 5; i <= 100; i = i + 5) {
                                var selected = '';
                                if (val.MaxPercent == i) {
                                    selected = 'selected';
                                }
                                max_percent_options += '<option value="' + i + '"' + selected + '>' + i + '%</option>';
                            }
                            var max_percent = '<td><select class="sel_proxy_memory_limit" disabled="disabled">' + max_percent_options + '</select></td>';
                            var max_mb = '<td><span class="txt-proxy-memory-max-mb">' + parseInt(val.TotalMem * val.MaxPercent / 100) + ' MB</span></td>';
                            var free_mb = '<span class="txt-proxy-memory-free-mb">' + val.FreeMem + '</span>';
                            var total_mb = '<span class="txt-proxy-memory-total-mb">' + val.TotalMem + ' MB</span>';
                            var max_mb_limit = '<td>' + (val.TotalMem - val.FreeMem) + " / " + total_mb + '</td>';
                            var action = '<td><i class="btn-proxy-memory-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                                + '<i class="btn-proxy-memory-save fas fa-save clickable" style="display:none" title="save"></i>'
                                + '<i class="btn-proxy-memory-edit fas fa-cog clickable" title="edit"></i></td>';
                            var $block = $(createRow(val.ID, action, proxy_name, max_percent, max_mb, max_mb_limit));
                            ProxyMemSetting.onEdit($block);
                            ProxyMemSetting.onSave($block);
                            ProxyMemSetting.onCancel($block);
                            ProxyMemSetting.onChange($block);
                            table.push($block);
                        })
                        $('#tbody-proxy-memory').html(table);
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        onSave: function (elem) {
            elem.find('.btn-proxy-memory-save').click(function () {
                var $btn_save = $(this);
                var url = "";
                var id = elem.attr('data-id');
                id = parseInt(id);
                
                var max_mb = parseInt(elem.find('.txt-proxy-memory-max-mb').val());
                var max_percent = parseInt(elem.find('.sel_proxy_memory_limit').val());
                
                msg.Send({
                    type: "POST",
                    url: "/api/proxyAdvanced/edit",
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id, max_mb: max_mb, max_percent: max_percent },
                    success: function (data) {
                        elem.find('input[type="text"]').attr('readonly', true).removeAttr('data-val');
                        elem.find('.btn-proxy-memory-save').hide();
                        elem.find('.btn-proxy-memory-cancel').hide();
                        elem.find('.btn-proxy-memory-edit').show();
                        elem.find('.sel_proxy_memory_limit').attr('disabled', true);
                        $btn_save.hide();
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
        onChange: function (elem) {
            elem.find('.sel_proxy_memory_limit').change(function () {
                var total_mb = parseInt(elem.find('.txt-proxy-memory-total-mb').html());
                var percentage = parseInt($(this).val());
                elem.find('.txt-proxy-memory-max-mb').html(parseInt(total_mb * percentage / 100) + ' MB');
            })
        },
        onEdit: function (elem) {
            elem.find('.btn-proxy-memory-edit').click(function () {
                var id = elem.attr('data-id');
                elem.find('.sel_proxy_memory_limit').attr('disabled', false).each(function () {
                    $(this).attr('data-val', $(this).val());
                });
                elem.find('.txt-proxy-memory-max-mb').each(function () {
                    $(this).attr('data-val', $(this).html());
                })
                $(this).hide();
                elem.find('.btn-proxy-memory-save').show();
                elem.find('.btn-proxy-memory-cancel').show();
            })
        },
        onCancel: function (elem) {
            elem.find('.btn-proxy-memory-cancel').click(function () {
                elem.find('.sel_proxy_memory_limit').each(function () {
                    $(this).val($(this).attr('data-val'));
                }).removeAttr('data-val').attr('disabled', true);
                elem.find('.txt-proxy-memory-max-mb').each(function () {
                    $(this).html($(this).attr('data-val'));
                }).removeAttr('data-val');
                elem.find('.btn-proxy-memory-save').hide();
                elem.find('.btn-proxy-memory-cancel').hide();
                elem.find('.btn-proxy-memory-edit').show();
            })
        }
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_cp-entrypoint').click(function () {
            menuClick($(this));
            onListCpEntryPoint();
        })

        onAddCpEntryPoint();

        $('#btn-search_cp_entrypoint').click(function () {
            var keyword = $.trim($('#txt_search_cp_entrypoint').val());
            onSearchCache(keyword);
        })

        $('#txt_search_cp_entrypoint').on('keyup', function (e) {
            if (e.keyCode == 13) {
                var keyword = $.trim($(this).val());
                onSearchCpEntryPoint(keyword);
            }
        });
    })

    function onSearchCpEntryPoint(keyword) {
        if (keyword.length == 0) {
            onListCpEntryPoint();
        } else {
            onListCpEntryPoint({ keyword: keyword });
        }
    }

    function onListCpEntryPoint(data) {
        msg.Send({
            type: "POST",
            url: "/api/cpEntrypoint/list",
            data: data,
            dataType: "json",
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    var table = [];
                    $.each(data.Result, function (i, val) {
                        var hostname = '<td><input class="txt-cp_entrypoint-hostname" type="text" value="' + val.Hostname + '" readonly="readonly" /></td>';
                        var mode = '<td><select class="list-cp_entrypoint-mode" disabled="disabled"><option value="1">Site Panel</option><option value="2" selected>Admin Panel</option></select></td>';
                        if (val.Mode == "1") {
                            mode = '<td><select disabled="disabled"><option value="1" selected>Site Panel</option><option value="2">Admin Panel</option></select></td>';
                        }
                        var action = '<td><i class="btn-cp_entrypoint-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                            + '<i class="btn-cp_entrypoint-save fas fa-save clickable" style="display:none" title="save"></i>'
                            + '<i class="btn-cp_entrypoint-edit fas fa-cog clickable" title="edit"></i>'
                            + '<i class="btn-cp_entrypoint-del fas fa-trash-alt clickable" title="delete"></i></td>';
                        var $block = $(createRow(val.ID, action, hostname + mode));
                        onDeleteCpEntryPoint($block);
                        onEditCpEntryPoint($block);
                        onSaveCpEntryPoint($block);
                        onCancelCpEntryPoint($block);
                        table.push($block);
                    })
                    $('#tbody-cp_entrypoint').html(table);
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }

    function onAddCpEntryPoint() {
        $('#btn-add_cp_entrypoint').click(function () {
            var hostname = '<td><input class="txt-cp_entrypoint-hostname" type="text"/></td>';
            var mode = '<td><select class="list-cp_entrypoint-mode"><option value="1" selected>Site Panel</option><option value="2">Admin Panel</option></select></td>';
            var action = '<td><i class="btn-cp_entrypoint-cancel fas fa-times clickable" title="cancel"></i>'
                + '<i class="btn-cp_entrypoint-save fas fa-save clickable" title="save"></i>'
                + '<i class="btn-cp_entrypoint-edit fas fa-cog clickable" style="display:none" title="edit"></i>'
                + '<i class="btn-cp_entrypoint-del fas fa-trash-alt clickable" title="delete"></i></td>';
            var $block = $(createRow(null, action, hostname + mode));
            onDeleteCpEntryPoint($block);
            onSaveCpEntryPoint($block);
            onEditCpEntryPoint($block);
            onCancelCpEntryPoint($block);
            $('#tbody-cp_entrypoint').prepend($block);
        })
    }

    function onDeleteCpEntryPoint(elem) {
        elem.find('.btn-cp_entrypoint-del').click(function () {
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                elem.remove();
                return;
            }
            var hostname = elem.find('.txt-cp_entrypoint-hostname').val();
            var confirmed = confirm("delete " + hostname + "?");
            if (confirmed == false) {
                return;
            }
            var id = parseInt(id);
            msg.Send({
                type: "POST",
                url: "/api/cpEntrypoint/delete",
                dataType: "json",
                timeout: 10000,
                data: { id: id },
                success: function (data) {
                    elem.remove();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onSaveCpEntryPoint(elem) {
        elem.find('.btn-cp_entrypoint-save').click(function () {
            var $btn_save = $(this);
            var url = "";
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                url = "/api/cpEntrypoint/add";
            } else {
                url = "/api/cpEntrypoint/edit";
            }
            id = parseInt(id);
            
            var hostname = elem.find('.txt-cp_entrypoint-hostname').val();
            var mode = parseInt(elem.find('.list-cp_entrypoint-mode').val());
            
            msg.Send({
                type: "POST",
                url: url,
                dataType: "json",
                timeout: 10000,
                data: { id: id, hostname: hostname, mode: mode },
                success: function (data) {
                    elem.find('input[type="text"]').attr('readonly', true).removeAttr('data-val');
                    elem.find('.btn-cp_entrypoint-save').hide();
                    elem.find('.btn-cp_entrypoint-cancel').hide();
                    elem.find('.btn-cp_entrypoint-edit').show();
                    elem.find('select').attr('disabled', true);
                    if (url == "/api/cpEntrypoint/add") {
                        elem.attr('data-id', data.Result)
                    }
                    $btn_save.hide();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onEditCpEntryPoint(elem) {
        elem.find('.btn-cp_entrypoint-edit').click(function () {
            var id = elem.attr('data-id');
            elem.find('input[type="text"]').attr('readonly', false).each(function () {
                $(this).attr('data-val', $(this).val());
            });
            elem.find('select').attr('disabled', false).each(function () {
                $(this).attr('data-val', $(this).val());
            });
            $(this).hide();
            elem.find('.btn-cp_entrypoint-save').show();
            elem.find('.btn-cp_entrypoint-cancel').show();
        })
    }

    function onCancelCpEntryPoint(elem) {
        elem.find('.btn-cp_entrypoint-cancel').click(function () {
            
            if (elem.attr('data-id') == null) {
                elem.remove();
                return;
            }
            
            elem.find('input[type="text"]').each(function () {
                $(this).val($(this).attr('data-val'));
            }).removeAttr('data-val').attr('readonly', true);
            elem.find('select').each(function () {
                $(this).val($(this).attr('data-val'));
            }).removeAttr('data-val').attr('disabled', true);
            elem.find('.btn-cp_entrypoint-save').hide();
            elem.find('.btn-cp_entrypoint-cancel').hide();
            elem.find('.btn-cp_entrypoint-edit').show();
        })
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_account-group').click(function () {
            menuClick($(this));
            AccountGroup.onListAccountGroup();
        })

        AccountGroup.onAddAccountGroup();

        $('#btn-search_account-group').click(function () {
            var keyword = $.trim($('#txt_search_account-group').val());
            AccountGroup.onSearchAccountGroup(keyword);
        })

        $('#txt_search_account-group').on('keyup', function (e) {
            if (e.keyCode == 13) {
                var keyword = $.trim($(this).val());
                AccountGroup.onSearchAccountGroup(keyword);
            }
        });
    })

    var AccountGroup = {
        onSearchAccountGroup: function (keyword) {
            if (keyword.length == 0) {
                AccountGroup.onListAccountGroup();
            } else {
                AccountGroup.onListAccountGroup({ keyword: keyword });
            }
        },

        onSaveLogin: function (elem) {
            elem.find('.btn-account-group_password').unbind('click').click(function () {
                var pos = $(this).position();
                var form = $(this).parent().find('.form_change_account_password');
                if (form.length > 0) {
                    form.remove('.form_change_account_password');
                } else {
                    $(this).parent().append(Account.loginForm);
                }
                Account.loginForm.find('.close_change_account_password').click(function () {
                    Account.loginForm.remove();
                })
                Account.loginForm.find('.txt_change_account_username').val(elem.find('.txt-account-group-name').val());
                Account.loginForm.find('.txt_change_account_password').val('********');
                Account.loginForm.find('.txt_change_account_confirm_password').val('');
                Account.loginForm.find('.txt_change_account_email').val(elem.attr('data-email'));
                Account.loginForm.find('.warning_change_account_password').html("");
                
                Account.loginForm.find('.btn_change_account_password').click(function () {
                    Account.loginForm.find('.warning_change_account_password').html("");
                    var id = parseInt(elem.attr('data-id'));
                    var password = $.trim(Account.loginForm.find('.txt_change_account_password').val());
                    if (password == "********") {
                        password = null;
                    }
                    confirm_password = $.trim(Account.loginForm.find('.txt_change_account_confirm_password').val());
                    if (password != confirm_password) {
                        alert('confirm password is not same');
                        return;
                    }
                    var email = $.trim(Account.loginForm.find('.txt_change_account_email').val());
                    msg.Send({
                        type: "POST",
                        url: "/api/accountGroup/setLogin",
                        dataType: "json",
                        timeout: 10000,
                        data: { id: id, password: password, email: email },
                        success: function (data) {
                            if (data.ErrCode == 0) {
                                elem.attr('data-email', email);
                                Account.loginForm.find('.warning_change_account_password').css("color", "green").html("success");
                            } else {
                                Account.loginForm.find('.warning_change_account_password').css("color", "red").html(data.ErrText);
                            }
                        },
                        error: function (xhr, status, error) {
                            alert(error);
                            if (xhr.status == 401) {
                                location.href = "/";
                            }
                        }
                    })
                })
            });
        },

        onListAccountGroup: function (data) {
            msg.Send({
                type: "POST",
                url: "/api/accountGroup/list",
                data: data,
                dataType: "json",
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var table = [];
                        $.each(data.Result, function (i, val) {
                            var name = '<td><input class="txt-account-group-name" type="text" value="' + val.Name + '" readonly="readonly" /></td>';
                            var action = '<td><i class="btn-account-group-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                                + '<i class="btn-account-group-save fas fa-save clickable" style="display:none" title="save"></i>'
                                + '<i class="btn-account-group-edit fas fa-cog clickable" title="edit"></i>'
                                + '<i class="btn-account-group_password fas fa-key clickable" title="password"></i>'
                                + '<i class="btn-account-group-del fas fa-trash-alt clickable" title="delete"></i></td>';
                            var $block = $(createRow({ "id": val.ID, 'email': val.Email }, action, name));
                            AccountGroup.onDeleteAccountGroup($block);
                            AccountGroup.onEditAccountGroup($block);
                            AccountGroup.onSaveAccountGroup($block);
                            AccountGroup.onCancelAccountGroup($block);
                            AccountGroup.onSaveLogin($block);
                            table.push($block);
                        })
                        $('#tbody-account-group').html(table);
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },

        onAddAccountGroup: function () {
            $('#btn-add_account-group').click(function () {
                var name = '<td><input class="txt-account-group-name" type="text" value="" /></td>';
                var action = '<td><i class="btn-account-group-cancel fas fa-times clickable" title="cancel"></i>'
                    + '<i class="btn-account-group-save fas fa-save clickable" title="save"></i>'
                    + '<i class="btn-account-group-edit fas fa-cog clickable" style="display:none" title="edit"></i>'
                    + '<i class="btn-account-group_password fas fa-key clickable" title="password" style="display:none"></i>'
                    + '<i class="btn-account-group-del fas fa-trash-alt clickable" title="delete"></i></td>';
                var $block = $(createRow(null, action, name));
                $block.attr('data-email', '');
                AccountGroup.onDeleteAccountGroup($block);
                AccountGroup.onSaveAccountGroup($block);
                AccountGroup.onEditAccountGroup($block);
                AccountGroup.onCancelAccountGroup($block);
                AccountGroup.onSaveLogin($block);
                $('#tbody-account-group').prepend($block);
            })
        },

        onDeleteAccountGroup: function (elem) {
            elem.find('.btn-account-group-del').click(function () {
                var id = elem.attr('data-id');
                if (typeof (id) == 'undefined') {
                    elem.remove();
                    return;
                }
                var key = elem.find('.txt-account-group-name').val();
                var confirmed = confirm("delete " + key + "?");
                if (confirmed == false) {
                    return;
                }
                var id = parseInt(id);
                msg.Send({
                    type: "POST",
                    url: "/api/accountGroup/delete",
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id },
                    success: function (data) {
                        elem.remove();
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },

        onSaveAccountGroup: function (elem) {
            elem.find('.btn-account-group-save').click(function () {
                var $btn_save = $(this);
                var url = "";
                var id = elem.attr('data-id');
                if (typeof (id) == 'undefined') {
                    url = "/api/accountGroup/add";
                } else {
                    url = "/api/accountGroup/edit";
                }
                id = parseInt(id);
                
                var name = elem.find('.txt-account-group-name').val();
                name = $.trim(name);
                if (name.length == 0) {
                    alert("group name cannot be empty");
                    return;
                }
                
                msg.Send({
                    type: "POST",
                    url: url,
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id, name: name },
                    success: function (data) {
                        elem.find('input[type="text"]').attr('readonly', true).removeAttr('data-val');
                        elem.find('.btn-account-group-save').hide();
                        elem.find('.btn-account-group-cancel').hide();
                        elem.find('.btn-account-group-edit').show();
                        elem.find('.btn-account-group_password').show();
                        if (url == "/api/accountGroup/add") {
                            elem.attr('data-id', data.Result)
                        }
                        $btn_save.hide();
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },

        onEditAccountGroup: function (elem) {
            elem.find('.btn-account-group-edit').click(function () {
                var id = elem.attr('data-id');
                elem.find('input[type="text"]').attr('readonly', false).each(function () {
                    $(this).attr('data-val', $(this).val());
                });
                $(this).hide();
                elem.find('.btn-account-group-save').show();
                elem.find('.btn-account-group-cancel').show();
                elem.find('.btn-account-group_password').hide();
            })
        },

        onCancelAccountGroup: function (elem) {
            elem.find('.btn-account-group-cancel').click(function () {
                
                if (elem.attr('data-id') == null) {
                    elem.remove();
                    return;
                }
                
                elem.find('input[type="text"]').each(function () {
                    $(this).val($(this).attr('data-val'));
                }).removeAttr('data-val').attr('readonly', true);
                elem.find('.btn-account-group-save').hide();
                elem.find('.btn-account-group-cancel').hide();
                elem.find('.btn-account-group-edit').show();
                elem.find('.btn-account-group_password').show();
            })
        },
    }
</script>


<script>
    $(document).ready(function () {
        Backend.Add();
        $('#btn-menu_backend').click(function () {
            menuClick($(this));
            Backend.List();
        })
    })

    var Backend = {
        API_URL: "/api/backend",
        List: function (pageNum = 1, pageSize = 20) {
            data = {
                pageSize: pageSize,
                pageNum: pageNum,
            };
            msg.Send({
                type: "POST",
                url: Backend.API_URL + "/list",
                dataType: "json",
                data: data,
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var table = [];
                        var count = data.Result.Count[0];
                        $.each(data.Result.Backends, function (i, val) {
                            color = Utils.Colors.Grey;
                            var LastUpdateLabel = '';
                            last_update_txt = "";
                            if (val.LastUpdate != null) {
                                
                                last_update_txt = Utils.Datetime.LastActiveB(val.LastUpdate, val.ServerTime);
                                if (val.LastHealthCheck != null && Utils.Datetime.Before(val.LastUpdate, val.LastHealthCheck)) {
                                    val.Status = val.HealthCheckStatus
                                }
                                if (val.Status > 0) {
                                    var time_difference = Utils.Datetime.Difference(val.LastUpdate, val.ServerTime)
                                    if (time_difference <= 60 * 5) {
                                        color = Utils.Colors.LightGreen;
                                    } else if (time_difference <= 3600) {
                                        color = Utils.Colors.DeepGreen;
                                    } else if (time_difference <= 3600 * 24) {
                                        color = Utils.Colors.LightBlue;
                                    } else if (time_difference > 3600 * 24) {
                                        color = Utils.Colors.DeepBlue;
                                    }
                                }
                                if (val.Status == 0) {
                                    color = Utils.Colors.Red;
                                    LastUpdateLabel = 'title="Down since ' + last_update_txt + '"';
                                } else {
                                    LastUpdateLabel = 'title="Last active ' + last_update_txt + '"';
                                }
                            } else {
                                LastUpdateLabel = 'title="Never active"';
                            }
                            var status = '<td><i style="color:' + color + '" class="dboard-status material-icons" ' + LastUpdateLabel + '>fiber_manual_record</i></td>';
                            var name = '<td><input class="txt-backend-name" type="text" value="' + val.Name + '" readonly="readonly" placeholder="name" /></td>';
                            var addr = '<td><input class="txt-backend-addr" type="text" value="' + val.Addr + '" readonly="readonly" placeholder="address" /></td>';
                            https_checked = val.HTTPS == 1 ? 'checked' : '';
                            var https = '<td><input class="chk-backend-https" type="checkbox" disabled ' + https_checked + '></td>';
                            
                            
                            
                            
                            var rpm = '<td>' + (new Intl.NumberFormat().format(val.TotalRPM)) + '</td>';
                            var srate = "";
                            if (val.TotalRPM > 0) {
                                srate = ((val.TotalRPM - val.FailedRPM) / val.TotalRPM * 100).toFixed(2) + "%";
                            }
                            var successRate = '<td>' + srate + '</td>';
                            var lastActive = '<td>' + last_update_txt + '</td>';
                            var action = '<td><i class="btn-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                                + '<i class="btn-save fas fa-save clickable" style="display:none" title="save"></i>'
                                + '<i class="btn-edit fas fa-cog clickable" title="edit"></i>'
                                + '<i class="btn-maintenance fas fa-exclamation-triangle clickable head-action" title="maintenance"></i>'
                                + '<i class="btn-del fas fa-trash-alt clickable" title="delete"></i></td>';
                            var $block = $(createRow(val.ID, action, status, name, addr, https, rpm, successRate, lastActive));
                            if (val.Maintenance) {
                                $block.addClass("maintenance");
                            }
                            Backend.Delete($block, $block.find('.txt-backend-name'));
                            Backend.Edit($block);
                            Backend.Save($block, { name: '.txt-backend-name', addr: '.txt-backend-addr', https: '.chk-backend-https' });
                            Backend.Cancel($block);
                            Backend.Maintenance($block);
                            
                            table.push($block);
                        })
                        $('#tbody-backend').html(table);
                        
                        if (count > 0) {
                            Utils.UI.Paging($('#tfoot-backend'), pageNum, count, pageSize, Backend.List);
                        }
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        Add: function () {
            $('#btn-add_backend').click(function () {
                var status = '<td><i style="color:grey" class="dboard-status material-icons">fiber_manual_record</i></td>';
                var name = '<td><input class="txt-backend-name" type="text" value="" placeholder="name" /></td>';
                var addr = '<td><input class="txt-backend-addr" type="text" value="" placeholder="address" /></td>';
                var https = '<td><input class="chk-backend-https" type="checkbox"></td>';
                
                var rpm = '<td>0</td>';
                var successRate = '<td></td>';
                var lastActive = '<td></td>';
                var action = '<td><i class="btn-cancel fas fa-times clickable" title="cancel"></i>'
                    + '<i class="btn-save fas fa-save clickable" title="save"></i>'
                    + '<i class="btn-edit fas fa-cog clickable" style="display:none" title="edit"></i>'
                    + '<i class="btn-maintenance fas fa-exclamation-triangle clickable head-action" title="maintenance" style="display:none"></i>'
                    + '<i class="btn-del fas fa-trash-alt clickable" title="delete"></i></td>';
                var $block = $(createRow(null, action, status, name, addr, https, rpm, successRate, lastActive));
                Backend.Delete($block, $block.find('.txt-backend-name'));
                Backend.Edit($block);
                Backend.Save($block, { name: '.txt-backend-name', addr: '.txt-backend-addr', https: '.chk-backend-https' }, Backend.API_URL);
                Backend.Cancel($block);
                Backend.Maintenance($block);
                $('#tbody-backend').prepend($block);
            })
        },
        Delete: function (elem, confirm_on_elem) {
            elem.find('.btn-del').click(function () {
                var id = elem.attr('data-id');
                
                if (typeof (id) == 'undefined') {
                    elem.remove();
                    return;
                }
                
                var id = parseInt(id);
                if (isNaN(id)) {
                    alert("invalid id");
                    return;
                }
                
                var confirmed = confirm("delete " + confirm_on_elem.val() + "?");
                if (confirmed == false) {
                    return;
                }
                
                msg.Send({
                    type: "POST",
                    url: Backend.API_URL + "/delete",
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id },
                    success: function (data) {
                        elem.remove();
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
        Save: function (elem, dataElem) {
            elem.find('.btn-save').click(function () {
                
                var input = new Object();
                for (var key in dataElem) {
                    if (dataElem.hasOwnProperty(key)) {
                        var val = dataElem[key];
                        if (val.startsWith(".chk")) {
                            input[key] = elem.find(val).prop('checked');
                        } else {
                            input[key] = $.trim(elem.find(val).val());
                        }
                    }
                }
                if (!Utils.String.CheckName(input["name"])) {
                    alert("invalid name (a-z 0-9 - . @)");
                    return;
                }
                
                var id = elem.attr('data-id');
                var action = ";"
                if (typeof (id) == 'undefined') {
                    action = "/add";
                } else {
                    action = "/edit";
                    var id = parseInt(id);
                    if (isNaN(id)) {
                        alert("invalid id");
                        return; x
                    }
                    input.id = id;
                }
                
                msg.Send({
                    type: "POST",
                    url: Backend.API_URL + action,
                    dataType: "json",
                    timeout: 10000,
                    data: input,
                    success: function (output) {
                        
                        if (action == "/add") {
                            elem.attr('data-id', output.Result);
                        }
                        
                        for (var key in dataElem) {
                            if (dataElem.hasOwnProperty(key)) {
                                var val = dataElem[key];
                                if (val.startsWith(".chk")) {
                                    elem.find(val).attr('disabled', true).removeAttr('data-val');
                                } else {
                                    elem.find(val).attr('readonly', true).removeAttr('data-val');
                                }
                            }
                        }
                        
                        elem.find('.btn-save').hide();
                        elem.find('.btn-cancel').hide();
                        elem.find('.btn-edit').show();
                        elem.find('.btn-maintenance').show();
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
        Edit: function (elem) {
            elem.find('.btn-edit').click(function () {
                var id = elem.attr('data-id');
                
                elem.find('input[type="text"]').attr('readonly', false).each(function () {
                    $(this).attr('data-val', $(this).val());
                });
                
                elem.find("select").removeAttr("disabled").each(function () {
                    $(this).attr('data-val', $(this).val());
                })
                
                elem.find('input[type="checkbox"]').each(function () {
                    $(this).attr('data-val', $(this).prop('checked')).removeAttr('disabled');
                });
                
                $(this).hide();
                elem.find('.btn-save').show();
                elem.find('.btn-del').show();
                elem.find('.btn-cancel').show();
            })
        },
        Cancel: function (elem) {
            elem.find('.btn-cancel').click(function () {
                
                if (elem.attr('data-id') == null) {
                    elem.remove();
                    return;
                }
                
                
                elem.find('input[type="text"]').each(function () {
                    $(this).val($(this).attr('data-val'));
                }).removeAttr('data-val').attr('readonly', true);
                
                elem.find('select').each(function () {
                    $(this).val($(this).attr('data-val'));
                }).removeAttr('data-val').attr('disabled', true);
                
                elem.find('input[type="checkbox"]').each(function () {
                    if ($(this).attr('data-val') == "true") {
                        $(this).prop('checked', true);
                    } else {
                        $(this).prop('checked', false);
                    }
                }).removeAttr('data-val').attr('disabled');
                
                $(this).hide()
                elem.find('.btn-save').hide();
                elem.find('.btn-del').show();
                elem.find('.btn-edit').show();
            })
        },
        Maintenance: function (elem) {
            elem.find('.btn-maintenance').click(function () {
                
                var id = elem.attr('data-id');
                if (typeof (id) == 'undefined') {
                    alert("unknown error: missing id");
                    return;
                }
                var id = parseInt(id);
                
                var maintenance = elem.hasClass('maintenance');
                
                var name = elem.find('.txt-backend-name').val();
                var text = "make " + name + " temporarily unavailable?";
                if (maintenance) {
                    text = "turn off maintenance mode for " + name + "?";
                }
                if (confirm(text) == false) {
                    return;
                }
                msg.Send({
                    type: "POST",
                    url: "/api/backend/maintenance",
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id, maintenance: !maintenance },
                    success: function (data) {
                        elem.toggleClass('maintenance', !maintenance)
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_admin-account').click(function () {
            menuClick($(this));
            onListAdminAccount();
        })

        onAddAdminAccount();
    })

    function onListAdminAccount() {
        msg.Send({
            type: "POST",
            url: "/api/adminAccount/list",
            data: data,
            dataType: "json",
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    var table = [];
                    $.each(data.Result, function (i, val) {
                        var username = '<td><input class="txt-admin_account-username" type="text" value="' + val.Username + '" readonly="readonly" /></td>';
                        var password = '<td><input class="txt-admin_account-password" type="text" value="********" readonly="readonly" /></td>';
                        var role = '<td><select class="list-admin_account-role" disabled="disabled"><option value="3">admin</option><option value="4" selected>viewer</option></select></td>';
                        if (val.Role == "3") {
                            role = '<td><select class="list-admin_account-role" disabled="disabled"><option value="3" selected>admin</option><option value="4">viewer</option><option value="5">editor</option></select></td>';
                        } else if (val.Role == "4") {
                            role = '<td><select class="list-admin_account-role" disabled="disabled"><option value="3">admin</option><option value="4" selected>viewer</option><option value="5">editor</option></select></td>';
                        } else if (val.Role == "5") {
                            role = '<td><select class="list-admin_account-role" disabled="disabled"><option value="3">admin</option><option value="4">viewer</option><option value="5" selected>editor</option></select></td>';
                        }

                        var enabled = '<td></td>';
                        var action = "<td></td>";
                        if (val.ID != global_data.uid) {
                            enabled = '<td><input type="checkbox" class="chk-admin_account-enabled" disabled/></td>';
                            if (val.Enabled == true) {
                                enabled = '<td><input type="checkbox" class="chk-admin_account-enabled" checked disabled/></td>';
                            }
                            action = '<td><i class="btn-admin_account-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                                + '<i class="btn-admin_account-save fas fa-save clickable" style="display:none" title="save"></i>'
                                + '<i class="btn-admin_account-edit fas fa-cog clickable" title="save"></i>'
                                + '<i class="btn-admin_account-del fas fa-trash-alt clickable" title="delete"></i></td>';
                        }
                        var block = createRow(val.ID, action, username, password, role, enabled);
                        var $block = $(block);
                        onDeleteAdminAccount($block);
                        onEditAdminAccount($block);
                        onSaveAdminAccount($block);
                        onCancelAdminAccount($block);
                        
                        table.push($block);
                    })
                    $('#tbody-admin_account').html(table);
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }

    function onAddAdminAccount() {
        $('#btn-add_admin-account').click(function () {
            var username = '<td><input class="txt-admin_account-username" type="text" value="" /></td>';
            var password = '<td><input class="txt-admin_account-password" type="text" value="" /></td>';
            var role = '<td><select class="list-admin_account-role"><option value="3" selected>admin</option><option value="4">viewer</option><option value="5">editor</option></select></select></td>';
            var enabled = '<td><input type="checkbox" class="chk-admin_account-enabled" checked/></td>';
            var action = '<td><i class="btn-admin_account-cancel fas fa-times clickable" title="cancel"></i>'
                + '<i class="btn-admin_account-save fas fa-save clickable" title="save"></i>'
                + '<i class="btn-admin_account-edit fas fa-cog clickable" style="display:none" title="edit"></i>'
                + '<i class="btn-admin_account-del fas fa-trash-alt clickable" title="delete"></i></td>';
            var block = createRow(null, action, username, password, role, enabled);
            var $block = $(block);
            onDeleteAdminAccount($block);
            onEditAdminAccount($block);
            onSaveAdminAccount($block);
            onCancelAdminAccount($block);
            
            $('#tbody-admin_account').prepend($block);
        })
    }

    function onDeleteAdminAccount(elem) {
        elem.find('.btn-admin_account-del').click(function () {
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                elem.remove();
                return;
            }
            var username = elem.find('.txt-admin_account-username').val();
            var confirmed = confirm("delete " + username + "?");
            if (confirmed == false) {
                return;
            }
            var id = parseInt(id);
            msg.Send({
                type: "POST",
                url: "/api/adminAccount/delete",
                dataType: "json",
                timeout: 10000,
                data: { id: id },
                success: function (data) {
                    if (data.ErrCode == 0) {
                        elem.remove();
                    } else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onSaveAdminAccount(elem) {
        elem.find('.btn-admin_account-save').click(function () {
            var $btn_save = $(this);
            var url = "";
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                url = "/api/adminAccount/add";
            } else {
                url = "/api/adminAccount/edit";
            }
            id = parseInt(id);
            
            var username = elem.find('.txt-admin_account-username').val();
            var password = elem.find('.txt-admin_account-password').val();
            if (password == "********") {
                password = null;
            }
            var role = parseInt(elem.find('.list-admin_account-role').val());
            var enabled = elem.find('.chk-admin_account-enabled').prop('checked');
            
            msg.Send({
                type: "POST",
                url: url,
                dataType: "json",
                timeout: 10000,
                data: { id: id, username: username, password: password, role: role, enabled: enabled },
                success: function (data) {
                    if (data.ErrCode == 0) {
                        elem.find('.txt-admin_account-password').val('********');
                        elem.find('input[type="text"]').attr('readonly', true).removeAttr('data-val');
                        elem.find('input[type="checkbox"]').attr('disabled', true).removeAttr('data-val');
                        elem.find('.btn-admin_account-save').hide();
                        elem.find('.btn-admin_account-cancel').hide();
                        elem.find('.btn-admin_account-edit').show();
                        elem.find('.list-admin_account-role').attr('disabled', true).removeAttr('data-val');
                        if (url == "/api/adminAccount/add") {
                            elem.attr('data-id', data.Result)
                        }
                        $btn_save.hide();
                    } else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    
    
    
    
    
    
    
    
    

    function onEditAdminAccount(elem) {
        elem.find('.btn-admin_account-edit').click(function () {
            var id = elem.attr('data-id');
            elem.find('input[type="text"]').attr('readonly', false).each(function () {
                $(this).attr('data-val', $(this).val());
            });
            elem.find('select').attr('disabled', false).each(function () {
                $(this).attr('data-val', $(this).val());
            });
            elem.find('input[type="checkbox"]').attr('disabled', false).each(function () {
                $(this).attr('data-val', $(this).prop("checked"));
            });
            elem.find('span').each(function () {
                $(this).attr('data-val', $(this).html());
            });
            $(this).hide();
            elem.find('.btn-admin_account-save').show();
            elem.find('.btn-admin_account-cancel').show();
        })
    }

    function onCancelAdminAccount(elem) {
        elem.find('.btn-admin_account-cancel').click(function () {
            
            if (elem.attr('data-id') == null) {
                elem.remove();
                return;
            }
            
            elem.find('input[type="text"]').each(function () {
                $(this).val($(this).attr('data-val'));
            }).removeAttr('data-val').attr('readonly', true);
            elem.find('select').each(function () {
                $(this).val($(this).attr('data-val'));
            }).removeAttr('data-val').attr('disabled', true);
            elem.find('input[type="checkbox"]').each(function () {
                $(this).prop('checked', $(this).attr('data-val') == 'true');
            }).removeAttr('data-val').attr('disabled', true);
            elem.find('span').each(function () {
                $(this).html($(this).attr('data-val'));
            });
            elem.find('.btn-admin_account-save').hide();
            elem.find('.btn-admin_account-cancel').hide();
            elem.find('.btn-admin_account-edit').show();
        })
    }
</script>


<script>
    $(document).ready(function () {
        Loadbalancer.Add();
        $('#btn-menu_loadbalancer').click(function () {
            menuClick($(this));
            Loadbalancer.List();
        })
    })

    var Loadbalancer = {
        API_URL: "/api/serverpool",
        List: function (pageNum = 1, pageSize = 20) {
            data = {
                pageSize: pageSize,
                pageNum: pageNum,
            };
            msg.Send({
                type: "POST",
                url: Loadbalancer.API_URL + "/list",
                dataType: "json",
                data: data,
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var table = [];
                        var count = data.Result.Count[0];
                        $.each(data.Result.ServerPools, function (i, val) {
                            color = Utils.Colors.Grey;
                            var LastUpdateLabel = '';
                            if (val.LastUpdate != null) {
                                if (val.BackendCount == 0) {
                                    color = Utils.Colors.Grey;
                                } else if (val.HealthBackendCount == val.BackendCount) {
                                    var time_difference = Utils.Datetime.DifferenceFromNow(val.LastUpdate);
                                    if (time_difference <= 60 * 5) {
                                        color = Utils.Colors.LightGreen;
                                    } else if (time_difference <= 3600) {
                                        color = Utils.Colors.DeepGreen;
                                    } else if (time_difference <= 3600 * 24) {
                                        color = Utils.Colors.LightBlue;
                                    } else if (time_difference > 3600 * 24) {
                                        color = Utils.Colors.DeepBlue;
                                    }
                                } else if (val.HealthBackendCount > 0) {
                                    color = Utils.Colors.Orange;
                                } else if (val.HealthBackendCount == 0) {
                                    color = Utils.Colors.Red;
                                }
                                title = Utils.Datetime.LastActive(val.LastUpdate);
                                unhealthyBackendCount = val.BackendCount - val.HealthBackendCount;
                                if (unhealthyBackendCount > 0) {
                                    if (unhealthyBackendCount == 1) {
                                        title += ' and ' + unhealthyBackendCount + ' backend down';
                                    } else {
                                        title += ' and ' + unhealthyBackendCount + ' backends down';
                                    }
                                }
                                LastUpdateLabel = 'title="Last active ' + title + '"';
                            } else {
                                LastUpdateLabel = 'title="Never active"';
                            }

                            var status = '<td><i style="color:' + color + '" class="dboard-status material-icons" ' + LastUpdateLabel + '>fiber_manual_record</i></td>';
                            var name = '<td><input class="txt-loadbalancer-name" type="text" value="' + val.Name + '" readonly="readonly" placeholder="name" /></td>';
                            var enabled = $.trim(val.StickySession) != "";
                            var ticked = enabled ? 'checked' : ''
                            var sticky_session = '<td><input type="checkbox" class="chk-loadbalancer-sticky-session-enable" ' + ticked + ' disabled/></td>';
                            var cookie_name = '<td><input class="txt-loadbalancer-sticky-session" type="text" value="' + val.StickySession + '" readonly="readonly" /></td>';
                            var health_check_path = '<td><input class="txt-loadbalancer-healthcheck-path" type="text" value="' + val.HealthCheckPath + '" readonly="readonly" placeholder="path" /></td>';
                            var action = '<td><i class="btn-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                                + '<i class="btn-save fas fa-save clickable" style="display:none" title="save"></i>'
                                + '<i class="btn-edit fas fa-cog clickable" title="edit"></i>'
                                + '<i class="btn-loadbalancer-backend_edit fas fa-server clickable" title="backends"></i>'
                                + '<i class="btn-maintenance fas fa-exclamation-triangle clickable head-action" title="maintenance"></i>'
                                + '<i class="btn-del fas fa-trash-alt clickable" title="delete"></i></td>';
                            var $block = $(createRow(val.ID, action, status, name, sticky_session, cookie_name, health_check_path));
                            if (val.Maintenance) {
                                $block.addClass("maintenance");
                            }
                            Loadbalancer.Delete($block, $block.find('.txt-loadbalancer-name'));
                            Loadbalancer.Edit($block);
                            Loadbalancer.Save($block, { name: '.txt-loadbalancer-name', enable_sticky_session: '.chk-loadbalancer-sticky-session-enable', sticky_session: '.txt-loadbalancer-sticky-session', health_check_path: '.txt-loadbalancer-healthcheck-path' });
                            Loadbalancer.Cancel($block);
                            Loadbalancer.DefaultWhenEmpty($block.find('.txt-loadbalancer-healthcheck-path'), "/");
                            Loadbalancer.OnBackendEdit($block, '.btn-loadbalancer-backend_edit', '.txt-loadbalancer-name');
                            Loadbalancer.OnEnableStickySession($block, '.chk-loadbalancer-sticky-session-enable', '.txt-loadbalancer-sticky-session');
                            Loadbalancer.Maintenance($block);
                            table.push($block);
                        })
                        $('#tbody-loadbalancer').html(table);
                        
                        if (count > 0) {
                            Utils.UI.Paging($('#tfoot-account'), pageNum, count, pageSize, Loadbalancer.List);
                        }
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        Add: function () {
            $('#btn-add_loadbalancer').click(function () {
                var status = '<td><i style="color:grey" class="dboard-status material-icons">fiber_manual_record</i></td>'
                var name = '<td><input class="txt-loadbalancer-name" type="text" value="" placeholder="name" /></td>';
                var sticky_session = '<td><input type="checkbox" class="chk-loadbalancer-sticky-session-enable" checked/></td>';
                var cookie_name = '<td><input class="txt-loadbalancer-sticky-session" type="text" value="BPX-STICKY-SESSION" /></td>';
                var health_check_path = '<td><input class="txt-loadbalancer-healthcheck-path" type="text" value="/" placeholder="path" /></td>';
                var action = '<td><i class="btn-cancel fas fa-times clickable" title="cancel"></i>'
                    + '<i class="btn-save fas fa-save clickable" title="save"></i>'
                    + '<i class="btn-edit fas fa-cog clickable" style="display:none" title="edit"></i>'
                    + '<i class="btn-loadbalancer-backend_edit fas fa-server clickable" title="backends"></i>'
                    + '<i class="btn-maintenance fas fa-exclamation-triangle clickable head-action" title="maintenance" style="display:none"></i>'
                    + '<i class="btn-del fas fa-trash-alt clickable" title="delete"></i></td>';
                var $block = $(createRow(null, action, status, name, sticky_session, cookie_name, health_check_path));
                Loadbalancer.Delete($block, $block.find('.txt-loadbalancer-name'));
                Loadbalancer.Edit($block);
                Loadbalancer.Save($block, { name: '.txt-loadbalancer-name', enable_sticky_session: '.chk-loadbalancer-sticky-session-enable', sticky_session: '.txt-loadbalancer-sticky-session', health_check_path: '.txt-loadbalancer-healthcheck-path' });
                Loadbalancer.Cancel($block);
                Loadbalancer.DefaultWhenEmpty($block.find('.txt-loadbalancer-healthcheck-path'), "/");
                Loadbalancer.OnBackendEdit($block, '.btn-loadbalancer-backend_edit', '.txt-loadbalancer-name');
                Loadbalancer.OnEnableStickySession($block, '.chk-loadbalancer-sticky-session-enable', '.txt-loadbalancer-sticky-session');
                Loadbalancer.Maintenance($block);
                $('#tbody-loadbalancer').prepend($block);
            })
        },
        Delete: function (elem, confirm_on_elem) {
            elem.find('.btn-del').click(function () {
                var id = elem.attr('data-id');
                
                if (typeof (id) == 'undefined') {
                    elem.remove();
                    return;
                }
                
                var id = parseInt(id);
                if (isNaN(id)) {
                    alert("invalid id");
                    return;
                }
                
                var confirmed = confirm("delete " + confirm_on_elem.val() + "?");
                if (confirmed == false) {
                    return;
                }
                
                msg.Send({
                    type: "POST",
                    url: Loadbalancer.API_URL + "/delete",
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id },
                    success: function (data) {
                        elem.remove();
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
        Save: function (elem, dataElem) {
            elem.find('.btn-save').click(function () {
                
                var input = new Object();
                for (var key in dataElem) {
                    if (dataElem.hasOwnProperty(key)) {
                        var val = dataElem[key];
                        if (val.startsWith(".chk")) {
                            input[key] = elem.find(val).prop('checked');
                        } else {
                            input[key] = $.trim(elem.find(val).val());
                        }
                    }
                }
                if (!Utils.String.CheckName(input["name"])) {
                    alert("invalid name (a-z 0-9 - . @)");
                    return;
                }
                if (input["enable_sticky_session"] && input["sticky_session"] == "") {
                    alert("Cookie Name cannot be empty");
                    return;
                }
                
                var id = elem.attr('data-id');
                var action = ";"
                if (typeof (id) == 'undefined') {
                    action = "/add";
                } else {
                    action = "/edit";
                    var id = parseInt(id);
                    if (isNaN(id)) {
                        alert("invalid id");
                        return; x
                    }
                    input.id = id;
                }
                
                msg.Send({
                    type: "POST",
                    url: Loadbalancer.API_URL + action,
                    dataType: "json",
                    timeout: 10000,
                    data: input,
                    success: function (output) {
                        
                        if (action == "/add") {
                            elem.attr('data-id', output.Result);
                        }
                        
                        for (var key in dataElem) {
                            if (dataElem.hasOwnProperty(key)) {
                                var val = dataElem[key];
                                if (val.startsWith(".chk")) {
                                    elem.find(val).attr('disabled', true).removeAttr('data-val');
                                } else {
                                    elem.find(val).attr('readonly', true).removeAttr('data-val');
                                }
                            }
                        }
                        var domain_www = elem.find('.txt-www-domain');
                        domain_www.attr('readonly', true).removeAttr('data-val');
                        domain_edit.enableOpenLink(domain_www);
                        
                        elem.find('.btn-save').hide();
                        elem.find('.btn-cancel').hide();
                        elem.find('.btn-edit').show();
                        elem.find('.btn-maintenance').show();
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
        Edit: function (elem) {
            elem.find('.btn-edit').click(function () {
                var id = elem.attr('data-id');
                
                elem.find('input[type="text"]').attr('readonly', false).each(function () {
                    $(this).attr('data-val', $(this).val());
                });
                
                elem.find("select").removeAttr("disabled").each(function () {
                    $(this).attr('data-val', $(this).val());
                })
                
                elem.find('input[type="checkbox"]').each(function () {
                    $(this).attr('data-val', $(this).prop('checked')).removeAttr('disabled');
                });
                
                $(this).hide();
                elem.find('.btn-save').show();
                elem.find('.btn-del').show();
                elem.find('.btn-cancel').show();
            })
        },
        Cancel: function (elem) {
            elem.find('.btn-cancel').click(function () {
                
                if (elem.attr('data-id') == null) {
                    elem.remove();
                    return;
                }
                
                
                elem.find('input[type="text"]').each(function () {
                    $(this).val($(this).attr('data-val'));
                }).removeAttr('data-val').attr('readonly', true);
                
                elem.find('select').each(function () {
                    $(this).val($(this).attr('data-val'));
                }).removeAttr('data-val').attr('disabled', true);
                
                elem.find('input[type="checkbox"]').each(function () {
                    if ($(this).attr('data-val') == "true") {
                        $(this).prop('checked', true);
                    } else {
                        $(this).prop('checked', false);
                    }
                }).removeAttr('data-val').attr('disabled', 'disabled');
                
                $(this).hide()
                elem.find('.btn-save').hide();
                elem.find('.btn-del').show();
                elem.find('.btn-edit').show();
            })
        },
        DefaultWhenEmpty: function (elem, defaultVal) {
            elem.on('keyup', function (e) {
                if (elem.val() == "") {
                    elem.val(defaultVal);
                }
            });
        },
        OnBackendEdit: function (elem, btn_backend_edit_selector, name_selector) {
            elem.find(btn_backend_edit_selector).click(function () {
                var id = elem.attr('data-id');
                var name = elem.find(name_selector).val();
                ServerPoolBackend.List(id, name);
            })
        },
        OnEnableStickySession: function (elem, check_box_selector, input_text_selector) {
            elem.find(input_text_selector).keyup(function () {
                if ($(this).val() == "") {
                    $(this).closest('tr').find(check_box_selector).attr('checked', false);
                }
            })
            elem.find(check_box_selector).change(function () {
                var text_elem = $(this).closest('tr').find(input_text_selector);
                if ($(this).prop('checked')) {
                    var text_val = text_elem.attr('data-cb-val');
                    if ($.trim(text_val) == "") {
                        text_elem.val('BPX-STICKY-SESSION').attr('readonly', false);
                    } else {
                        text_elem.val(text_val).attr('readonly', false);
                    }
                } else {
                    text_elem.attr('data-cb-val', text_elem.val());
                    text_elem.val('').attr('readonly', true);
                }
            })
        },
        Maintenance: function (elem) {
            elem.find('.btn-maintenance').click(function () {
                
                var id = elem.attr('data-id');
                if (typeof (id) == 'undefined') {
                    alert("unknown error: missing id");
                    return;
                }
                var id = parseInt(id);
                
                var maintenance = elem.hasClass('maintenance');
                
                var name = elem.find('.txt-loadbalancer-name').val();
                var text = "make " + name + " temporarily unavailable?";
                if (maintenance) {
                    text = "turn off maintenance mode for " + name + "?";
                }
                if (confirm(text) == false) {
                    return;
                }
                msg.Send({
                    type: "POST",
                    url: "/api/serverpool/maintenance",
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id, maintenance: !maintenance },
                    success: function (data) {
                        elem.toggleClass('maintenance', !maintenance)
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
    }
</script>


<script>
    $(document).ready(function () {
        ServerPoolBackend.Add();
        $('#btn-server_pool_backend-back').click(function () {
            showPage('loadbalancer');
        })
        $('#health-check-close').click(function () {
            $('#health-check-result').hide();
            $('#health-check-result > h2').html('');
            $('#health-check-result > p').html('');
            $('#health-check-result > textarea').html('');
        })
    })

    var ServerPoolBackend = {
        API_URL: "/api/serverpoolBackend",
        ID: null,
        BackendList: new Object(),
        ListBackend: function () {
            return msg.New({
                type: 'POST',
                url: '/api/backend/list',
                data: {
                    pageSize: 1000,
                    pageNum: 1,
                },
                dataType: 'json',
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        $.each(data.Result.Backends, function (i, val) {
                            ServerPoolBackend.BackendList[val.ID] = val;
                        })
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        List: function (id, name) {
            ServerPoolBackend.ID = parseInt(id);
            $('#title-server_pool_backend-name').html(name);
            showPage('server_pool_backend');
            $.when(ServerPoolBackend.ListBackend()).done(function () {
                msg.Send({
                    type: "POST",
                    url: ServerPoolBackend.API_URL + "/list",
                    dataType: "json",
                    data: { ServerPoolID: ServerPoolBackend.ID },
                    timeout: 10000,
                    success: function (data) {
                        if (data.ErrCode == 0) {
                            var table = [];
                            $.each(data.Result, function (i, val) {
                                var backend = ServerPoolBackend.BackendList[val.BackendID];
                                color = Utils.Colors.Grey;
                                var LastUpdateLabel = '';
                                if (backend.LastUpdate != null) {
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    

                                    
                                    last_update_txt = Utils.Datetime.LastActive(backend.LastUpdate);
                                    if (backend.LastHealthCheck != null && Utils.Datetime.Before(backend.LastUpdate, backend.LastHealthCheck)) {
                                        backend.Status = backend.HealthCheckStatus
                                    }
                                    if (backend.Status > 0) {
                                        var time_difference = Utils.Datetime.Difference(backend.LastUpdate, backend.ServerTime)
                                        if (time_difference <= 60 * 5) {
                                            color = Utils.Colors.LightGreen;
                                        } else if (time_difference <= 3600) {
                                            color = Utils.Colors.DeepGreen;
                                        } else if (time_difference <= 3600 * 24) {
                                            color = Utils.Colors.LightBlue;
                                        } else if (time_difference > 3600 * 24) {
                                            color = Utils.Colors.DeepBlue;
                                        }
                                    }
                                    if (backend.Status == 0) {
                                        color = Utils.Colors.Red;
                                        LastUpdateLabel = 'title="Down since ' + last_update_txt + '"';
                                    } else {
                                        LastUpdateLabel = 'title="Last active ' + last_update_txt + '"';
                                    }
                                } else {
                                    LastUpdateLabel = 'title="Never active"';
                                }
                                var status = '<td><i style="color:' + color + '" class="dboard-status material-icons" ' + LastUpdateLabel + '>fiber_manual_record</i></td>'
                                var addr_option = "";
                                $.each(ServerPoolBackend.BackendList, function (key, bkend) {
                                    if (key == val.BackendID) {
                                        addr_option += '<option value="' + key + '" selected>' + bkend.Name + '</option>';
                                    } else {
                                        addr_option += '<option value="' + key + '">' + bkend.Name + '</option>';
                                    }
                                })
                                var addr = '<td><span class="txt-server_pool_backend-addr">' + backend.Name + '</span><select class="sel-server_pool_backend-addr" disabled style="display:none">' + addr_option + '</select></td>';
                                var weight_option = "";
                                for (var i = 0; i <= 10; i++) {
                                    if (i == val.Weight) {
                                        weight_option += '<option value="' + i + '" selected>' + i + '</option>';
                                    } else {
                                        weight_option += '<option value="' + i + '">' + i + '</option>';
                                    }
                                }
                                var weight = '<td><span class="txt-server_pool_backend-weight">' + val.Weight + '</span><select class="sel-server_pool_backend-weight" disabled style="display:none">' + weight_option + '</select></td>';
                                var weight_pc = '<td class="txt-server_pool_backend-weight_pc"></td>';
                                var rpm = '<td>' + (new Intl.NumberFormat().format(backend.TotalRPM)) + '</td>';
                                var srate = "";
                                if (backend.TotalRPM > 0) {
                                    srate = ((backend.TotalRPM - backend.FailedRPM) / backend.TotalRPM * 100).toFixed(2) + "%";
                                }
                                var successRate = '<td>' + srate + '</td>';

                                var status_code = '<td class="health_check-status"></td>';
                                if (backend.StatusCode != null) {
                                    status_code = '<td class="health_check-status">' + backend.StatusCode + ' ' + backend.StatusText + '</td>';
                                }
                                if (val.Status == 2) {
                                    var status_code = '<td class="health_check-status"></td>';
                                }

                                var lastUpdate = '<td></td>';
                                if (backend.LastHealthCheck != null) {
                                    lastUpdate = '<td>' + Utils.Datetime.LastActive(backend.LastHealthCheck) + '</td>';
                                }

                                var action = '<td><i class="btn-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                                    + '<i class="btn-save fas fa-save clickable" style="display:none" title="save"></i>'
                                    + '<i class="btn-edit fas fa-cog clickable" title="edit"></i>'
                                    + '<i class="btn-del fas fa-trash-alt clickable" title="delete"></i></td>';
                                var $block = $(createRow({ 'id': val.ID, 'backend-id': backend.ID }, action, status, addr, weight, weight_pc, rpm, successRate, status_code, lastUpdate));
                                ServerPoolBackend.Delete($block, $block.find('.txt-server_pool_backend-addr'));
                                ServerPoolBackend.Edit($block);
                                ServerPoolBackend.Save($block, { backendID: ".sel-server_pool_backend-addr", weight: '.sel-server_pool_backend-weight' });
                                ServerPoolBackend.Cancel($block);
                                if (backend.LastHealthCheck != null) {
                                    ServerPoolBackend.Status($block);
                                }
                                table.push($block);
                            })
                            $('#tbody-server_pool_backend').html(table);
                            ServerPoolBackend.CalcWeightPC($('#tbody-server_pool_backend'));
                            ServerPoolBackend.CalcWeightPConChange($('#tbody-server_pool_backend'));
                        }
                        else alert(data.ErrText);
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })

        },
        Add: function () {
            $('#btn-add_server_pool_backend').click(function () {
                var status = '<td><i style="color:grey" class="dboard-status material-icons">fiber_manual_record</i></td>';
                var addr_option = "";
                var count = 0;
                $.each(ServerPoolBackend.BackendList, function (key, bkend) {
                    addr_option += '<option value="' + key + '">' + bkend.Name + '</option>';
                })
                var addr = '<td><span class="txt-server_pool_backend-addr" style="display:none"></span><select class="sel-server_pool_backend-addr">' + addr_option + '</select></td>';
                var weight_option = "";
                for (var i = 0; i <= 10; i++) {
                    weight_option += '<option value="' + i + '">' + i + '</option>';
                }
                var weight = '<td><span class="txt-server_pool_backend-weight" style="display:none">1</span><select class="sel-server_pool_backend-weight">' + weight_option + '</select></td>';
                var weight_pc = '<td class="txt-server_pool_backend-weight_pc"></td>';
                var rpm = '<td>0</td>';
                var success_rate = '<td></td>';
                var health_check = '<td></td>';
                var health_check_time = '<td></td>';
                var action = '<td><i class="btn-cancel fas fa-times clickable" title="cancel"></i>'
                    + '<i class="btn-save fas fa-save clickable" title="save"></i>'
                    + '<i class="btn-edit fas fa-cog clickable" style="display:none" title="edit"></i>'
                    + '<i class="btn-del fas fa-trash-alt clickable" title="delete"></i></td>';
                var $block = $(createRow(null, action, status, addr, weight, weight_pc, rpm, success_rate, health_check, health_check_time));
                ServerPoolBackend.Delete($block, $block.find('.txt-server_pool_backend-addr'));
                ServerPoolBackend.Edit($block);
                ServerPoolBackend.Save($block, { backendID: ".sel-server_pool_backend-addr", weight: '.sel-server_pool_backend-weight' });
                ServerPoolBackend.Cancel($block);
                ServerPoolBackend.Status($block);
                $block.find('.sel-server_pool_backend-weight').val(1);
                $('#tbody-server_pool_backend').prepend($block);
                ServerPoolBackend.CalcWeightPC($('#tbody-server_pool_backend'));
                ServerPoolBackend.CalcWeightPConChange($('#tbody-server_pool_backend'));
            })
        },
        Delete: function (elem, confirm_on_elem) {
            elem.find('.btn-del').click(function () {
                var id = elem.attr('data-id');
                
                if (typeof (id) == 'undefined') {
                    ServerPoolBackend.CalcWeightPC($('#tbody-server_pool_backend'));
                    ServerPoolBackend.CalcWeightPConChange($('#tbody-server_pool_backend'));
                    elem.remove();
                    return;
                }
                
                var id = parseInt(id);
                if (isNaN(id)) {
                    alert("invalid id");
                    return;
                }
                
                var confirmed = confirm("delete " + confirm_on_elem.html() + "?");
                if (confirmed == false) {
                    return;
                }
                
                msg.Send({
                    type: "POST",
                    url: ServerPoolBackend.API_URL + "/delete",
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id, serverPoolID: ServerPoolBackend.ID },
                    success: function (data) {
                        elem.remove();
                        ServerPoolBackend.CalcWeightPC($('#tbody-server_pool_backend'));
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
        Save: function (elem, dataElem) {
            elem.find('.btn-save').click(function () {
                
                var input = new Object();
                for (var key in dataElem) {
                    if (dataElem.hasOwnProperty(key)) {
                        var val = dataElem[key];
                        if (val.startsWith(".chk")) {
                            input[key] = elem.find(val).prop('checked');
                        } else {
                            string_val = $.trim(elem.find(val).val());
                            int_val = parseInt(string_val);
                            if (isNaN(int_val)) {
                                input[key] = string_val;
                            } else {
                                input[key] = int_val;
                            }
                        }
                    }
                }
                
                var id = elem.attr('data-id');
                var action = ";"
                if (typeof (id) == 'undefined') {
                    action = "/add";
                } else {
                    action = "/edit";
                    var id = parseInt(id);
                    if (isNaN(id)) {
                        alert("invalid id");
                        return; x
                    }
                    input.id = id;
                }
                input.ServerPoolID = ServerPoolBackend.ID;
                
                msg.Send({
                    type: "POST",
                    url: ServerPoolBackend.API_URL + action,
                    dataType: "json",
                    timeout: 10000,
                    data: input,
                    success: function (output) {
                        
                        if (action == "/add") {
                            elem.attr('data-id', output.Result);
                        }
                        
                        for (var key in dataElem) {
                            if (dataElem.hasOwnProperty(key)) {
                                var val = dataElem[key];
                                if (val.startsWith(".chk") || val.startsWith(".sel")) {
                                    elem.find(val).attr('disabled', true).removeAttr('data-val');
                                } else {
                                    elem.find(val).attr('disabled', true).attr('readonly', true).removeAttr('data-val');
                                }
                            }
                        }
                        
                        ServerPoolBackend.CalcWeightPC($('#tbody-server_pool_backend'));
                        
                        elem.find('.btn-save').hide();
                        elem.find('.btn-edit').show();
                        elem.find('.btn-cancel').hide();
                        
                        elem_addr = elem.find('.sel-server_pool_backend-addr')
                        elem.find('.txt-server_pool_backend-addr').show().html(elem_addr.find('option:selected').text());
                        elem_addr.hide();
                        elem_weight = elem.find('.sel-server_pool_backend-weight');
                        elem.find('.txt-server_pool_backend-weight').show().html(elem_weight.val());
                        elem_weight.hide();
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
        Edit: function (elem) {
            elem.find('.btn-edit').click(function () {
                var id = elem.attr('data-id');

                
                elem.find('input[type="text"]').each(function () {
                    if (!$(this).hasClass('no-edit')) {
                        $(this).attr('data-val', $(this).val()).attr('readonly', false);
                    }
                });
                
                elem.find("select").each(function () {
                    if (!$(this).hasClass('no-edit')) {
                        $(this).attr('data-val', $(this).val()).removeAttr("disabled");
                    }
                })
                
                elem.find('input[type="checkbox"]').each(function () {
                    if (!$(this).hasClass('no-edit')) {
                        $(this).attr('data-val', $(this).prop('checked')).removeAttr('disabled');
                    }
                });
                
                $(this).hide();
                elem.find('.btn-save').show();
                elem.find('.btn-del').show();
                elem.find('.btn-cancel').show();

                
                elem.find('.txt-server_pool_backend-addr').hide();
                elem.find('.sel-server_pool_backend-addr').show();
                elem.find('.txt-server_pool_backend-weight').hide();
                elem.find('.sel-server_pool_backend-weight').show();
            })
        },
        Cancel: function (elem) {
            elem.find('.btn-cancel').click(function () {
                
                if (elem.attr('data-id') == null) {
                    elem.remove();
                    ServerPoolBackend.CalcWeightPC($('#tbody-server_pool_backend'));
                    return;
                }
                
                
                elem.find('input[type="text"]').each(function () {
                    if (!$(this).hasClass('no-edit')) {
                        $(this).val($(this).attr('data-val')).removeAttr('data-val').attr('readonly', true);
                    }
                });
                
                elem.find('select').each(function () {
                    if (!$(this).hasClass('no-edit')) {
                        $(this).val($(this).attr('data-val')).removeAttr('data-val').attr('disabled', true);
                    }
                });
                
                elem.find('input[type="checkbox"]').each(function () {
                    if (!$(this).hasClass('no-edit')) {
                        if ($(this).attr('data-val') == "true") {
                            $(this).prop('checked', true);
                        } else {
                            $(this).prop('checked', false);
                        }
                        $(this).removeAttr('data-val').attr('disabled');
                    }
                });

                ServerPoolBackend.CalcWeightPC($('#tbody-server_pool_backend'));
                
                $(this).hide()
                elem.find('.btn-save').hide();
                elem.find('.btn-del').show();
                elem.find('.btn-edit').show();

                
                elem_addr = elem.find('.sel-server_pool_backend-addr')
                elem.find('.txt-server_pool_backend-addr').show();
                elem_addr.hide();
                elem_weight = elem.find('.sel-server_pool_backend-weight');
                elem.find('.txt-server_pool_backend-weight').show();
                elem_weight.hide();
            })
        },
        CalcWeightPConChange: function (elem) {
            elem.find('.sel-server_pool_backend-weight').change(function () {
                ServerPoolBackend.CalcWeightPC($('#tbody-server_pool_backend'));
            })
        },
        CalcWeightPC: function (elem) {
            var total = 0;
            elem.find('.sel-server_pool_backend-weight').each(function (i, v) {
                total += parseInt($(this).val());
            })
            elem.find('.sel-server_pool_backend-weight').each(function (i, v) {
                if (total == 0) {
                    $(this).closest('tr').find('.txt-server_pool_backend-weight_pc').html("0%");
                } else {
                    $(this).closest('tr').find('.txt-server_pool_backend-weight_pc').html((parseInt($(this).val()) / total * 100).toFixed(2) + "%");
                }
            })
        },
        Status: function (elem) {
            elem.find('.health_check-status').click(function () {
                var id = elem.attr('data-backend-id');
                var addr = elem.find('.txt-backend-addr').val();
                id = parseInt(id);
                if (!isNaN(id)) {
                    msg.Send({
                        type: "POST",
                        url: "/api/backend/getStatus",
                        dataType: "json",
                        data: { id: id },
                        timeout: 10000,
                        success: function (data) {
                            if (data.ErrCode == 0) {
                                data.Result.Header = data.Result.Header.replace(/(?:\r\n|\r|\n)/g, '<br>');
                                var tagsToReplace = {
                                    '&': '&amp;',
                                    '<': '&lt;',
                                    '>': '&gt;'
                                };
                                function replaceTag(tag) {
                                    return tagsToReplace[tag] || tag;
                                }
                                function safe_tags_replace(str) {
                                    return str.replace(/[&<>]/g, replaceTag);
                                }
                                
                                data.Result.Body = safe_tags_replace(data.Result.Body);
                                data.Result.Body = data.Result.Body.replace(/(?:\r\n|\r|\n)/g, '<br>');
                                data.Result.Error = data.Result.Error.replace(/(?:\r\n|\r|\n)/g, '<br>');
                                $('#health-check-status').html('Status: ' + data.Result.StatusCode + ' ' + data.Result.StatusText);
                                $('#health-check-header').html(data.Result.Header);
                                $('#health-check-body').html(data.Result.Body);
                                $('#health-check-error').html(data.Result.Error);
                                $('#health-check-result').show();
                            }
                            else alert(data.ErrText);
                        },
                        error: function (xhr, status, error) {
                            alert(error);
                            if (xhr.status == 401) {
                                location.href = "/";
                            }
                        }
                    })
                }
            })
        },
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-setting').click(function () {
            menuClick($(this));
        })
        $('#btn-save-pass').click(function () {
            onChangePassword();
        });
    })

    function onChangePassword() {
        var old_password = $("#txt-old-password").val();
        var new_password = $("#txt-new-password").val();
        var confirm_password = $('#txt-confirm-password').val();

        old_password = $.trim(old_password);
        new_password = $.trim(new_password);
        confirm_password = $.trim(confirm_password);
        if (old_password.length == 0) {
            alert("old passoword cannot be empty");
            return;
        }
        if (new_password.length == 0) {
            alert("new password cannot be empty");
            return;
        }
        if (new_password != confirm_password) {
            alert("new password and confirm password must be same");
            return;
        }
        msg.Send({
            type: "POST",
            url: "/api/user/changePassword",
            dataType: "json",
            data: { old: old_password, new: new_password },
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    alert("password is updated");
                    $("#txt-old-password").val('');
                    $("#txt-new-password").val('');
                    $('#txt-confirm-password').val('');
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_custom-header').click(function () {
            menuClick($(this));
            onListUserGroup(onListCustomHeader);
        })
        onAddCustomHeader();
    })

    function onListCustomHeader() {
        msg.Send({
            type: "POST",
            url: "/api/customHeader/list",
            dataType: "json",
            timeout: 10000,
            success: function (data) {
                if (data.ErrCode == 0) {
                    var table = [];
                    $.each(data.Result, function (i, val) {
                        var name = '<td><input class="txt-custom_header-name" type="text" value="' + val.Name + '" readonly="readonly" /></td>';
                        var direction = '<td><select class="option-custom_header-direction" disabled="disabled"><option value="0" selected>Request</option><option value="1">Response</option></select></td>';
                        if (val.Direction == 1) {
                            direction = '<td><select class="option-custom_header-direction" disabled="disabled"><option value="0">Request</option><option value="1" selected>Response</option></select></td>';
                        }
                        var type = '<td><select class="option-custom_header-type" disabled="disabled"><option value="0" selected>Client IP</option><option value="1">Backend</option><option value="3">Host</option><option value="4">Protocol</option><option value="2">Custom</option></select></td>';
                        var value = '<td><input class="txt-custom_header-value" type="text" value="" readonly="readonly" /></td>';
                        if (val.Type == 1) {
                            type = '<td><select class="option-custom_header-type" disabled="disabled"><option value="0">Client IP</option><option value="1" selected>Backend</option><option value="3">Host</option><option value="4">Protocol</option><option value="2">Custom</option></select></td>';
                            value = '<td><input class="txt-custom_header-value" type="text" value="" readonly="readonly" /></td>';
                        } else if (val.Type == 2) {
                            type = '<td><select class="option-custom_header-type" disabled="disabled"><option value="0">Client IP</option><option value="1">Backend</option><option value="3">Host</option><option value="4">Protocol</option><option value="2" selected>Custom</option></select></td>';
                            value = '<td><input class="txt-custom_header-value" type="text" value="' + val.Content + '" readonly="readonly" /></td>';
                        } else if (val.Type == 3) {
                            type = '<td><select class="option-custom_header-type" disabled="disabled"><option value="0">Client IP</option><option value="1">Backend</option><option value="3" selected>Host</option><option value="4">Protocol</option><option value="2">Custom</option></select></td>';
                            value = '<td><input class="txt-custom_header-value" type="text" value="" readonly="readonly" /></td>';
                        } else if (val.Type == 4) {
                            type = '<td><select class="option-custom_header-type" disabled="disabled"><option value="0">Client IP</option><option value="1">Backend</option><option value="3">Host</option><option value="4" selected>Protocol</option><option value="2">Custom</option></select></td>';
                            value = '<td><input class="txt-custom_header-value" type="text" value="" readonly="readonly" /></td>';
                        }
                        
                        var scope = '<td><select class="option-custom_header-scope" disabled="disabled"><option value="0" selected>Global</option><option value="1">Group</option><option value="2">Site</option></select></td>';
                        if (val.Scope == 1) {
                            scope = '<td><select class="option-custom_header-scope" disabled="disabled"><option value="0" selected>Global</option><option value="1" selected>Group</option><option value="2">Site</option></select></td>';
                        } else if (val.Scope == 2) {
                            scope = '<td><select class="option-custom_header-scope" disabled="disabled"><option value="0" selected>Global</option><option value="1">Group</option><option value="2" selected>Site</option></select></td>';
                        }
                        
                        var usergroup = '<td><input class="txt-custom_header-usergroup" type="text" value="" readonly="readonly"/></td>';
                        if (val.UserName != null) {
                            usergroup = '<td><input class="txt-custom_header-usergroup" type="text" value="' + val.UserName + '" data-id="' + val.SiteID + '" readonly="readonly" /></td>';
                        } else if (val.GroupName != null) {
                            usergroup = '<td><input class="txt-custom_header-usergroup" type="text" value="' + val.GroupName + '" data-id="' + val.GroupID + '" readonly="readonly" /></td>';
                        }
                        var action = '<td><i class="btn-custom_header-cancel fas fa-times clickable" style="display:none" title="cancel"></i>'
                            + '<i class="btn-custom_header-save fas fa-save clickable" style="display:none" title="save"></i>'
                            + '<i class="btn-custom_header-edit fas fa-cog clickable" title="edit"></i>'
                            + '<i class="btn-custom_header-del fas fa-trash-alt clickable" title="delete"></i></td>';
                        var $block = $(createRow(val.ID, action, name, direction, type, value, scope, usergroup));
                        onDeleteCustomHeader($block);
                        onEditCustomHeader($block);
                        onSaveCustomHeader($block);
                        onCancelCustomHeader($block);
                        table.push($block);
                    })
                    $('#tbody-custom_header').html(table);

                    $('.option-custom_header-scope').change(function () {
                        var target = $(this).closest('tr').find('.txt-custom_header-usergroup');
                        target.val('').removeAttr('data-id');
                        if ($(this).val() == "2") {
                            target.attr('readonly', false);
                            setAutoComplete(target, autocomplete_user_data);
                        } else if ($(this).val() == "1") {
                            target.attr('readonly', false);
                            setAutoComplete(target, autocomplete_group_data);
                        } else {
                            target.attr('readonly', true);
                        }
                    });

                    $('.option-custom_header-type').change(function () {
                        var target = $(this).closest('tr').find('.txt-custom_header-value');
                        target.val('').removeAttr('data-id');
                        if ($(this).val() == '2') {
                            target.attr('readonly', false);
                        } else {
                            target.attr('readonly', true);
                        }
                    });
                }
                else alert(data.ErrText);
            },
            error: function (xhr, status, error) {
                alert(error);
                if (xhr.status == 401) {
                    location.href = "/";
                }
            }
        })
    }

    function onAddCustomHeader() {
        $('#btn_add-custom_header').click(function () {
            var name = '<td><input class="txt-custom_header-name" type="text" value="" /></td>';
            var direction = '<td><select class="option-custom_header-direction"><option value="0" selected>Request</option><option value="1">Response</option></select></td>';
            var type = '<td><select class="option-custom_header-type"><option value="0" selected>Client IP</option><option value="1">Backend</option><option value="3">Host</option><option value="4">Protocol</option><option value="2">Custom</option></select></td>';
            var value = '<td><input class="txt-custom_header-value" type="text" value="" readonly="readonly"/></td>';
            var scope = '<td><select class="option-custom_header-scope" ><option value="0" selected>Global</option><option value="1">Group</option><option value="2">Site</option></select></td>';
            var usergroup = '<td><input class="txt-custom_header-usergroup" type="text" value="" readonly="readonly"/></td>';
            var action = '<td><i class="btn-custom_header-cancel fas fa-times clickable" title="cancel"></i>'
                + '<i class="btn-custom_header-save fas fa-save clickable" title="save"></i>'
                + '<i class="btn-custom_header-edit fas fa-cog clickable" style="display:none" title="edit"></i>'
                + '<i class="btn-custom_header-del fas fa-trash-alt clickable" title="delete"></i></td>';
            var $block = $(createRow(null, action, name, direction, type, value, scope, usergroup));
            onDeleteCustomHeader($block);
            onSaveCustomHeader($block);
            onEditCustomHeader($block);
            onCancelCustomHeader($block);
            $('#tbody-custom_header').prepend($block);

            $('.option-custom_header-scope').change(function () {
                var target = $(this).closest('tr').find('.txt-custom_header-usergroup')
                target.val('').removeAttr('data-id');
                if ($(this).val() == "2") {
                    target.attr('readonly', false);
                    setAutoComplete(target, autocomplete_user_data);
                } else if ($(this).val() == "1") {
                    target.attr('readonly', false);
                    setAutoComplete(target, autocomplete_group_data);
                } else {
                    target.attr('readonly', true);
                }
            });

            $('.option-custom_header-type').change(function () {
                var target = $(this).closest('tr').find('.txt-custom_header-value');
                target.val('').removeAttr('data-id');
                if ($(this).val() == '2') {
                    target.attr('readonly', false);
                } else {
                    target.attr('readonly', true);
                }
            });
        })
    }

    function onDeleteCustomHeader(elem) {
        elem.find('.btn-custom_header-del').click(function () {
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                elem.remove();
                return;
            }
            var name = elem.find('.txt-custom_header-name').val();
            var confirmed = confirm("delete rule for " + name + "?");
            if (confirmed == false) {
                return;
            }
            var id = parseInt(id);
            msg.Send({
                type: "POST",
                url: "/api/customHeader/delete",
                dataType: "json",
                timeout: 10000,
                data: { id: id },
                success: function (data) {
                    elem.remove();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onSaveCustomHeader(elem) {
        elem.find('.btn-custom_header-save').click(function () {
            var $btn_save = $(this);
            var url = "";
            var id = elem.attr('data-id');
            if (typeof (id) == 'undefined') {
                url = "/api/customHeader/add";
            } else {
                url = "/api/customHeader/edit";
            }
            id = parseInt(id);

            var name = elem.find('.txt-custom_header-name').val();
            var direction = parseInt(elem.find('.option-custom_header-direction').val());
            var type = parseInt(elem.find('.option-custom_header-type').val());
            var value = elem.find('.txt-custom_header-value').val();
            var scope = parseInt(elem.find('.option-custom_header-scope').val());
            var $usergroup = elem.find('.txt-custom_header-usergroup');
            var usergroup = $.trim($usergroup.val());
            var usergroupId = parseInt($usergroup.attr('data-id'));
            var data = { id: id, name: name, direction: direction, type: type, content: value, scope: scope };
            if (usergroup != "" && !isNaN(usergroupId)) {
                if (scope == '2') {
                    data.SiteID = usergroupId;
                } else if (scope == '1') {
                    data.GroupId = usergroupId;
                }
            }
            
            msg.Send({
                type: "POST",
                url: url,
                dataType: "json",
                timeout: 10000,
                data: data,
                success: function (data) {
                    elem.find('input[type="text"]').attr('readonly', true).removeAttr('data-val');
                    elem.find('.btn-custom_header-save').hide();
                    elem.find('.btn-custom_header-cancel').hide();
                    elem.find('.btn-custom_header-edit').show();
                    if (url == "/api/customHeader/add") {
                        elem.attr('data-id', data.Result)
                    }
                    $btn_save.hide();
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        })
    }

    function onEditCustomHeader(elem) {
        elem.find('.btn-custom_header-edit').click(function () {
            var id = elem.attr('data-id');
            elem.find('input[type="text"]').attr('readonly', false).each(function () {
                $(this).attr('data-val', $(this).val());
                var data_id = $(this).attr('data-id');
                if (typeof (data_id) == "undefined") {
                    data_id = "";
                }
                $(this).attr('data-id-old', data_id);
            });
            
            elem.find('.option-custom_header-direction').each(function () {
                $(this).attr('data-val', $(this).val());
            }).attr('disabled', false);
            
            var type = elem.find('.option-custom_header-type')
            type.attr('disabled', false).each(function () {
                $(this).attr('data-val', $(this).val());
            });
            if (type.val() == '0' || type.val() == '1' || type.val() == '3' || type.val() == '4') {
                elem.find('.txt-custom_header-value').attr('readonly', true);
            }
            
            var scope = elem.find('.option-custom_header-scope')
            scope.prop('disabled', false).each(function () {
                $(this).attr('data-val', $(this).val());
                var text = $(this).closest('tr').find('.txt-custom_header-usergroup')
                if ($(this).val() == "none") {
                    text.attr('readonly', true);
                } else if ($(this).val() == "user") {
                    text.attr('readonly', false);
                    setAutoComplete(text, autocomplete_user_data);
                } else if ($(this).val() == "group") {
                    text.attr('readonly', false);
                    setAutoComplete(text, autocomplete_group_data);
                }
            })
            if (scope.val() == '0') {
                elem.find('.txt-custom_header-usergroup').attr('readonly', true);
            }
            
            $(this).hide();
            elem.find('.btn-custom_header-save').show();
            elem.find('.btn-custom_header-cancel').show();
        })
    }

    function onCancelCustomHeader(elem) {
        elem.find('.btn-custom_header-cancel').click(function () {
            
            if (elem.attr('data-id') == null) {
                elem.remove();
                return;
            }
            
            elem.find('input[type="text"]').each(function () {
                $(this).val($(this).attr('data-val'));
                $(this).attr('data-id', $(this).attr('data-id-old'));
                $(this).attr('data-category', $(this).attr('data-category-old'));
            }).removeAttr('data-val').attr('readonly', true).removeAttr('data-id-old');
            elem.find('select').each(function () {
                $(this).val($(this).attr('data-val'));
            }).removeAttr('data-val').prop('disabled', true)
            elem.find('.btn-custom_header-save').hide();
            elem.find('.btn-custom_header-cancel').hide();
            elem.find('.btn-custom_header-edit').show();
        })
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_report-requests').click(function () {
            menuClick($(this));
            $('#txt_search_requests_from').datetimepicker("destroy").datetimepicker({
                controlType: 'select',
                oneLine: true,
                dateFormat: 'yy/mm/dd',
                timeFormat: 'HH:mm',
                minDate: Utils.Datetime.Get(-6, 0, true),
                maxDate: Utils.Datetime.Get(0, 0, false),
            }).val(Utils.Datetime.GetString(-1, 0, false, false));
            $('#txt_search_requests_to').datetimepicker("destroy").datetimepicker({
                controlType: 'select',
                oneLine: true,
                dateFormat: 'yy/mm/dd',
                timeFormat: 'HH:mm',
                minDate: Utils.Datetime.Get(-6, 0, true),
                maxDate: Utils.Datetime.Get(0, 0, false),
            }).val(Utils.Datetime.GetString(0, 0, false, false));
            report_total_requests.OnListRPM();
        })

        $('#btn-search_requests').click(report_total_requests.OnListRPM);
    })

    var report_total_requests = {
        OnListRPM: function () {
            msg.Send({
                type: "POST",
                url: "/api/proxyStats/rpm",
                dataType: "json",
                data: { from: $.trim($('#txt_search_requests_from').val()), to: $.trim($('#txt_search_requests_to').val()) },
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var labels = [];
                        var datasets = [];
                        var group = [];
                        $.each(data.Result, function (i, val) {
                            if (!group.includes(val.ProxyName)) {
                                group.push(val.ProxyName)
                            }
                        })
                        var colors = Utils.Colors.Pick(group.length);
                        var proxy_count = group.length;
                        group = [];
                        var last_min = -1;
                        var last_min_proxy_count;
                        $.each(data.Result, function (i, val) {
                            
                            if (last_min == -1 || last_min == val.Minute) {
                                last_min_proxy_count++;
                            } else {
                                if (last_min_proxy_count < proxy_count) {
                                    var diff = proxy_count - last_min_proxy_count; var missing_record = [];
                                    var total_record = 0;
                                    if (diff > 0) {
                                        $.each(datasets, function (i, v) {
                                            if (total_record == 0) {
                                                total_record = v.data.length;
                                            } else if (total_record < v.data.length) {
                                                total_record = v.data.length;
                                                missing_record.push(i - 1);
                                            } else if (total_record > v.data.length) {
                                                missing_record.push(i);
                                            }
                                        })
                                        $.each(missing_record, function (i, v) {
                                            var len = datasets[v].data.length
                                            datasets[v].data.push(datasets[v].data[len - 1]);
                                        })
                                    }
                                }
                                last_min_proxy_count = 0;
                            }
                            last_min = val.Minute;
                            
                            var hour = ('0' + String(val.Hour)).slice(-2);
                            var minute = ('0' + String(val.Minute)).slice(-2);
                            var label = Utils.Datetime.Date(val.Date) + " " + hour + ":" + minute;
                            if (!labels.includes(label)) {
                                labels.push(label);
                            }
                            if (!group.includes(val.ProxyName)) {
                                group.push(val.ProxyName);
                                datasets.push({ data: [], borderColor: "", backgroundColor: "", label: val.ProxyName, fill: false });
                            }
                            var pos = group.indexOf(val.ProxyName);
                            datasets[pos].data.push(val.Requests);
                            datasets[pos].borderColor = colors[pos];
                            datasets[pos].backgroundColor = colors[pos];
                        })
                        labels.sort();
                        datasets.sort(function (a, b) {
                            if (a.label < b.label) return -1;
                            if (a.label > b.label) return 1;
                            return 0;
                        });
                        report_total_requests.newRPMChart(document.getElementById("rpm-chart"), labels, datasets);
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        chart: null,
        newRPMChart: function (container, labels, datasets) {
            if (this.chart == null) {
                this.chart = new Chart(container, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        title: {
                            display: true,
                            text: 'Total Requests Per Minute',
                            fontSize: 18,
                        },
                        tooltips: {
                            mode: 'index',
                            intersect: false,
                        },
                    }
                });
            } else {
                this.chart.data.labels = labels;
                this.chart.data.datasets = datasets;
                this.chart.update();
            }
        }
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_report-memory').click(function () {
            menuClick($(this));
            $('#txt_search_search_memory_from').datetimepicker("destroy").datetimepicker({
                controlType: 'select',
                oneLine: true,
                dateFormat: 'yy/mm/dd',
                timeFormat: 'HH:mm',
                minDate: Utils.Datetime.Get(-6, 0, true),
                maxDate: Utils.Datetime.Get(0, 0, false),
            }).val(Utils.Datetime.GetString(-1, 0, false, false));
            $('#txt_search_search_memory_to').datetimepicker("destroy").datetimepicker({
                controlType: 'select',
                oneLine: true,
                dateFormat: 'yy/mm/dd',
                timeFormat: 'HH:mm',
                minDate: Utils.Datetime.Get(-6, 0, true),
                maxDate: Utils.Datetime.Get(0, 0, false),
            }).val(Utils.Datetime.GetString(0, 0, false, false));
            report_memory_usage.onListMemUsage();
        })

        $('#btn-search_memory').click(report_memory_usage.onListMemUsage);
    })

    var report_memory_usage = {
        onListMemUsage: function () {
            msg.Send({
                type: "POST",
                url: "/api/proxyStats/mem",
                dataType: "json",
                data: { from: $.trim($('#txt_search_search_memory_from').val()), to: $.trim($('#txt_search_search_memory_to').val()) },
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var labels = [];
                        var datasets = [];
                        var ext = [];
                        var group = [];
                        $.each(data.Result, function (i, val) {
                            if (!group.includes(val.ProxyName)) {
                                group.push(val.ProxyName)
                            }
                        })
                        var colors = Utils.Colors.Pick(group.length);
                        var proxy_count = group.length;
                        group = [];
                        var last_min = -1;
                        var last_min_proxy_count;
                        $.each(data.Result, function (i, val) {
                            
                            if (last_min == -1 || last_min == val.Minute) {
                                last_min_proxy_count++;
                            } else {
                                if (last_min_proxy_count < proxy_count) {
                                    var diff = proxy_count - last_min_proxy_count; var missing_record = [];
                                    var total_record = 0;
                                    if (diff > 0) {
                                        $.each(datasets, function (i, v) {
                                            if (total_record == 0) {
                                                total_record = v.data.length;
                                            } else if (total_record < v.data.length) {
                                                total_record = v.data.length;
                                                missing_record.push(i - 1);
                                            } else if (total_record > v.data.length) {
                                                missing_record.push(i);
                                            }
                                        })
                                        $.each(missing_record, function (i, v) {
                                            var len = datasets[v].data.length
                                            datasets[v].data.push(datasets[v].data[len - 1]);
                                            var ext_len = ext[v].data.length
                                            ext[v].data.push(ext[v].data[len - 1]);
                                        })
                                    }
                                }
                                last_min_proxy_count = 0;
                            }
                            last_min = val.Minute;
                            
                            var hour = ('0' + String(val.Hour)).slice(-2);
                            var minute = ('0' + String(val.Minute)).slice(-2);
                            var label = Utils.Datetime.Date(val.Date) + " " + hour + ":" + minute;
                            if (!labels.includes(label)) {
                                labels.push(label);
                            }
                            if (!group.includes(val.ProxyName)) {
                                group.push(val.ProxyName);
                                datasets.push({ data: [], borderColor: "", backgroundColor: "", label: val.ProxyName, fill: false });
                                ext.push({ data: [], label: val.ProxyName });
                            }
                            var pos = group.indexOf(val.ProxyName);
                            var usedmem = val.TotalMem - val.FreeMem;
                            var usedPercent = parseInt((usedmem / val.TotalMem) * 100);
                            datasets[pos].data.push(usedPercent);
                            datasets[pos].borderColor = colors[pos];
                            datasets[pos].backgroundColor = colors[pos];
                            ext[pos].data.push({ used: usedmem, total: val.TotalMem });
                        })
                        labels.sort();
                        datasets.sort(function (a, b) {
                            if (a.label < b.label) return -1;
                            if (a.label > b.label) return 1;
                            return 0;
                        });
                        ext.sort(function (a, b) {
                            if (a.label < b.label) return -1;
                            if (a.label > b.label) return 1;
                            return 0;
                        });
                        report_memory_usage.newMemChart(document.getElementById("mem-chart"), labels, datasets, ext);
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        chart: null,
        newMemChart: function (container, labels, datasets, ext) {
            if (this.chart == null) {
                this.chart = new Chart(container, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets,
                        ext: ext
                    },
                    options: {
                        title: {
                            display: true,
                            text: 'Memory Usage',
                            fontSize: 18,
                        },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    callback: function (value, index, values) {
                                        return value + "%";
                                    }
                                }
                            }]
                        },
                        tooltips: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (tooltipItem, data) {
                                    var label = data.datasets[tooltipItem.datasetIndex].label;
                                    var usedPercent = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                    var ext = data.ext[tooltipItem.datasetIndex].data[tooltipItem.index];
                                    var totalmem = ext.total;
                                    var usedmem = ext.used;
                                    return label + ": " + usedPercent + "% (" + usedmem + "/" + totalmem + "MB)";
                                }
                            }
                        }
                    }
                });
            } else {
                this.chart.data.labels = labels;
                this.chart.data.datasets = datasets;
                this.chart.data.ext = ext;
                this.chart.update();
            }
        }
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_report-app-memory').click(function () {
            menuClick($(this));
            $('#txt_search_search_app-memory_from').datetimepicker("destroy").datetimepicker({
                controlType: 'select',
                oneLine: true,
                dateFormat: 'yy/mm/dd',
                timeFormat: 'HH:mm',
                minDate: Utils.Datetime.Get(-6, 0, true),
                maxDate: Utils.Datetime.Get(0, 0, false),
            }).val(Utils.Datetime.GetString(-1, 0, false, false));
            $('#txt_search_search_app-memory_to').datetimepicker("destroy").datetimepicker({
                controlType: 'select',
                oneLine: true,
                dateFormat: 'yy/mm/dd',
                timeFormat: 'HH:mm',
                minDate: Utils.Datetime.Get(-6, 0, true),
                maxDate: Utils.Datetime.Get(0, 0, false),
            }).val(Utils.Datetime.GetString(0, 0, false, false));
            report_app_memory_usage.onListMemUsage();
        })

        $('#btn-search_app-memory').click(report_app_memory_usage.onListMemUsage);
    })

    var report_app_memory_usage = {
        onListMemUsage: function () {
            msg.Send({
                type: "POST",
                url: "/api/proxyStats/appmem",
                dataType: "json",
                data: { from: $.trim($('#txt_search_search_app-memory_from').val()), to: $.trim($('#txt_search_search_app-memory_to').val()) },
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var labels = [];
                        var datasets = [];
                        var group = [];
                        $.each(data.Result, function (i, val) {
                            if (!group.includes(val.ProxyName)) {
                                group.push(val.ProxyName)
                            }
                        })
                        var colors = Utils.Colors.Pick(group.length);
                        var proxy_count = group.length;
                        group = [];
                        var last_min = -1;
                        var last_min_proxy_count;
                        $.each(data.Result, function (i, val) {
                            
                            if (last_min == -1 || last_min == val.Minute) {
                                last_min_proxy_count++;
                            } else {
                                if (last_min_proxy_count < proxy_count) {
                                    var diff = proxy_count - last_min_proxy_count; var missing_record = [];
                                    var total_record = 0;
                                    if (diff > 0) {
                                        $.each(datasets, function (i, v) {
                                            if (total_record == 0) {
                                                total_record = v.data.length;
                                            } else if (total_record < v.data.length) {
                                                total_record = v.data.length;
                                                missing_record.push(i - 1);
                                            } else if (total_record > v.data.length) {
                                                missing_record.push(i);
                                            }
                                        })
                                        $.each(missing_record, function (i, v) {
                                            var len = datasets[v].data.length
                                            datasets[v].data.push(datasets[v].data[len - 1]);
                                        })
                                    }
                                }
                                last_min_proxy_count = 0;
                            }
                            last_min = val.Minute;
                            
                            var hour = ('0' + String(val.Hour)).slice(-2);
                            var minute = ('0' + String(val.Minute)).slice(-2);
                            var label = Utils.Datetime.Date(val.Date) + " " + hour + ":" + minute;
                            if (!labels.includes(label)) {
                                labels.push(label);
                            }
                            if (!group.includes(val.ProxyName)) {
                                group.push(val.ProxyName);
                                datasets.push({ data: [], borderColor: "", backgroundColor: "", label: val.ProxyName, fill: false });
                            }
                            var pos = group.indexOf(val.ProxyName);
                            datasets[pos].data.push(val.Mebibyte);
                            datasets[pos].borderColor = colors[pos];
                            datasets[pos].backgroundColor = colors[pos];
                        })
                        labels.sort();
                        datasets.sort(function (a, b) {
                            if (a.label < b.label) return -1;
                            if (a.label > b.label) return 1;
                            return 0;
                        });
                        report_app_memory_usage.newMemChart(document.getElementById("app-mem-chart"), labels, datasets);
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        chart: null,
        newMemChart: function (container, labels, datasets) {
            if (this.chart == null) {
                this.chart = new Chart(container, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        title: {
                            display: true,
                            text: 'App Memory Usage',
                            fontSize: 18,
                        },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    callback: function (value, index, values) {
                                        return value + "MB";
                                    }
                                }
                            }]
                        },
                        tooltips: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (tooltipItem, data) {
                                    var label = data.datasets[tooltipItem.datasetIndex].label;
                                    var value = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                    return label + ": " + value + "MB";
                                }
                            }
                        }
                    }
                });
            } else {
                this.chart.data.labels = labels;
                this.chart.data.datasets = datasets;
                this.chart.update();
            }
        }
    }
</script>


<script>
    $(document).ready(function () {
        report_bandwidth_usage.select_proxy = $('#option-search_bandwidth_proxy');
        report_bandwidth_usage.select_interface = $('#option-search_bandwidth_interface');

        $('#btn-menu_report-bandwidth').click(function () {
            menuClick($(this));
            $('#txt_search_bandwidth_from').datetimepicker("destroy").datetimepicker({
                controlType: 'select',
                oneLine: true,
                dateFormat: 'yy/mm/dd',
                timeFormat: 'HH:mm',
                minDate: Utils.Datetime.Get(-6, 0, true),
                maxDate: Utils.Datetime.Get(0, 0, false),
            }).val(Utils.Datetime.GetString(-1, 0, false, false));
            $('#txt_search_bandwidth_to').datetimepicker("destroy").datetimepicker({
                controlType: 'select',
                oneLine: true,
                dateFormat: 'yy/mm/dd',
                timeFormat: 'HH:mm',
                minDate: Utils.Datetime.Get(-6, 0, true),
                maxDate: Utils.Datetime.Get(0, 0, false),
            }).val(Utils.Datetime.GetString(0, 0, false, false));
            report_bandwidth_usage.onListInterface();
        })

        $('#btn-search_bandwidth').click(report_bandwidth_usage.onList);
    })

    var report_bandwidth_usage = {
        proxy_list: {},
        select_proxy: null,
        select_interface: null,
        onListInterface: function () {
            $.when(
                msg.New({
                    type: "POST",
                    url: "/api/proxyStats/interface",
                    dataType: "json",
                    timeout: 10000,
                    success: function (data) {
                        console.log(data)
                        if (data.ErrCode == 0) {
                            
                            report_bandwidth_usage.select_proxy.html('');
                            report_bandwidth_usage.select_interface.html('');
                            
                            report_bandwidth_usage.proxy_list = {};
                            var selected_proxy_id = null;
                            for (var i = 0; i < data.Result.length; i++) {
                                var proxyId = data.Result[i].ProxyID;
                                if (!(proxyId in report_bandwidth_usage.proxy_list)) {
                                    var selected = '';
                                    if (i == 0) {
                                        selected = 'selected';
                                        selected_proxy_id = proxyId;
                                    }
                                    report_bandwidth_usage.select_proxy.append('<option value="' + proxyId + '" ' + selected + '>' + data.Result[i].ProxyName + '</option>');
                                    report_bandwidth_usage.proxy_list[proxyId] = [];
                                }
                                var interface = data.Result[i].Interface;
                                var option_interface = '<option value="' + interface + '">' + interface + '</option>';
                                report_bandwidth_usage.proxy_list[proxyId].push(option_interface);
                                if (proxyId == selected_proxy_id) {
                                    report_bandwidth_usage.select_interface.append(option_interface);
                                }
                            }
                            report_bandwidth_usage.select_proxy.change(function () {
                                var proxyId = $(this).val();
                                report_bandwidth_usage.select_interface.html('');
                                $.each(report_bandwidth_usage.proxy_list[proxyId], function (key, val) {
                                    report_bandwidth_usage.select_interface.append(val);
                                })
                            });
                        }
                        else alert(data.ErrText);
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            ).done(function () {
                report_bandwidth_usage.onList();
            });
        },
        units: { "bps": 1, "kbps": 1000, "Mbps": 1000 * 1000, "Gbps": 1000 * 1000 * 1000 },
        onList: function () {
            var proxyId = parseInt(report_bandwidth_usage.select_proxy.val());
            var interface = report_bandwidth_usage.select_interface.val();
            msg.Send({
                type: "POST",
                url: "/api/proxyStats/bandwidth",
                dataType: "json",
                data: { proxyId: proxyId, interface: interface, from: $.trim($('#txt_search_bandwidth_from').val()), to: $.trim($('#txt_search_bandwidth_to').val()) },
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var labels = [];
                        var datasets = [];
                        var group = [];
                        var unit = "bps";
                        var lowest = 0;
                        $.each(data.Result, function (i, val) {
                            var label_name = "RX";
                            if (val.Type == 1) {
                                label_name = "TX";
                            }
                            if (!group.includes(label_name)) {
                                group.push(label_name)
                            }
                            var bwidth = parseFloat(val.Value) * 8
                            if (lowest == 0 || bwidth < lowest) {
                                lowest = bwidth;
                            }
                        })
                        
                        if (lowest >= report_bandwidth_usage.units["bps"] && lowest < report_bandwidth_usage.units["kbps"]) {
                            unit = "bps";
                        } else if (lowest >= report_bandwidth_usage.units["kbps"] && lowest < report_bandwidth_usage.units["Mbps"]) {
                            unit = "kbps";
                        } else if (lowest >= report_bandwidth_usage.units["Mbps"] && lowest < report_bandwidth_usage.units["Gbps"]) {
                            unit = "Mbps";
                        } else if (lowest >= report_bandwidth_usage.units["Gbps"]) {
                            unit = "Gbps";
                        }
                        
                        var colors = Utils.Colors.Pick(group.length);
                        var proxy_count = group.length;
                        group = [];
                        var last_min = -1;
                        var last_min_proxy_count;
                        $.each(data.Result, function (i, val) {
                            var label_name = "RX";
                            if (val.Type == 1) {
                                label_name = "TX";
                            }
                            
                            if (last_min == -1 || last_min == val.Minute) {
                                last_min_proxy_count++;
                            } else {
                                if (last_min_proxy_count < proxy_count) {
                                    var diff = proxy_count - last_min_proxy_count; var missing_record = [];
                                    var total_record = 0;
                                    if (diff > 0) {
                                        $.each(datasets, function (i, v) {
                                            if (total_record == 0) {
                                                total_record = v.data.length;
                                            } else if (total_record < v.data.length) {
                                                total_record = v.data.length;
                                                missing_record.push(i - 1);
                                            } else if (total_record > v.data.length) {
                                                missing_record.push(i);
                                            }
                                        })
                                        $.each(missing_record, function (i, v) {
                                            var len = datasets[v].data.length
                                            datasets[v].data.push(datasets[v].data[len - 1]);
                                        })
                                    }
                                }
                                last_min_proxy_count = 0;
                            }
                            last_min = val.Minute;
                            
                            var hour = ('0' + String(val.Hour)).slice(-2);
                            var minute = ('0' + String(val.Minute)).slice(-2);
                            var label = Utils.Datetime.Date(val.Date) + " " + hour + ":" + minute;
                            if (!labels.includes(label)) {
                                labels.push(label);
                            }
                            if (!group.includes(label_name)) {
                                group.push(label_name);
                                datasets.push({ data: [], borderColor: "", backgroundColor: "", label: label_name, fill: false });
                            }
                            var pos = group.indexOf(label_name);
                            datasets[pos].data.push(parseFloat(val.Value).toFixed(2));
                            datasets[pos].borderColor = colors[pos];
                            datasets[pos].backgroundColor = colors[pos];
                        })
                        labels.sort();
                        datasets.sort(function (a, b) {
                            if (a.label < b.label) return -1;
                            if (a.label > b.label) return 1;
                            return 0;
                        });
                        report_bandwidth_usage.newChart(document.getElementById("bandwidth-chart"), labels, interface, datasets, unit);
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        chart: null,
        newChart: function (container, labels, title, datasets, unit) {
            if (this.chart == null) {
                this.chart = new Chart(container, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets,
                        unit: unit,
                    },
                    options: {
                        title: {
                            display: true,
                            text: title,
                            fontSize: 18,
                        },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    callback: function (value, index, values) {
                                        if (report_bandwidth_usage.chart != null) {
                                            unit = report_bandwidth_usage.chart.data.unit;
                                        }
                                        return (value * 8 / report_bandwidth_usage.units[unit]).toFixed(2) + " " + unit;
                                    }
                                }
                            }]
                        },
                        tooltips: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (tooltipItem, data) {
                                    var label = data.datasets[tooltipItem.datasetIndex].label;
                                    var bytes = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                    if (report_bandwidth_usage.chart != null) {
                                        unit = report_bandwidth_usage.chart.data.unit;
                                    }
                                    return label + ": " + (bytes * 8 / report_bandwidth_usage.units[unit]).toFixed(2) + " " + unit;
                                }
                            }
                        }
                    }
                });
            } else {
                this.chart.options.title.text = title;
                this.chart.data.labels = labels;
                this.chart.data.datasets = datasets;
                this.chart.data.unit = unit;
                this.chart.update();
            }
        }
    }
</script>


<script>
    $(document).ready(function () {
        domain_edit.onAdd();
        $('#btn-domain_back').click(function () {
            showPage('account');
        })
    })
    var domain_edit = {
        backendList: $('<select class="txt_domain_edit_backends"></select>'),
        onPrelistBackend: function (site_id) {
            msg.Send({
                type: "POST",
                url: "/api/backend/listSiteAddr",
                dataType: "json",
                data: { siteID: site_id },
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        if (data.Result.length == 0) {
                            domain_edit.backendList = "";
                            return;
                        }
                        domain_edit.backendList = $('<select class="txt_domain_edit_backends"></select>');
                        $.each(data.Result, function (i, val) {
                            domain_edit.backendList.append($('<option value="' + val.ID + '">' + val.Name + '</option>'));
                        })
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        site: null,
        onOpenLink: function (elem) {
            elem.find('.clickable-url').each(function () {
                domain_edit.enableOpenLink($(this));
            })
        },
        enableOpenLink: function (elem) {
            elem.unbind('click').click(function () {
                var url = $.trim($(this).val());
                if (url == "") {
                    url = $.trim($(this).html());
                }
                if (url.length > 0) {
                    window.open("http://" + url, '_blank');
                }
            }).toggleClass('clickable-url', true);
        },
        disableOpenLink: function (elem) {
            elem.unbind('click').toggleClass('clickable-url', false);;
        },
        OpenWithBackend: function (elem) {
            elem.find('.txt_domain_edit_open').click(function () {
                var domain = elem.find('.txt-domain-name')
                var url = $.trim(domain.val());
                if (url == "") {
                    url = $.trim(domain.html());
                }
                if (url.length > 0) {
                    var backend_id = parseInt($(this).siblings('.txt_domain_edit_backends').val());
                    if (isNaN(backend_id)) {
                        return
                    }
                    msg.Send({
                        type: "POST",
                        url: "/api/domainEdit/token",
                        dataType: "json",
                        data: { backend_id: backend_id },
                        timeout: 10000,
                        success: function (data) {
                            if (data.ErrCode == 0) {
                                window.open("http://" + url + "?bpx-backend-id=" + data.Result, '_blank');
                            }
                            else alert(data.ErrText);
                        },
                        error: function (xhr, status, error) {
                            alert(error);
                            if (xhr.status == 401) {
                                location.href = "/";
                            }
                        }
                    })
                }
            })
        },
        OnList: function (siteId, siteName) {
            this.site = parseInt(siteId);
            domain_edit.onPrelistBackend(this.site);
            $('#title-domain_edit').html(siteName);
            showPage('domain_edit');
            msg.Send({
                type: "POST",
                url: "/api/domainEdit/list",
                dataType: "json",
                data: { siteId: this.site },
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        var table = [];
                        if (domain_edit.backendList == "") {
                            $('#col_backend').hide();
                        } else {
                            $('#col_backend').show();
                        }
                        $.each(data.Result, function (i, val) {
                            var LastUpdateLabel = '';
                            
                            color = Utils.Colors.Grey;
                            if (val.LastUpdate != null) {
                                var time_difference = Utils.Datetime.Difference(val.LastUpdate, val.ServerTime)
                                if (time_difference <= 60 * 5) {
                                    color = Utils.Colors.LightGreen;
                                } else if (time_difference <= 3600) {
                                    color = Utils.Colors.DeepGreen;
                                } else if (time_difference <= 3600 * 24) {
                                    color = Utils.Colors.LightBlue;
                                } else if (time_difference > 3600 * 24) {
                                    color = Utils.Colors.DeepBlue;
                                }
                                LastUpdateLabel = 'title="Last active ' + Utils.Datetime.LastActiveB(val.LastUpdate, val.ServerTime) + '"';
                            } else {
                                LastUpdateLabel = 'title="Never active"';
                            }

                            var www_domain = '<span class="txt-www-domain clickable-url"></span>';
                            var www_enabled = '<input class="chk-enable-www-domain" type="checkbox" disabled>';
                            var www_status = '';
                            if (val.EnableWWW > -1) {
                                www_enabled = '<input class="chk-enable-www-domain" type="checkbox" style="display:none" disabled checked>';
                                www_domain = '<span class="txt-www-domain clickable-url">www.' + val.Domain + '</span>';
                                if (val.EnableWWW == 2) {
                                    www_status = '<i class="fa fa-times www-status" style="color:red" title="DNS verification failed">';
                                }
                            }
                            var root_domain = '<td class="col_status"><i style="color:' + color + '" class="dboard-status material-icons" ' + LastUpdateLabel + '>fiber_manual_record</i></td>' + '<td style="width:20%"><input class="txt-domain-name clickable-url" type="text" value="' + val.Domain + '" readonly="readonly" placeholder="hostname" /></td>';
                            var dns_verification = '<td></td>';
                            
                            if (val.RootValid == 3) {
                                dns_verification = '<td><i class="fa fa-minus" title="No DNS verification for IP address"></td>';
                            } else if (val.RootValid == 2) {
                                dns_verification = '<td><i class="fa fa-times" style="color:red" title="DNS verification failed"></td>';
                                www_status = '';
                            } else if (val.RootValid == 0) {
                                dns_verification = '<td><i class="fa fa-ellipsis-h" title="Pending DNS verification"></td>';
                            } else if (val.RootValid == 1) {
                                dns_verification = '<td><i class="fa fa-check" title="Last verified ' + Utils.Datetime.RemoveTZ(val.LastChecked) + '"></td>';
                            }
                            var backend = '';
                            if (domain_edit.backendList != "") {
                                backend = '<td>' + domain_edit.backendList.clone().outerHTML() + '<i class="fa fa fa-external-link txt_domain_edit_open clickable" style="margin-left:7px;font-size:20px" title="open in new window"></i></td>';
                            }
                            force_https_checked = val.HTTPS == 1 ? 'checked' : '';
                            force_https = '<td><input class="chk-force-https" type="checkbox" disabled ' + force_https_checked + '></td>';
                            
                            var www = '<td>' + www_enabled + www_domain + www_status + '</td>';
                            
                            var action = '<td><i class="btn-domain-cancel fas fa-times clickable" style="display:none" title="cancel"></i>' +
                                '<i class="btn-domain-save fas fa-save clickable" style="display:none" title="save"></i>' +
                                '<i class="btn-domain-edit fas fa-cog clickable" title="edit"></i>' +
                                '<i class="btn-domain-del fas fa-trash-alt clickable" title="delete">' +
                                '</i></td>';
                            
                            var $row = $(createRow({ 'id': val.ID }, action, root_domain, dns_verification, force_https, www, backend));
                            domain_edit.onEdit($row);
                            domain_edit.onCancel($row);
                            domain_edit.onDelete($row);
                            domain_edit.onSave($row);
                            domain_edit.onOpenLink($row);
                            domain_edit.OpenWithBackend($row);
                            table.push($row);
                        })
                        $('#tbody-domain_edit').html(table);
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        onAdd: function () {
            $('#container-domain_edit #btn-add_domain_edit').unbind('click').click(function () {
                var root_status = '<td><i style="color:' + Utils.Colors.Grey + '" class="dboard-status material-icons" title="Never active">fiber_manual_record</i></td>';
                var root_domain = '<td><input class="txt-domain-name" type="text" value="" placeholder="hostname" /></td>';
                var dns_verification = '<td><i class="fa fa-ellipsis-h" title="Pending DNS verification"></td>';
                var force_https = '<td><input class="chk-force-https" type="checkbox"></td>';
                var www_domain = '<span class="txt-www-domain"></span>';
                var backend = '';
                if (domain_edit.backendList != "") {
                    backend = '<td>' + domain_edit.backendList.clone().hide().outerHTML() + '<i class="fa fa fa-external-link txt_domain_edit_open clickable" style="margin-left:7px;font-size:20px;display:none" title="open in new window"></i></td>';
                }
                var www_enabled = '<input class="chk-enable-www-domain" type="checkbox" checked="checked">';
                var www = '<td>' + www_enabled + www_domain + '</td>';
                
                var action = '<td><i class="btn-domain-cancel fas fa-times clickable" title="cancel"></i>' +
                    '<i class="btn-domain-save fas fa-save clickable" title="save"></i>' +
                    '<i class="btn-domain-edit fas fa-cog clickable" style="display:none" title="edit"></i>' +
                    '<i class="btn-domain-del fas fa-trash-alt clickable" title="delete">' +
                    '</i></td>';
                
                
                
                var $row = $(createRow(null, action, root_status, root_domain, dns_verification, force_https, www, backend));
                
                domain_edit.onEdit($row);
                domain_edit.onDelete($row);
                domain_edit.onCancel($row);
                domain_edit.onSave($row);
                domain_edit.checkWWW($row);
                domain_edit.onOpenLink($row);
                domain_edit.OpenWithBackend($row);
                
                $('#tbody-domain_edit').prepend($row);
            })
        },
        onSave: function (elem) {
            elem.find('.btn-domain-save').click(function () {
                
                var domain = elem.find('.txt-domain-name').val();
                domain = $.trim(domain);
                if (domain.length == 0) {
                    alert("domain cannot be empty");
                    return;
                }

                var force_https_chk = elem.find(".chk-force-https").prop('checked');
                var enable_force_https = force_https_chk == true ? 1 : 0;

                var enableWwwChk = elem.find(".chk-enable-www-domain").prop('checked');
                var enableWww = enableWwwChk == true ? 0 : -1;

                if (domain.startsWith('www.')) {
                    enableWww = -1;
                    elem.find('.chk-enable-www-domain').prop('checked', false);
                    elem.find('.txt_www_enabled').html('disabled');
                }

                
                var action = "edit";
                var input = { domain: domain, https: enable_force_https, enablewww: enableWww };
                var id = elem.attr('data-id');
                if (typeof (id) == 'undefined') {
                    action = "add";
                    input.siteId = domain_edit.site;
                } else {
                    action = "edit";
                    var id = parseInt(id);
                    input.id = id;
                }

                msg.Send({
                    type: "POST",
                    url: "/api/domainEdit/" + action,
                    dataType: "json",
                    timeout: 10000,
                    data: input,
                    success: function (data) {
                        var domain = elem.find('.txt-domain-name');
                        if (domain.val() != domain.attr('data-val')) {
                            if (Utils.String.IsIPv4(domain.val())) {
                                elem.find('.domain-dns-status').css('color', Utils.Colors.Grey).attr('title', 'No DNS verification for IP Address').show();
                            } else {
                                elem.find('.domain-dns-status').css('color', Utils.Colors.Orange).attr('title', 'DNS Record pending verification').show();
                            }
                        }
                        domain.attr('readonly', true).removeAttr('data-val');
                        domain_edit.enableOpenLink(domain);

                        var domain_www = elem.find('.txt-www-domain');
                        domain_www.attr('readonly', true).removeAttr('data-val');
                        domain_edit.enableOpenLink(domain_www);

                        elem.find('.chk-force-https').attr('disabled', true).toggleClass('clickable-url', true);

                        var chk_enable_www_domain = elem.find('.chk-enable-www-domain');

                        elem.find('.www-status').html('');

                        elem.find('.txt_domain_edit_backends').show();
                        elem.find('.txt_domain_edit_open').show();
                        
                        var www_domain = elem.find('.txt-www-domain');
                        chk_enable_www_domain.attr('disabled', 'disabled');
                        if (enableWww == -1) {
                            www_domain.html('');
                            chk_enable_www_domain.show();
                        } else if (chk_enable_www_domain.val() != chk_enable_www_domain.attr('data-val')) {
                            chk_enable_www_domain.hide();
                        }
                        www_domain.removeAttr('data-val');
                        chk_enable_www_domain.removeAttr('data-val');
                        elem.find('.btn-domain-save').hide();
                        elem.find('.btn-domain-edit').show();
                        elem.find('.btn-domain-cancel').hide();
                        elem.attr('data-id', data.Result);
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
        onEdit: function (elem) {
            elem.find('.btn-domain-edit').click(function () {
                elem.find('.btn-domain-cancel').show();
                elem.find('.btn-domain-save').show();
                elem.find('.btn-domain-edit').hide();

                elem.find('.www-status').hide();

                elem.find('.txt_domain_edit_backends').hide();
                elem.find('.txt_domain_edit_open').hide();

                var domain_name = elem.find('.txt-domain-name')
                domain_name.prop('readonly', false).attr('data-val', domain_name.val());
                domain_edit.disableOpenLink(domain_name);

                var www_domain_name = elem.find('.txt-www-domain')
                www_domain_name.attr('data-val', www_domain_name.html()).toggleClass('clickable-url', false);
                domain_edit.disableOpenLink(www_domain_name);

                var chk_force_https = elem.find('.chk-force-https')
                var force_https_checked = chk_force_https.prop('checked');
                chk_force_https.attr('data-val', force_https_checked);
                chk_force_https.removeAttr("disabled")

                var chk_enable_www_domain = elem.find('.chk-enable-www-domain')
                var www_checked = chk_enable_www_domain.prop('checked');
                chk_enable_www_domain.attr('data-val', www_checked);
                chk_enable_www_domain.closest('td').find('.icon').hide();
                chk_enable_www_domain.removeAttr("disabled").show();

                domain_edit.checkWWW(elem)
            })
        },
        onCancel: function (elem) {
            elem.find('.btn-domain-cancel').click(function () {
                
                if (elem.attr('data-id') == null) {
                    elem.remove();
                    return;
                }
                
                elem.find('.txt_domain_edit_backends').show();
                elem.find('.txt_domain_edit_open').show();

                elem.find('.www-status').show();

                var domain_name = elem.find('.txt-domain-name')
                domain_name.prop('readonly', true).val(domain_name.attr('data-val')).removeAttr('data-val');
                domain_edit.enableOpenLink(domain_name);

                var www_domain_name = elem.find('.txt-www-domain')
                www_domain_name.html(www_domain_name.attr('data-val')).removeAttr('data-val').toggleClass('clickable-url', true);
                domain_edit.enableOpenLink(www_domain_name);

                var enableWWW = elem.find('.chk-enable-www-domain');
                if (enableWWW.attr('data-val') == "true") {
                    enableWWW.prop('checked', true);
                } else {
                    enableWWW.prop('checked', false);
                }
                enableWWW.removeAttr('data-val').hide();

                var force_https = elem.find('.chk-force-https');
                if (force_https.attr('data-val') == "true") {
                    force_https.prop('checked', true);
                } else {
                    force_https.prop('checked', false);
                }
                force_https.attr('disabled', true);

                elem.find('.btn-domain-cancel').hide();
                elem.find('.btn-domain-save').hide();
                elem.find('.btn-domain-edit').show();
                enableWWW.closest('td').find('.icon').show();
            })
        },
        onDelete: function (elem) {
            elem.find('.btn-domain-del').unbind('click').click(function () {
                var id = elem.attr('data-id');
                if (typeof (id) == 'undefined') {
                    elem.remove();
                    return;
                }
                var domain = elem.find('.txt-domain-name').val();
                var confirmed = confirm("delete " + domain + "?");
                if (confirmed == false) {
                    return;
                }
                var id = parseInt(id);
                msg.Send({
                    type: "POST",
                    url: "/api/domainEdit/delete",
                    dataType: "json",
                    timeout: 10000,
                    data: { id: id },
                    success: function (data) {
                        elem.remove();
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                        if (xhr.status == 401) {
                            location.href = "/";
                        }
                    }
                })
            })
        },
        checkWWW: function (elem) {
            elem.find('.chk-enable-www-domain').on('change', function () {
                domain_edit.correctWWW(elem)
            })
            elem.find('.txt-domain-name').on('keyup', function (e) {
                domain_edit.correctWWW(elem);
            });
        },
        correctWWW: function (elem) {
            var domainElem = elem.find('.txt-domain-name')
            var checkBox = elem.find('.chk-enable-www-domain');
            var txtWWWDomain = elem.find('.txt-www-domain');
            var domain = $.trim(domainElem.val());
            if (domain.startsWith("www.") || Utils.String.IsIPv4(domain)) {
                checkBox.prop('disabled', true).prop('checked', false);
            } else {
                checkBox.prop('disabled', false);
            }
            if (checkBox.prop('checked') == true) {
                txtWWWDomain.html('www.' + domain);
            } else {
                txtWWWDomain.html('');
            }
        },
    }
</script>


<script>
    $(document).ready(function () {
        $('#btn-menu_admin-setting').click(function () {
            menuClick($(this));
            admin_setting.onList();
        })
    })

    var admin_setting = {
        template: function (id, data) {
            var display_name = data.Name.replace(/_/g, " ");
            var row = $('<div class="row section" data-id="' + id + '"></div>');
            var title = $('<div class="col-lg-12 pt-3 pb-2"><h2 style="text-transform:capitalize" id="title-admin_setting-' + data.Name + '">' + display_name + '</h2></div>');
            var subtitle_text = "";
            var form = $('<div class="col-lg-12 setting-section"><form></form></div>');
            
            var form_row = $('<div class="form-group row"></div>');
            var label = $('<label for="txt-' + data.Name + '-enable" class="col-sm-2 col-form-label">Enable</label>');
            if (data.Enabled) {
                var txt = $('<div class="col-sm-10"><input type="checkbox" class="form-check-input-custom chk-setting-enable" id="txt-' + data.Name + '-enable" checked="checked"></div>');
            } else {
                var txt = $('<div class="col-sm-10"><input type="checkbox" class="form-check-input-custom chk-setting-enable" id="txt-' + data.Name + '-enable"></div>');
            }
            form_row.append(label);
            form_row.append(txt);
            form.prepend(form_row);
            admin_setting.onEnable(txt.find('#txt-' + data.Name + '-enable'));
            
            $.each(data.Sub, function (i, val) {
                subtitle_text = val.Subtitle;
                val.SubName = val.SubName.replace(/_/g, " ");
                var form_row = $('<div class="form-group row"></div>');
                var label = $('<label for="txt-' + data.Name + '-' + val.SubName + '" class="col-sm-2 col-form-label">' + val.SubDisplayName + '</label>');
                var disabled = "";
                if (!data.Enabled) {
                    disabled = 'disabled="disabled"';
                }
                var txt = $('<div class="col-sm-10"><input type="text" class="form-control form-setting-input" id="txt-' + data.Name + '-' + val.SubName + '" data-id="' + val.SubID + '" value="' + val.SubValue + '" placeholder="' + val.Placeholder + '" ' + disabled + '></div>');
                form_row.append(label);
                form_row.append(txt);
                form.append(form_row);
            });
            
            var subtitle = $('<div class="col-lg-12 pt-3 pb-2 sub-title"><span id="sub_title-admin_setting-' + data.Name + '">' + subtitle_text + '</span></div>');
            
            var save = $('<div class="form-group row"></div>');
            var btn_save_container = $('<div class="col-sm-10 offset-sm-2"></div>');
            var btn_save = $('<button id="btn-save-' + data.Name + '" type="button" class="btn btn-primary">Save</button>');
            btn_save_container.append(btn_save);
            save.append(btn_save_container);
            form.append(save);
            row.append(title);
            row.append(subtitle);
            row.append(form);

            
            btn_save.click(function () {
                admin_setting.onSave($(this).closest('.section'));
            })
            return row;
        },
        onEnable: function (target) {
            target.click(function () {
                var isChecked = target.is(':checked');
                target.closest('.setting-section').find('.form-setting-input').prop('disabled', !isChecked)
                target.prop('checked', isChecked);
            })
        },
        onList: function () {
            msg.Send({
                type: "POST",
                url: "/api/adminSetting/List",
                dataType: "json",
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        $('#container-admin-setting').html('');
                        var section_data = {};
                        $.each(data.Result, function (i, val) {
                            if (!(val.ID in section_data)) {
                                section_data[val.ID] = {};
                                section_data[val.ID].Name = val.Name;
                                section_data[val.ID].Enabled = val.Enabled;
                                section_data[val.ID].Sub = [];
                            }
                            section_data[val.ID].Sub.push(val);
                        })
                        $.each(section_data, function (key, val) {
                            var section = admin_setting.template(key, val);
                            $('#container-admin-setting').append(section);
                        });
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        },
        onSave: function (elem) {
            data = {};
            var sub_setting = [];
            elem.find('input[type="text"]').each(function () {
                sub_setting.push({ subId: parseInt($(this).attr('data-id')), value: $.trim($(this).val()) });
            })
            data.SubSetting = sub_setting;
            data.ID = parseInt(elem.attr('data-id'));
            data.Enabled = elem.find('.chk-setting-enable').is(':checked')
            msg.Send({
                type: "POST",
                url: "/api/adminSetting/Edit",
                dataType: "json",
                data: data,
                timeout: 10000,
                success: function (data) {
                    if (data.ErrCode == 0) {
                        alert("setting saved");
                    }
                    else alert(data.ErrText);
                },
                error: function (xhr, status, error) {
                    alert(error);
                    if (xhr.status == 401) {
                        location.href = "/";
                    }
                }
            })
        }
    }
</script>



</body>

</html>